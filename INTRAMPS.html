<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema MPS Advogados - Gestão Completa</title>
    <link rel="icon" href="/icoguardian2.png">
    
    <!-- Meta tags -->
    <meta property="og:title" content="Medeiros, Paiva & Soreas - MPS Advocacia">
    <meta property="og:description" content="Escritório de advocacia no Mato Grosso. Atuação estratégica em diversas áreas do Direito com ética, experiência e resultados.">
    <meta property="og:image" content="/ico.ico">
    <meta property="og:url" content="https://mpsadv.com.br">

    <!-- Meta tags para o iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="LEXGUARDIAN | MPS">
    <link rel="apple-touch-icon" href="/icoguardian2.png">

    <!-- Fontes e ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.cdnfonts.com/css/neue-haas-grotesk-display-pro" rel="stylesheet">
    
    <!-- FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/pt-br.js"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Supabase -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root{
            --primary-dark:#001A1A; --primary-medium:#002B2B; --primary-light:#004D4D;
            --accent:#C9A769; --accent-light:#D4B989; --text-light:#f8f8f8; --text-dark:#1A1A1A;
            --text-medium:#5A5A5A; --white:#ffffff; --gray-light:#f5f5f5; --transition: all .4s cubic-bezier(.23,1,.32,1);
            --success:#28a745; --warning:#ffc107; --danger:#dc3545; --info:#17a2b8;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 30px rgba(0,0,0,0.12);
        }
        body{ 
            font-family:'Neue Haas Grotesk Display Pro', 'Inter', sans-serif; 
            background:var(--white); 
            color:var(--text-dark);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* Layout principal */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header{ 
            background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary-medium) 50%,var(--primary-light) 100%); 
            padding:1rem 1.5rem; 
            color:var(--text-light);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content{ 
            max-width:1200px; 
            margin:0 auto; 
            display:flex; 
            justify-content:space-between; 
            align-items:center;
        }
        .logo{ 
            font-family:'Playfair Display', serif; 
            font-size:1.4rem; 
            letter-spacing:1px; 
            text-transform:uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-icon {
            background: var(--accent);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-info{ 
            display:flex; 
            gap:1rem; 
            align-items:center;
        }
        .logout-btn{ 
            background:transparent; 
            border:1px solid var(--accent); 
            color:var(--accent); 
            padding:.5rem 1.2rem; 
            border-radius:6px; 
            cursor:pointer;
            font-weight: 500;
            transition: var(--transition);
        }
        .logout-btn:hover {
            background: rgba(201, 167, 105, 0.1);
        }

        .main-container{ 
            max-width:1200px; 
            margin:0 auto; 
            padding:1.5rem; 
            flex: 1;
            width: 100%;
        }
        
        /* Página de Login */
        .login-container{ 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            min-height:100vh;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-medium) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(201, 167, 105, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(0, 77, 77, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 43, 43, 0.1) 0%, transparent 50%);
            background-size: 400px 400px, 300px 300px, 500px 500px;
            background-position: 0 0, 100px 100px, 200px 200px;
            animation: backgroundShift 20s infinite linear;
        }
        
        @keyframes backgroundShift {
            0% { background-position: 0 0, 100px 100px, 200px 200px; }
            100% { background-position: 400px 400px, 500px 500px, 600px 600px; }
        }
        
        .login-card{ 
            background: var(--white);
            padding:2.5rem; 
            border-radius:var(--border-radius); 
            box-shadow:var(--shadow-hover);
            max-width:450px;
            width: 90%;
            z-index: 1;
            position: relative;
        }
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-header h2 {
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .login-header p {
            color: var(--text-medium);
            font-size: 0.95rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }
        .form-control{ 
            width:100%; 
            padding:1rem; 
            border-radius:8px; 
            border:1px solid rgba(0,0,0,.12);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(201, 167, 105, 0.2);
        }
        .btn{ 
            background:var(--accent); 
            color:var(--primary-dark); 
            padding:1rem 1.6rem; 
            border:none; 
            border-radius:8px; 
            cursor:pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        .btn-full {
            width: 100%;
        }
        .btn-secondary {
            background: transparent;
            border: 1px solid var(--primary-dark);
            color: var(--primary-dark);
        }
        .btn-secondary:hover {
            background: rgba(0,0,0,0.05);
        }
        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
        }

        /* Tabelas e abas */
        .tabs{ 
            display:flex; 
            gap:0.5rem; 
            margin-bottom:1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            overflow-x: auto;
            padding-bottom: 0;
            scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar {
            display: none;
        }
        .tab{ 
            padding:1rem 1.2rem; 
            cursor:pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-weight: 500;
        }
        .tab.active{ 
            border-bottom:2px solid var(--accent);
            color: var(--primary-dark);
        }
        .tab-content{ display:none }
        .tab-content.active{ display:block }

        table{ 
            width:100%; 
            border-collapse:collapse;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        th, td{ 
            padding:1rem; 
            text-align:left;
        }
        thead{ 
            background:var(--primary-dark); 
            color:var(--text-light);
        }
        tbody tr {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: var(--transition);
        }
        tbody tr:hover {
            background: rgba(0,0,0,0.02);
        }

        /* Modal base */
        .modal{ 
            display:none; 
            position:fixed; 
            inset:0; 
            background:rgba(0,0,0,.45); 
            z-index:1000; 
            align-items:center; 
            justify-content:center;
            padding: 1rem;
        }
        .modal.active{ 
            display:flex;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content{ 
            background:var(--white); 
            width:90%; 
            max-width:900px; 
            border-radius:var(--border-radius); 
            padding:1.6rem; 
            max-height:90vh; 
            overflow:auto;
            box-shadow: var(--shadow-hover);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header{ 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            margin-bottom:1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .modal-close{ 
            background:none; 
            border:none; 
            font-size:1.6rem; 
            cursor:pointer;
            color: var(--text-medium);
            transition: var(--transition);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text-dark);
        }

        /* Timeline */
        .timeline{ 
            border-left:3px solid var(--accent); 
            padding-left:18px; 
            margin-top:8px;
        }
        .timeline-item{ 
            margin-bottom:18px; 
            position:relative;
            padding: 1rem;
            background: var(--gray-light);
            border-radius: 8px;
        }
        .timeline-item::before{ 
            content:""; 
            width:12px; 
            height:12px; 
            background:var(--accent); 
            border-radius:50%; 
            position:absolute; 
            left:-30px; 
            top:20px;
        }
        .timeline-date{ 
            display:block; 
            font-size:0.9rem; 
            color:var(--text-medium); 
            margin-bottom:4px;
            font-weight: 500;
        }

        /* Tabs dentro do modal */
        .modal-tabs { 
            display: flex; 
            border-bottom: 1px solid #e0e0e0; 
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        .modal-tab { 
            padding:0.75rem 1.5rem; 
            cursor: pointer; 
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: var(--transition);
        }
        .modal-tab.active { 
            border-bottom: 2px solid var(--accent); 
            color: var(--primary-dark); 
            font-weight: 500;
        }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pendente { background-color: #FFF3CD; color: #856404; }
        .status-andamento { background-color: #D1ECF1; color: #0C5460; }
        .status-concluido { background-color: #D4EDDA; color: #155724; }
        .status-arquivado { background-color: #E2E3E5; color: #383D41; }

        /* Financial badges */
        .financial-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .financial-receita { background-color: #D4EDDA; color: #155724; }
        .financial-despesa { background-color: #F8D7DA; color: #721C24; }
        .financial-pendente { background-color: #FFF3CD; color: #856404; }
        .financial-pago { background-color: #D1ECF1; color: #0C5460; }

        /* Priority badges */
        .priority-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .priority-baixa { background-color: #D1ECF1; color: #0C5460; }
        .priority-media { background-color: #FFF3CD; color: #856404; }
        .priority-alta { background-color: #F8D7DA; color: #721C24; }
        .priority-urgente { background-color: #721C24; color: white; }

        /* Alertas */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background-color: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        
        .alert-error {
            background-color: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }

        .alert-warning {
            background-color: #FFF3CD;
            color: #856404;
            border: 1px solid #FFEEBA;
        }

        .alert-info {
            background-color: #D1ECF1;
            color: #0C5460;
            border: 1px solid #BEE5EB;
        }

        /* Botões de ação */
        .action-btn {
            background: none;
            border: none;
            color: var(--primary-dark);
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.8rem;
            transition: var(--transition);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn:hover {
            background: rgba(0,0,0,0.05);
            color: var(--accent);
        }
        
        .btn-danger {
            color: #dc3545;
        }
        
        .btn-danger:hover {
            color: #c82333;
            background: rgba(220, 53, 69, 0.1);
        }

        /* Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
            border-left: 4px solid var(--accent);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-dark);
        }
        
        .stat-label {
            color: var(--text-medium);
            font-size: 0.9rem;
        }

        /* Notificações */
        .notifications {
            position: relative;
        }
        
        .notification-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
            position: relative;
            padding: 0.5rem;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .notification-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .notification-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 350px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-dropdown.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .notification-item.unread {
            background: #f8f9fa;
        }
        
        .notification-item:hover {
            background: #f0f0f0;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .notification-message {
            font-size: 0.9rem;
            color: var(--text-medium);
        }
        
        .notification-time {
            font-size: 0.8rem;
            color: var(--text-medium);
            margin-top: 0.25rem;
        }

        /* Gráficos */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .chart-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .chart-card h4 {
            margin-bottom: 1rem;
            text-align: center;
            color: var(--primary-dark);
        }
        
        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            color: var(--text-medium);
        }

        /* Busca Avançada */
        .advanced-search {
            background: var(--gray-light);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }
        
        .advanced-search-toggle {
            background: none;
            border: none;
            color: var(--primary-dark);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: var(--transition);
        }
        
        .advanced-search-toggle:hover {
            background: rgba(0,0,0,0.05);
        }

        /* Loading */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Backup Section */
        .backup-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--gray-light);
            border-radius: var(--border-radius);
        }

        /* Dashboard Header */
        .dashboard-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .dashboard-header h1 {
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .dashboard-header p {
            color: var(--text-medium);
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        /* Table Container */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        /* Calendário */
        .calendar-container {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }
        
        /* Cards de prazos */
        .prazos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .prazo-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--accent);
            transition: var(--transition);
            position: relative;
        }
        
        .prazo-card.urgente {
            border-left-color: var(--danger);
        }
        
        .prazo-card.alta {
            border-left-color: #ffc107;
        }
        
        .prazo-card.media {
            border-left-color: #17a2b8;
        }
        
        .prazo-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .prazo-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1rem;
        }
        
        .prazo-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        
        .prazo-desc {
            color: var(--text-medium);
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }
        
        .prazo-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-medium);
        }

        /* Mobile Menu */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Indicador de prazo vencido */
        .prazo-vencido {
            border-left-color: var(--danger) !important;
            background: rgba(220, 53, 69, 0.05);
        }

        /* Botões de template de prazos */
        .template-buttons {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
        }

        .template-btn {
            background: var(--primary-light);
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
        }

        .template-btn:hover {
            background: var(--primary-dark);
        }

        /* Filtros de prazos */
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        /* ========== KANBAN STYLES ========== */
        .kanban-container {
            margin: 1.5rem 0;
            overflow-x: auto;
            padding-bottom: 1rem;
        }

        .kanban-board {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 1.5rem;
            min-width: 1200px;
        }

        .kanban-column {
            background: var(--white);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            height: 700px;
        }

        .kanban-column-header {
            padding: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-column-header h3 {
            font-size: 1rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .kanban-count {
            background: var(--primary-dark);
            color: white;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .kanban-column-content {
            flex: 1;
            overflow-y: auto;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .kanban-column-footer {
            padding: 1rem;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        /* Kanban Card */
        .kanban-card {
            background: var(--white);
            border-radius: 8px;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            border-left: 4px solid var(--accent);
            cursor: move;
            transition: var(--transition);
            user-select: none;
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }

        .kanban-card.urgente {
            border-left-color: var(--danger);
            background: rgba(220, 53, 69, 0.05);
        }

        .kanban-card.alta {
            border-left-color: #ff6b6b;
            background: rgba(255, 107, 107, 0.05);
        }

        .kanban-card.media {
            border-left-color: #ffd93d;
            background: rgba(255, 217, 61, 0.05);
        }

        .kanban-card.baixa {
            border-left-color: #6bcf7f;
            background: rgba(107, 207, 127, 0.05);
        }

        .kanban-card.vencido {
            border-left-color: var(--danger);
            background: linear-gradient(45deg, rgba(220, 53, 69, 0.1), rgba(220, 53, 69, 0.05));
            position: relative;
            overflow: hidden;
        }

        .kanban-card.vencido::before {
            content: "VENCIDO";
            position: absolute;
            top: 10px;
            right: -30px;
            background: var(--danger);
            color: white;
            padding: 2px 30px;
            font-size: 0.7rem;
            font-weight: bold;
            transform: rotate(45deg);
        }

        .kanban-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .kanban-card-title {
            font-weight: 600;
            font-size: 0.95rem;
            margin-right: 0.5rem;
            flex: 1;
        }

        .kanban-card-priority {
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .kanban-card-body {
            margin-bottom: 0.75rem;
        }

        .kanban-card-desc {
            font-size: 0.85rem;
            color: var(--text-medium);
            margin-bottom: 0.5rem;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .kanban-card-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: var(--text-medium);
        }

        .kanban-card-meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        .kanban-card-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 0.75rem;
            padding-top: 0.75rem;
            border-top: 1px solid rgba(0,0,0,0.1);
        }

        .kanban-card-actions {
            display: flex;
            gap: 0.5rem;
        }

        .kanban-card-action-btn {
            background: none;
            border: none;
            color: var(--text-medium);
            cursor: pointer;
            font-size: 0.8rem;
            padding: 0.25rem;
            border-radius: 4px;
            transition: var(--transition);
        }

        .kanban-card-action-btn:hover {
            background: rgba(0,0,0,0.05);
            color: var(--primary-dark);
        }

        .kanban-card-date {
            font-size: 0.75rem;
            color: var(--text-medium);
            font-weight: 500;
        }

        /* Drag and Drop */
        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
        }

        .kanban-column-content.drag-over {
            background: rgba(201, 167, 105, 0.1);
            border-radius: 8px;
            min-height: 100px;
        }

        /* List View */
        .lista-view .table-container {
            margin-top: 1rem;
        }

        /* Calendar View */
        #calendarPrazos {
            height: 600px;
        }

        /* View Toggle */
        .view-toggle {
            display: flex;
            gap: 0.5rem;
            background: var(--gray-light);
            padding: 0.25rem;
            border-radius: 8px;
        }

        .view-toggle .btn-small {
            padding: 0.5rem 1rem;
        }

        .view-toggle .btn-small.active {
            background: var(--accent);
            color: var(--primary-dark);
        }

        /* Advanced Filters */
        .advanced-filters .form-control[multiple] {
            min-height: 120px;
            padding: 0.5rem;
        }

        .advanced-filters option {
            padding: 0.5rem;
            margin: 0.25rem 0;
        }

        /* Stats Panel */
        .stats-panel {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--gray-light);
            border-radius: var(--border-radius);
        }

        /* Badges de Status */
        .status-kanban {
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-pendente-kanban { background: #fff3cd; color: #856404; }
        .status-andamento-kanban { background: #d1ecf1; color: #0c5460; }
        .status-concluido-kanban { background: #d4edda; color: #155724; }
        .status-arquivado-kanban { background: #e2e3e5; color: #383d41; }

        /* Tags de Processo */
        .process-tag {
            display: inline-block;
            background: var(--primary-light);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-bar {
            width: 100%;
            height: 6px;
            background: var(--gray-light);
            border-radius: 3px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            transition: width 0.3s ease;
        }

        /* Small screens */
        @media (max-width: 768px){ 
            .header {
                padding: 1rem;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .user-info span:not(.notification-badge) {
                display: none;
            }
            
            .main-container{ 
                padding:1rem;
            } 
            
            .modal-content { 
                width: 95%; 
                padding: 1rem; 
            }
            
            .charts-container { 
                grid-template-columns: 1fr; 
            }
            
            .notification-dropdown { 
                width: 300px; 
                right: -50px; 
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions > div {
                width: 100%;
            }
            
            .form-actions input {
                width: 100%;
            }
            
            .tabs {
                padding-bottom: 0.5rem;
            }
            
            .tab {
                padding: 0.75rem 1rem;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 0.75rem 0.5rem;
            }
            
            .login-card {
                padding: 2rem 1.5rem;
            }
            
            .modal-content form > div {
                grid-template-columns: 1fr !important;
            }
            
            .prazos-grid {
                grid-template-columns: 1fr;
            }

            .template-buttons {
                flex-direction: column;
            }

            .filter-buttons {
                flex-direction: column;
            }

            /* Kanban Responsive */
            .kanban-board {
                grid-template-columns: 1fr;
                min-width: unset;
            }
            
            .kanban-column {
                height: 400px;
            }

            .kanban-card-actions {
                flex-direction: column;
            }
            
            .form-actions > div {
                width: 100%;
            }
            
            .form-actions input {
                width: 100%;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .notification-dropdown {
                width: 280px;
                right: -80px;
            }
            
            .charts-container {
                gap: 1rem;
            }
            
            .chart-card {
                padding: 1rem;
            }
        }

        /* FullCalendar customizations */
        .fc {
            font-family: 'Inter', sans-serif;
        }
        
        .fc-toolbar-title {
            font-weight: 600;
            color: var(--primary-dark);
        }
        
        .fc-button {
            background: var(--accent) !important;
            border: none !important;
            font-weight: 500;
        }
        
        .fc-button:hover {
            background: var(--accent-light) !important;
        }
        
        .fc-event {
            border: none;
            padding: 4px 8px;
            font-size: 0.85rem;
        }
        
        .fc-daygrid-event-dot {
            border-color: var(--accent) !important;
        }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: var(--text-medium);
        }
        
        .empty-state i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: var(--gray-light);
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header" id="header" style="display:none;">
            <div class="header-content">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <div class="logo-icon">
                        <img src="/logoguardian.png" alt="Logo Guardian" style="width: 50px; height: 50px; object-fit: contain;">
                    </div>
                    LEXGUARDIAN | MPS
                </div>
                <div class="user-info">
                    <div class="notifications">
                        <button class="notification-btn" id="notificationBtn" title="Notificações">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationBadge" style="display:none">0</span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h3>Notificações</h3>
                                <button class="mark-all-read" onclick="markAllNotificationsAsRead()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:0.9rem;">Marcar todas como lidas</button>
                            </div>
                            <div class="notification-list" id="notificationList"></div>
                        </div>
                    </div>
                    <span id="userNameDisplay">Usuário</span>
                    <span id="userRole" style="opacity:.85; font-size:.95rem"></span>
                    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span class="logout-text">Sair</span></button>
                </div>
            </div>
        </div>

        <div class="main-container">
            <!-- Login -->
            <div id="loginPage" class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <h2>Acesso ao Sistema</h2>
                        <h3>LEXGUARDIAN | MPS ADVOGADOS</h3>
                        <p>Entre com suas credenciais para acessar o sistema</p>
                    </div>
                    <form id="loginForm">
                        <div class="form-group">
                            <label>E-mail</label>
                            <input id="email" class="form-control" type="email" required placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label>Senha</label>
                            <input id="password" class="form-control" type="password" required placeholder="Sua senha">
                        </div>
                        <div class="form-group">
                            <label>Tipo de Usuário</label>
                            <select id="userType" class="form-control" required>
                                <option value="">Selecione</option>
                                <option value="admin">Advogado/Administrador</option>
                                <option value="client">Cliente</option>
                            </select>
                        </div>
                        <button class="btn btn-full" type="submit">
                            <i class="fas fa-sign-in-alt"></i>
                            Entrar
                        </button>
                    </form>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="dashboard-container" style="display:none">
                <div class="dashboard-header">
                    <h1>Dashboard do Administrador</h1>
                    <p>Gerencie clientes, processos, prazos e audiências</p>
                </div>

                <!-- Stats Overview -->
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalProcesses">0</div>
                        <div class="stat-label">Total de Processos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeClients">0</div>
                        <div class="stat-label">Clientes Ativos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="prazosProximos">0</div>
                        <div class="stat-label">Prazos Próximos</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="audienciasHoje">0</div>
                        <div class="stat-label">Audiências Hoje</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="processosAndamento">0</div>
                        <div class="stat-label">Processos em Andamento</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="receitaTotal">R$ 0</div>
                        <div class="stat-label">Receita Total (Pagos)</div>
                    </div>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="clients">
                        <i class="fas fa-users"></i>
                        Clientes
                    </div>
                    <div class="tab" data-tab="processes">
                        <i class="fas fa-gavel"></i>
                        Processos
                    </div>
                    <div class="tab" data-tab="prazos">
                        <i class="fas fa-clock"></i>
                        Prazos
                    </div>
                    <div class="tab" data-tab="calendar">
                        <i class="fas fa-calendar-alt"></i>
                       Audiências
                    </div>
                    <div class="tab" data-tab="users">
                        <i class="fas fa-user-cog"></i>
                        Usuários
                    </div>
                    <div class="tab" data-tab="reports">
                        <i class="fas fa-chart-bar"></i>
                        Relatórios
                    </div>
                </div>

                <!-- Clients Tab -->
                <div id="clients-tab" class="tab-content active">
                    <div class="form-actions">
                        <div>
                            <input id="clientSearch" class="form-control" placeholder="Buscar cliente..." style="width:100%">
                            <button class="advanced-search-toggle" onclick="toggleAdvancedSearch('clients')">
                                <i class="fas fa-filter"></i> Busca Avançada
                            </button>
                        </div>
                        <div>
                            <button class="btn" id="addClientBtn">
                                <i class="fas fa-plus"></i>
                                Adicionar Cliente
                            </button>
                        </div>
                    </div>

                    <div class="advanced-search" id="clientsAdvancedSearch" style="display:none">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <label>Status</label>
                                <select id="searchClientStatus" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                </select>
                            </div>
                            <div>
                                <label>Data Cadastro (De)</label>
                                <input id="searchClientDateFrom" class="form-control" type="date">
                            </div>
                            <div>
                                <label>Data Cadastro (Até)</label>
                                <input id="searchClientDateTo" class="form-control" type="date">
                            </div>
                        </div>
                        <div style="margin-top: 1rem; text-align: right;">
                            <button class="btn" onclick="applyAdvancedSearch('clients')">Aplicar Filtros</button>
                            <button class="btn btn-secondary" onclick="clearAdvancedSearch('clients')">Limpar</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="clientsTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Telefone</th>
                                    <th>CPF/CNPJ</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Processes Tab -->
                <div id="processes-tab" class="tab-content">
                    <div class="form-actions">
                        <div>
                            <input id="processSearch" class="form-control" placeholder="Buscar processo..." style="width:100%">
                            <button class="advanced-search-toggle" onclick="toggleAdvancedSearch('processes')">
                                <i class="fas fa-filter"></i> Busca Avançada
                            </button>
                        </div>
                        <button class="btn" id="addProcessBtn">
                            <i class="fas fa-plus"></i>
                            Adicionar Processo
                        </button>
                    </div>

                    <div class="advanced-search" id="processesAdvancedSearch" style="display:none">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <label>Status</label>
                                <select id="searchProcessStatus" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="arquivado">Arquivado</option>
                                </select>
                            </div>
                            <div>
                                <label>Data Início (De)</label>
                                <input id="searchProcessDateFrom" class="form-control" type="date">
                            </div>
                            <div>
                                <label>Data Início (Até)</label>
                                <input id="searchProcessDateTo" class="form-control" type="date">
                            </div>
                        </div>
                        <div style="margin-top: 1rem; text-align: right;">
                            <button class="btn" onclick="applyAdvancedSearch('processes')">Aplicar Filtros</button>
                            <button class="btn btn-secondary" onclick="clearAdvancedSearch('processes')">Limpar</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="processesTable">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Data Início</th>
                                    <th>Advogado</th>
                                    <th>Prazos</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="processesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Prazos Tab - Sistema Kanban Avançado -->
                <div id="prazos-tab" class="tab-content">
                    <div class="dashboard-header">
                        <h1>Gestão de Prazos</h1>
                        <p>Organize e acompanhe todos os prazos do escritório</p>
                    </div>

                    <!-- Resumo de Prazos -->
                    <div class="stats-grid">
                        <div class="stat-card" style="border-left-color: var(--danger);">
                            <div class="stat-value" id="totalPrazos">0</div>
                            <div class="stat-label">Total de Prazos</div>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--warning);">
                            <div class="stat-value" id="prazosHoje">0</div>
                            <div class="stat-label">Vencem Hoje</div>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--info);">
                            <div class="stat-value" id="prazosAtrasados">0</div>
                            <div class="stat-label">Atrasados</div>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--success);">
                            <div class="stat-value" id="prazosConcluidos">0</div>
                            <div class="stat-label">Concluídos</div>
                        </div>
                    </div>

                    <!-- Barra de Ferramentas -->
                    <div class="form-actions">
                        <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                            <!-- Busca -->
                            <div style="position: relative; width: 300px;">
                                <input id="prazoSearch" class="form-control" placeholder="Buscar prazos...">
                                <i class="fas fa-search" style="position: absolute; right: 15px; top: 50%; transform: translateY(-50%); color: var(--text-medium);"></i>
                            </div>
                            
                            <!-- Filtros Rápidos -->
                            <div class="filter-buttons">
                                <button class="btn btn-small btn-secondary active" data-filter="todos">
                                    <i class="fas fa-list"></i> Todos
                                </button>
                                <button class="btn btn-small btn-secondary" data-filter="hoje">
                                    <i class="fas fa-calendar-day"></i> Hoje
                                </button>
                                <button class="btn btn-small btn-secondary" data-filter="semana">
                                    <i class="fas fa-calendar-week"></i> Esta Semana
                                </button>
                                <button class="btn btn-small btn-secondary" data-filter="atrasados">
                                    <i class="fas fa-exclamation-triangle"></i> Atrasados
                                </button>
                                <button class="btn btn-small btn-secondary" data-filter="concluidos">
                                    <i class="fas fa-check-circle"></i> Concluídos
                                </button>
                            </div>
                            
                            <!-- Botão Filtros Avançados -->
                            <button class="btn btn-small btn-secondary" id="toggleAdvancedFilters">
                                <i class="fas fa-filter"></i> Filtros Avançados
                            </button>
                            
                            <!-- Visualização -->
                            <div class="view-toggle" style="margin-left: auto;">
                                <button class="btn btn-small btn-secondary active" data-view="kanban">
                                    <i class="fas fa-th-large"></i> Kanban
                                </button>
                                <button class="btn btn-small btn-secondary" data-view="lista">
                                    <i class="fas fa-list"></i> Lista
                                </button>
                                <button class="btn btn-small btn-secondary" data-view="calendario">
                                    <i class="fas fa-calendar"></i> Calendário
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <button class="btn" id="addPrazoBtn">
                                <i class="fas fa-plus"></i>
                                Novo Prazo
                            </button>
                            <button class="btn btn-secondary" onclick="gerarRelatorioPrazos()">
                                <i class="fas fa-file-export"></i>
                                Exportar
                            </button>
                        </div>
                    </div>

                    <!-- Filtros Avançados -->
                    <div class="advanced-filters" id="advancedFilters" style="display: none; margin: 1.5rem 0; padding: 1.5rem; background: var(--gray-light); border-radius: var(--border-radius);">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label>Prioridade</label>
                                <select id="filterPrioridade" class="form-control" multiple style="height: 120px;">
                                    <option value="urgente">Urgente</option>
                                    <option value="alta">Alta</option>
                                    <option value="media">Média</option>
                                    <option value="baixa">Baixa</option>
                                </select>
                            </div>
                            <div>
                                <label>Tipo de Prazo</label>
                                <select id="filterTipo" class="form-control" multiple style="height: 120px;">
                                    <option value="contestacao">Contestação</option>
                                    <option value="recurso">Recurso</option>
                                    <option value="impugnacao">Impugnação</option>
                                    <option value="manifestacao">Manifestação</option>
                                    <option value="audiencia">Audiência</option>
                                    <option value="protocolo">Protocolo</option>
                                    <option value="outro">Outro</option>
                                </select>
                            </div>
                            <div>
                                <label>Responsável</label>
                                <select id="filterResponsavel" class="form-control" multiple style="height: 120px;">
                                    <!-- Carregado dinamicamente -->
                                </select>
                            </div>
                            <div>
                                <label>Processo</label>
                                <select id="filterProcesso" class="form-control">
                                    <option value="">Todos os processos</option>
                                    <!-- Carregado dinamicamente -->
                                </select>
                            </div>
                        </div>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label>Data de Vencimento (De)</label>
                                <input id="filterDataDe" class="form-control" type="date">
                            </div>
                            <div>
                                <label>Data de Vencimento (Até)</label>
                                <input id="filterDataAte" class="form-control" type="date">
                            </div>
                        </div>
                        
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <input type="checkbox" id="filterApenasMeus">
                                <label for="filterApenasMeus" style="margin-left: 0.5rem;">Apenas meus prazos</label>
                            </div>
                            
                            <div style="display: flex; gap: 0.5rem;">
                                <button class="btn btn-small" onclick="aplicarFiltrosAvancados()">
                                    <i class="fas fa-check"></i> Aplicar Filtros
                                </button>
                                <button class="btn btn-small btn-secondary" onclick="limparFiltrosAvancados()">
                                    <i class="fas fa-times"></i> Limpar Filtros
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Container do Kanban -->
                    <div class="kanban-container" id="kanbanView">
                        <div class="kanban-board">
                            <!-- Coluna: Pendente -->
                            <div class="kanban-column" data-status="pendente">
                                <div class="kanban-column-header">
                                    <h3>📋 Pendente</h3>
                                    <span class="kanban-count" id="count-pendente">0</span>
                                </div>
                                <div class="kanban-column-content" id="column-pendente">
                                    <!-- Cards serão inseridos aqui -->
                                </div>
                                <div class="kanban-column-footer">
                                    <button class="btn btn-small" onclick="openPrazoModal(null, null, null, 'pendente')" style="width: 100%;">
                                        <i class="fas fa-plus"></i> Adicionar
                                    </button>
                                </div>
                            </div>

                            <!-- Coluna: Em Andamento -->
                            <div class="kanban-column" data-status="andamento">
                                <div class="kanban-column-header">
                                    <h3>⚙️ Em Andamento</h3>
                                    <span class="kanban-count" id="count-andamento">0</span>
                                </div>
                                <div class="kanban-column-content" id="column-andamento">
                                    <!-- Cards serão inseridos aqui -->
                                </div>
                                <div class="kanban-column-footer">
                                    <button class="btn btn-small" onclick="moverTodosParaAndamento()" style="width: 100%;">
                                        <i class="fas fa-forward"></i> Mover Todos
                                    </button>
                                </div>
                            </div>

                            <!-- Coluna: Concluído -->
                            <div class="kanban-column" data-status="concluido">
                                <div class="kanban-column-header">
                                    <h3>✅ Concluído</h3>
                                    <span class="kanban-count" id="count-concluido">0</span>
                                </div>
                                <div class="kanban-column-content" id="column-concluido">
                                    <!-- Cards serão inseridos aqui -->
                                </div>
                                <div class="kanban-column-footer">
                                    <button class="btn btn-small" onclick="limparConcluidos()" style="width: 100%;">
                                        <i class="fas fa-trash"></i> Limpar
                                    </button>
                                </div>
                            </div>

                            <!-- Coluna: Arquivado -->
                            <div class="kanban-column" data-status="arquivado">
                                <div class="kanban-column-header">
                                    <h3>📁 Arquivado</h3>
                                    <span class="kanban-count" id="count-arquivado">0</span>
                                </div>
                                <div class="kanban-column-content" id="column-arquivado">
                                    <!-- Cards serão inseridos aqui -->
                                </div>
                                <div class="kanban-column-footer">
                                    <button class="btn btn-small" onclick="restaurarArquivados()" style="width: 100%;">
                                        <i class="fas fa-undo"></i> Restaurar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Visualização em Lista -->
                    <div class="lista-view" id="listaView" style="display: none;">
                        <div class="table-container">
                            <table id="prazosTable">
                                <thead>
                                    <tr>
                                        <th style="width: 40px;">#</th>
                                        <th>Título</th>
                                        <th>Processo</th>
                                        <th>Tipo</th>
                                        <th>Prioridade</th>
                                        <th>Responsável</th>
                                        <th>Vencimento</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="prazosTableBody">
                                    <!-- Dados serão carregados aqui -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Visualização em Calendário -->
                    <div class="calendario-view" id="calendarioView" style="display: none;">
                        <div class="calendar-container">
                            <div id="calendarPrazos"></div>
                        </div>
                    </div>

                    <!-- Painel de Estatísticas -->
                    <div class="stats-panel">
                        <h3>📊 Estatísticas de Prazos</h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--danger);" id="stat-urgentes">0</div>
                                <div style="font-size: 0.9rem; color: var(--text-medium);">Urgentes</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);" id="stat-proximos">0</div>
                                <div style="font-size: 0.9rem; color: var(--text-medium);">Próximos (3 dias)</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);" id="stat-no-prazo">0</div>
                                <div style="font-size: 0.9rem; color: var(--text-medium);">No Prazo</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="font-size: 1.5rem; font-weight: bold; color: var(--info);" id="stat-sem-prazo">0</div>
                                <div style="font-size: 0.9rem; color: var(--text-medium);">Sem Prazo Definido</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Calendar Tab -->
                <div id="calendar-tab" class="tab-content">
                    <div class="form-actions">
                        <div>
                            <select id="calendarView" class="form-control" style="width: auto;">
                                <option value="dayGridMonth">Mês</option>
                                <option value="timeGridWeek">Semana</option>
                                <option value="timeGridDay">Dia</option>
                                <option value="listMonth">Lista</option>
                            </select>
                        </div>
                        <button class="btn" id="addAudienciaBtn">
                            <i class="fas fa-plus"></i>
                            Nova Audiência
                        </button>
                    </div>

                    <div class="calendar-container">
                        <div id="calendar"></div>
                    </div>
                </div>

                <!-- Users Tab -->
                <div id="users-tab" class="tab-content">
                    <div class="form-actions">
                        <button class="btn" id="addUserBtn">
                            <i class="fas fa-plus"></i>
                            Adicionar Usuário
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Tipo</th>
                                    <th>Vinculado</th>
                                    <th>Status</th>
                                    <th>Último Acesso</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Reports Tab -->
                <div id="reports-tab" class="tab-content">
                    <div class="dashboard-header">
                        <h1>Relatórios e Analytics</h1>
                        <p>Análise de desempenho e métricas do escritório</p>
                    </div>
                    
                    <!-- Filtros -->
                    <div class="filters" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1.5rem; padding:1.5rem; background:var(--gray-light); border-radius:var(--border-radius);">
                        <div>
                            <label>Período</label>
                            <select id="reportPeriod" class="form-control">
                                <option value="all">Todo o período</option>
                                <option value="7">Últimos 7 dias</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 3 meses</option>
                                <option value="365">Último ano</option>
                            </select>
                        </div>
                        <div>
                            <label>Advogado</label>
                            <select id="reportLawyer" class="form-control">
                                <option value="all">Todos</option>
                                <option value="Dr. Lukas Medeiros">Dr. Lukas Medeiros</option>
                                <option value="Dra. Losainny Silva">Dra. Losainny Silva</option>
                                <option value="Taiza Barros">Taiza Barros</option>
                                <option value="Marvilei Soares">Marvilei Soares</option>
                            </select>
                        </div>
                        <div>
                            <label>Tipo de Processo</label>
                            <select id="reportType" class="form-control">
                                <option value="all">Todos</option>
                                <option value="civil">Civil</option>
                                <option value="trabalhista">Trabalhista</option>
                                <option value="penal">Penal</option>
                                <option value="previdenciario">Previdenciário</option>
                                <option value="empresarial">Empresarial</option>
                                <option value="familia">Família</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn" id="generateReport">
                                <i class="fas fa-chart-line"></i>
                                Gerar Relatório
                            </button>
                        </div>
                    </div>
                    
                    <!-- Estatísticas do Relatório -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="reportTotalProcesses">0</div>
                            <div class="stat-label">Processos no Período</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="reportRevenue">R$ 0</div>
                            <div class="stat-label">Honorários Pagos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="reportExpenses">R$ 0</div>
                            <div class="stat-label">Despesas Totais</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="reportProfit">R$ 0</div>
                            <div class="stat-label">Saldo Final</div>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--warning);">
                            <div class="stat-value" id="reportPendingHonorarios">R$ 0</div>
                            <div class="stat-label">Honorários Pendentes</div>
                        </div>
                        <div class="stat-card" style="border-left-color: var(--info);">
                            <div class="stat-value" id="reportReceitaPotencial">R$ 0</div>
                            <div class="stat-label">Receita Potencial</div>
                        </div>
                    </div>
                    
                    <!-- Gráficos -->
                    <div class="charts-container">
                        <div class="chart-card">
                            <h4>Processos por Status</h4>
                            <canvas id="statusChart" height="250"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4>Processos por Advogado</h4>
                            <canvas id="lawyerChart" height="250"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4>Distribuição por Tipo</h4>
                            <canvas id="typeChart" height="250"></canvas>
                        </div>
                        <div class="chart-card">
                            <h4>Evolução Mensal</h4>
                            <canvas id="timelineChart" height="250"></canvas>
                        </div>
                    </div>
                    
                    <!-- Tabela de Processos do Relatório -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Data Abertura</th>
                                    <th>Advogado</th>
                                    <th>Honorários Pagos</th>
                                    <th>Honorários Pendentes</th>
                                    <th>Custos</th>
                                    <th>Saldo Final</th>
                                </tr>
                            </thead>
                            <tbody id="reportProcessesBody">
                                <!-- Dados carregados dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="export-options" style="display:flex; gap:1rem; margin-top:1.5rem; justify-content:flex-end;">
                        <button class="btn" onclick="exportToPDF()">
                            <i class="fas fa-file-pdf"></i>
                            Exportar PDF
                        </button>
                        <button class="btn" onclick="exportToExcel()">
                            <i class="fas fa-file-excel"></i>
                            Exportar Excel
                        </button>
                        <button class="btn" onclick="exportToCSV()">
                            <i class="fas fa-file-csv"></i>
                            Exportar CSV
                        </button>
                    </div>

                    <!-- Backup Section -->
                    <div class="backup-section">
                        <h3>Backup de Dados</h3>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                            <button class="btn" onclick="exportBackup()">
                                <i class="fas fa-download"></i>
                                Exportar Backup
                            </button>
                            <button class="btn" onclick="importBackup()" style="background: var(--primary-dark); color: white;">
                                <i class="fas fa-upload"></i>
                                Importar Backup
                            </button>
                            <input type="file" id="backupFile" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Dashboard -->
            <div id="clientDashboard" class="dashboard-container" style="display:none">
                <div class="dashboard-header">
                    <h1>Área do Cliente</h1>
                    <p>Acompanhe seus processos e prazos</p>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="my-processes">
                        <i class="fas fa-gavel"></i>
                        Meus Processos
                    </div>
                    <div class="tab" data-tab="my-prazos">
                        <i class="fas fa-clock"></i>
                        Meus Prazos
                    </div>
                    <div class="tab" data-tab="my-documents">
                        <i class="fas fa-file-alt"></i>
                        Meus Documentos
                    </div>
                    <div class="tab" data-tab="my-profile">
                        <i class="fas fa-user"></i>
                        Meu Perfil
                    </div>
                </div>

                <div id="my-processes-tab" class="tab-content active">
                    <div class="table-container">
                        <table id="clientProcessesTable">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Data Início</th>
                                    <th>Advogado</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientProcessesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="my-prazos-tab" class="tab-content">
                    <div class="prazos-grid" id="clientPrazosGrid">
                        <!-- Prazos do cliente serão carregados aqui -->
                    </div>
                </div>

                <div id="my-documents-tab" class="tab-content">
                    <div class="table-container">
                        <table id="clientDocumentsTable">
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Processo</th>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientDocumentsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="my-profile-tab" class="tab-content">
                    <form id="clientProfileForm">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                            <div class="form-group">
                                <label>Nome</label>
                                <input id="clientProfileName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>E-mail</label>
                                <input id="clientProfileEmail" class="form-control" required>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                            <div class="form-group">
                                <label>Telefone</label>
                                <input id="clientProfilePhone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>CPF/CNPJ</label>
                                <input id="clientProfileCPF" class="form-control">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:1rem">
                            <label>Endereço</label>
                            <input id="clientProfileAddress" class="form-control">
                        </div>
                        <div style="margin-top:1.5rem; text-align:right">
                            <button class="btn" type="submit">
                                <i class="fas fa-save"></i>
                                Atualizar Perfil
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <!-- Modais: Client / Process / User -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="clientModalTitle">Adicionar Cliente</h2>
                <button class="modal-close" onclick="closeClientModal()">&times;</button>
            </div>
            <form id="clientForm">
                <input type="hidden" id="clientId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Nome</label>
                        <input id="clientName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input id="clientEmail" class="form-control" required>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Telefone</label>
                        <input id="clientPhone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>CPF/CNPJ</label>
                        <input id="clientCPF" class="form-control" required>
                    </div>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Endereço</label>
                    <input id="clientAddress" class="form-control">
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Status</label>
                    <select id="clientStatus" class="form-control">
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                    </select>
                </div>
                <div style="margin-top:1.5rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn btn-secondary" onclick="closeClientModal()">Cancelar</button>
                    <button class="btn" type="submit">
                        <i class="fas fa-save"></i>
                        Salvar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="processModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="processModalTitle">Adicionar Processo</h2>
                <button class="modal-close" onclick="closeProcessModal()">&times;</button>
            </div>
            <form id="processForm">
                <input type="hidden" id="processId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Número do Processo</label>
                        <input id="processNumber" class="form-control" required>
                        <div style="font-size:.85rem; color:var(--text-medium); margin-top: 0.25rem">Formato: NNNNNN-DD.AAAA.J.TR.OOOO</div>
                    </div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <select id="processClient" class="form-control" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="processType" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="civil">Civil</option>
                            <option value="trabalhista">Trabalhista</option>
                            <option value="penal">Penal</option>
                            <option value="previdenciario">Previdenciário</option>
                            <option value="empresarial">Empresarial</option>
                            <option value="familia">Família</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="processStatus" class="form-control" required>
                            <option value="pendente">Pendente</option>
                            <option value="andamento">Em Andamento</option>
                            <option value="concluido">Concluído</option>
                            <option value="arquivado">Arquivado</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Advogado</label>
                        <select id="processLawyer" class="form-control" required>
                            <option value="">Selecione o advogado</option>
                            <option value="lucas">Dr. Lukas Medeiros</option>
                            <option value="losainny">Dra. Losainny Silva</option>
                            <option value="taiza">Taiza  Barros</option>
                            <option value="marvilei">Marvilei Soares</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data de Início</label>
                        <input id="processStartDate" class="form-control" type="date" required>
                    </div>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Prazo Final (Opcional)</label>
                    <input id="processDeadline" class="form-control" type="date">
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Descrição</label>
                    <textarea id="processDescription" class="form-control" rows="4" required></textarea>
                </div>
                <div style="margin-top:1.5rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn btn-secondary" onclick="closeProcessModal()">Cancelar</button>
                    <button class="btn" type="submit">
                        <i class="fas fa-save"></i>
                        Salvar Processo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Adicionar Usuário</h2>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Nome</label>
                        <input id="userNameInput" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input id="userEmail" class="form-control" required>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Senha</label>
                        <input id="userPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Usuário</label>
                        <select id="userTypeModal" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="admin">Administrador</option>
                            <option value="client">Cliente</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:1rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Vincular a Cliente (opcional)</label>
                        <select id="userClientSelect" class="form-control">
                            <option value="">Nenhum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="userStatus" class="form-control">
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:1.5rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn btn-secondary" onclick="closeUserModal()">Cancelar</button>
                    <button class="btn" type="submit">
                        <i class="fas fa-save"></i>
                        Salvar Usuário
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Prazo Interno -->
    <div class="modal" id="prazoModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="prazoModalTitle">Adicionar Prazo Interno</h2>
                <button class="modal-close" onclick="closePrazoModal()">&times;</button>
            </div>
            
            <!-- Templates de Prazos -->
            <div class="template-buttons">
                <button type="button" class="template-btn" onclick="applyPrazoTemplate('contestacao')">Contestação</button>
                <button type="button" class="template-btn" onclick="applyPrazoTemplate('recurso')">Recurso</button>
                <button type="button" class="template-btn" onclick="applyPrazoTemplate('audiencia')">Audiência</button>
                <button type="button" class="template-btn" onclick="applyPrazoTemplate('protocolo')">Protocolo</button>
                <button type="button" class="template-btn" onclick="applyPrazoTemplate('impugnacao')">Impugnação</button>
                <button type="button" class="template-btn" onclick="applyPrazoTemplate('manifestacao')">Manifestação</button>
                <button type="button" class="template-btn" onclick="applyPrazoTemplate('diligencia')">Diligência</button>
                <button type="button" class="template-btn" onclick="applyPrazoTemplate('reuniao')">Reunião</button>
            </div>
            
            <form id="prazoForm">
                <input type="hidden" id="prazoId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Título *</label>
                        <input id="prazoTitulo" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Processo *</label>
                        <select id="prazoProcesso" class="form-control" required>
                            <option value="">Selecione um processo</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Tipo de Prazo *</label>
                        <select id="prazoTipo" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="contestacao">Contestação</option>
                            <option value="recurso">Recurso</option>
                            <option value="impugnacao">Impugnação</option>
                            <option value="manifestacao">Manifestação</option>
                            <option value="audiencia">Audiência</option>
                            <option value="protocolo">Protocolo</option>
                            <option value="diligencia">Diligência</option>
                            <option value="reuniao">Reunião</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Prioridade *</label>
                        <select id="prazoPrioridade" class="form-control" required>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Data de Vencimento *</label>
                        <input id="prazoVencimento" class="form-control" type="datetime-local" required>
                    </div>
                    <div class="form-group">
                        <label>Responsável *</label>
                        <select id="prazoResponsavel" class="form-control" required>
                            <option value="">Selecione o responsável</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Descrição *</label>
                    <textarea id="prazoDescricao" class="form-control" rows="4" required></textarea>
                </div>
                <div style="margin-top:1rem; display:flex; justify-content:space-between; align-items:center;">
                    <div>
                        <input type="checkbox" id="prazoVisivelCliente">
                        <label for="prazoVisivelCliente" style="margin-left: 0.5rem;">Visível para o cliente</label>
                    </div>
                    <div style="display:flex; gap:1rem">
                        <button type="button" class="btn btn-secondary" onclick="closePrazoModal()">Cancelar</button>
                        <button class="btn" type="submit">
                            <i class="fas fa-save"></i>
                            Salvar Prazo
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de Audiência -->
    <div class="modal" id="audienciaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="audienciaModalTitle">Agendar Audiência</h2>
                <button class="modal-close" onclick="closeAudienciaModal()">&times;</button>
            </div>
            <form id="audienciaForm">
                <input type="hidden" id="audienciaId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Título</label>
                        <input id="audienciaTitulo" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Processo</label>
                        <select id="audienciaProcesso" class="form-control" required>
                            <option value="">Selecione um processo</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Data e Hora</label>
                        <input id="audienciaData" class="form-control" type="datetime-local" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Audiência</label>
                        <select id="audienciaTipo" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="inicial">Audiência Inicial</option>
                            <option value="conciliacao">Audiência de Conciliação</option>
                            <option value="instrucao">Audiência de Instrução</option>
                            <option value="julgamento">Audiência de Julgamento</option>
                            <option value="outra">Outra</option>
                        </select>
                    </div>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Local</label>
                    <input id="audienciaLocal" class="form-control" required>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Participantes</label>
                    <textarea id="audienciaParticipantes" class="form-control" rows="3" placeholder="Liste os participantes..."></textarea>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Observações</label>
                    <textarea id="audienciaObservacoes" class="form-control" rows="3"></textarea>
                </div>
                <div style="margin-top:1.5rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn btn-secondary" onclick="closeAudienciaModal()">Cancelar</button>
                    <button class="btn" type="submit">
                        <i class="fas fa-save"></i>
                        Salvar Audiência
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de detalhes do processo (timeline + finanças + prazos) -->
    <div class="modal" id="processDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Processo</h2>
                <button class="modal-close" onclick="closeProcessDetails()">&times;</button>
            </div>
            
            <!-- Tabs dentro do modal -->
            <div class="modal-tabs">
                <div class="modal-tab active" data-tab="timeline">
                    <i class="fas fa-stream"></i>
                    Timeline
                </div>

                <div class="modal-tab" data-tab="financial">
                    <i class="fas fa-chart-line"></i>
                    Financeiro
                </div>
            </div>
            
            <!-- Conteúdo da Timeline -->
            <div id="timeline-tab" class="modal-tab-content active">
                <div id="processDetailsContent"></div>
                <div id="addUpdateContainer" style="margin-top:1.5rem; border-top:1px solid #ccc; padding-top:1rem;"></div>
            </div>
            
            <!-- Conteúdo dos Prazos -->
            <div id="prazos-tab" class="modal-tab-content">
                <div id="processPrazosContent"></div>
                <div id="addPrazoProcessoContainer" style="margin-top:1.5rem; border-top:1px solid #ccc; padding-top:1rem;"></div>
            </div>
            
            <!-- Conteúdo do Financeiro -->
            <div id="financial-tab" class="modal-tab-content">
                <div id="financialDetailsContent"></div>
                <div id="addFinancialContainer" style="margin-top:1.5rem; border-top:1px solid #ccc; padding-top:1rem;"></div>
            </div>
        </div>
    </div>

    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://vzwwmiupvfdrmgcmuldf.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6d3dtaXVwdmZkcm1nY211bGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjQ2NzQsImV4cCI6MjA3OTk0MDY3NH0.tsQkCfxcZQmt6fJf6lLBnAdzl4fjQPWPAVmWlMQe1ss';

        // Inicializar cliente Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- Variáveis Globais ---
        let currentUser = null;
        let currentProcessId = null;
        let calendar = null;
        let calendarPrazos = null;
        let kanbanPrazos = [];
        let currentFilters = {};
        let currentView = 'kanban';

        // --- Templates de Prazos ---
        const templatesPrazos = {
            'contestacao': {
                titulo: 'Prazo para Contestação',
                descricao: 'Prazo legal para apresentação de contestação conforme artigo 335 do CPC',
                tipo: 'contestacao',
                prioridade: 'alta'
            },
            'recurso': {
                titulo: 'Interposição de Recurso',
                descricao: 'Prazo para interposição de recurso - atenção aos prazos processuais',
                tipo: 'recurso',
                prioridade: 'alta'
            },
            'audiencia': {
                titulo: 'Preparação para Audiência',
                descricao: 'Preparação de documentos, testemunhas e estratégia para audiência',
                tipo: 'audiencia',
                prioridade: 'urgente'
            },
            'protocolo': {
                titulo: 'Protocolo de Petição',
                descricao: 'Protocolo de petição no fórum - verificar horário de funcionamento',
                tipo: 'protocolo',
                prioridade: 'media'
            },
            'impugnacao': {
                titulo: 'Impugnação ao Valor da Causa',
                descricao: 'Prazo para impugnação ao valor da causa nos termos do artigo 292 do CPC',
                tipo: 'impugnacao',
                prioridade: 'media'
            },
            'manifestacao': {
                titulo: 'Manifestação sobre Documentos',
                descricao: 'Manifestação sobre documentos apresentados pela parte contrária',
                tipo: 'manifestacao',
                prioridade: 'alta'
            },
            'diligencia': {
                titulo: 'Diligência Processual',
                descricao: 'Realização de diligência requisitada pelo juízo',
                tipo: 'diligencia',
                prioridade: 'media'
            },
            'reuniao': {
                titulo: 'Reunião com Cliente',
                descricao: 'Reunião para apresentação de andamento processual',
                tipo: 'reuniao',
                prioridade: 'baixa'
            }
        };

        // --- Funções para Supabase ---

        // Clientes
        async function getClients() {
            try {
                const { data, error } = await supabase
                    .from('clients')
                    .select('*')
                    .order('name');
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar clients:', error);
                showAlert('Erro ao carregar clientes!', 'error');
                return [];
            }
        }

        async function saveClient(client) {
            try {
                const clientData = {
                    name: client.name,
                    email: client.email,
                    phone: client.phone,
                    cpf: client.cpf,
                    address: client.address,
                    status: client.status
                };

                if (client.id) {
                    const { data, error } = await supabase
                        .from('clients')
                        .update(clientData)
                        .eq('id', client.id)
                        .select();
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('clients')
                        .insert([clientData])
                        .select();
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Erro ao salvar client:', error);
                showAlert('Erro ao salvar cliente!', 'error');
                return null;
            }
        }

        async function deleteClient(id) {
            try {
                const { error } = await supabase
                    .from('clients')
                    .delete()
                    .eq('id', id);
                return !error;
            } catch (error) {
                console.error('Erro ao excluir client:', error);
                showAlert('Erro ao excluir cliente!', 'error');
                return false;
            }
        }

        // Processos
        async function getProcesses() {
            try {
                const { data, error } = await supabase
                    .from('processos')
                    .select(`
                        *,
                        clients (name, email),
                        advogados (name)
                    `)
                    .order('data_abertura', { ascending: false });
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar processos:', error);
                showAlert('Erro ao carregar processos!', 'error');
                return [];
            }
        }

        async function saveProcess(process) {
            try {
                // Converter lawyer name para ID
                const lawyers = await getLawyers();
                const lawyer = lawyers.find(l => l.name === process.lawyer);
                const lawyerId = lawyer ? lawyer.id : 1;

                const processData = {
                    numero_processo: process.number,
                    cliente_id: process.clientId,
                    tipo_processo: process.type,
                    status: process.status,
                    descricao: process.description,
                    advogado_id: lawyerId,
                    data_abertura: process.startDate,
                    prazo_final: process.deadline
                };

                if (process.id) {
                    const { data, error } = await supabase
                        .from('processos')
                        .update(processData)
                        .eq('id', process.id)
                        .select();
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('processos')
                        .insert([processData])
                        .select();
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Erro ao salvar processo:', error);
                showAlert('Erro ao salvar processo!', 'error');
                return null;
            }
        }

        async function deleteProcess(id) {
            try {
                const { error } = await supabase
                    .from('processos')
                    .delete()
                    .eq('id', id);
                return !error;
            } catch (error) {
                console.error('Erro ao excluir processo:', error);
                showAlert('Erro ao excluir processo!', 'error');
                return false;
            }
        }

        // Usuários
        async function getUsers() {
            try {
                const { data, error } = await supabase
                    .from('usuários')
                    .select('*, clients(name)')
                    .order('name');
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar usuários:', error);
                showAlert('Erro ao carregar usuários!', 'error');
                return [];
            }
        }

        async function saveUser(user) {
            try {
                const userData = {
                    name: user.name,
                    email: user.email,
                    password: user.password,
                    user_type: user.type,
                    status: user.status,
                    client_id: user.clientId || null
                };

                if (user.id) {
                    const { data, error } = await supabase
                        .from('usuários')
                        .update(userData)
                        .eq('id', user.id)
                        .select();
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('usuários')
                        .insert([userData])
                        .select();
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Erro ao salvar usuário:', error);
                showAlert('Erro ao salvar usuário!', 'error');
                return null;
            }
        }

        async function deleteUser(id) {
            try {
                const { error } = await supabase
                    .from('usuários')
                    .delete()
                    .eq('id', id);
                return !error;
            } catch (error) {
                console.error('Erro ao excluir usuário:', error);
                showAlert('Erro ao excluir usuário!', 'error');
                return false;
            }
        }

        // Advogados
        async function getLawyers() {
            try {
                const { data, error } = await supabase
                    .from('advogados')
                    .select('*');
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar advogados:', error);
                return [];
            }
        }

        // Financeiro
        async function getFinancials() {
            try {
                const { data, error } = await supabase
                    .from('financeiro')
                    .select('*')
                    .order('date');
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar dados financeiros:', error);
                return [];
            }
        }

        async function saveFinancial(financial) {
            try {
                const financialData = {
                    processo_id: financial.processId,
                    type: financial.type,
                    description: financial.description,
                    value: financial.value,
                    date: financial.date,
                    status: financial.status
                };

                if (financial.id) {
                    const { data, error } = await supabase
                        .from('financeiro')
                        .update(financialData)
                        .eq('id', financial.id)
                        .select();
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('financeiro')
                        .insert([financialData])
                        .select();
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Erro ao salvar dado financeiro:', error);
                return null;
            }
        }

        async function deleteFinancial(id) {
            try {
                const { error } = await supabase
                    .from('financeiro')
                    .delete()
                    .eq('id', id);
                return !error;
            } catch (error) {
                console.error('Erro ao excluir dado financeiro:', error);
                return false;
            }
        }

        // Notificações
        async function getNotifications() {
            if (!currentUser) return [];
            try {
                const { data, error } = await supabase
                    .from('notificações')
                    .select('*')
                    .eq('user_id', currentUser.id)
                    .order('created_at', { ascending: false });
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar notificações:', error);
                return [];
            }
        }

        async function saveNotification(notification) {
            try {
                const { data, error } = await supabase
                    .from('notificações')
                    .insert([notification])
                    .select();
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Erro ao salvar notificação:', error);
                return null;
            }
        }

        async function markNotificationAsRead(id) {
            try {
                const { error } = await supabase
                    .from('notificações')
                    .update({ read: true })
                    .eq('id', id);
                return !error;
            } catch (error) {
                console.error('Erro ao marcar notificação como lida:', error);
                return false;
            }
        }

        // Documentos
        async function getDocuments() {
            try {
                const { data, error } = await supabase
                    .from('documentos')
                    .select('*');
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar documentos:', error);
                return [];
            }
        }

        // Processo Atualizações (Timeline)
        async function getProcessUpdates(processId) {
            try {
                const { data, error } = await supabase
                    .from('processo_atualizacoes')
                    .select('*')
                    .eq('processo_id', processId)
                    .order('data_atualizacao', { ascending: false });
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar atualizações do processo:', error);
                return [];
            }
        }

        async function saveProcessUpdate(update) {
            try {
                const { data, error } = await supabase
                    .from('processo_atualizacoes')
                    .insert([update])
                    .select();
                if (error) throw error;
                return data[0];
            } catch (error) {
                console.error('Erro ao salvar atualização do processo:', error);
                return null;
            }
        }

        // Prazos Internos
        async function getPrazosInternos(processoId = null) {
            try {
                let query = supabase
                    .from('prazos_internos')
                    .select(`
                        *,
                        processos (numero_processo, clients (name)),
                        usuarios (name)
                    `)
                    .order('data_vencimento', { ascending: true });

                if (processoId) {
                    query = query.eq('processo_id', processoId);
                }

                const { data, error } = await query;
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar prazos internos:', error);
                showAlert('Erro ao carregar prazos!', 'error');
                return [];
            }
        }

        async function savePrazoInterno(prazo) {
            try {
                const prazoData = {
                    processo_id: prazo.processoId,
                    titulo: prazo.titulo,
                    descricao: prazo.descricao,
                    tipo_prazo: prazo.tipoPrazo,
                    data_vencimento: prazo.dataVencimento,
                    responsavel_id: prazo.responsavelId,
                    status: prazo.status,
                    prioridade: prazo.prioridade,
                    visivel_cliente: prazo.visivelCliente
                };

                if (prazo.id) {
                    const { data, error } = await supabase
                        .from('prazos_internos')
                        .update(prazoData)
                        .eq('id', prazo.id)
                        .select();
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('prazos_internos')
                        .insert([prazoData])
                        .select();
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Erro ao salvar prazo interno:', error);
                showAlert('Erro ao salvar prazo!', 'error');
                return null;
            }
        }

        async function deletePrazoInterno(id) {
            try {
                const { error } = await supabase
                    .from('prazos_internos')
                    .delete()
                    .eq('id', id);
                return !error;
            } catch (error) {
                console.error('Erro ao excluir prazo interno:', error);
                showAlert('Erro ao excluir prazo!', 'error');
                return false;
            }
        }

        // Audiências
        async function getAudiencias(processoId = null) {
            try {
                let query = supabase
                    .from('calendario_audiencias')
                    .select(`
                        *,
                        processos (numero_processo, clients (name))
                    `)
                    .order('data_audiencia', { ascending: true });

                if (processoId) {
                    query = query.eq('processo_id', processoId);
                }

                const { data, error } = await query;
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao buscar audiências:', error);
                return [];
            }
        }

        async function saveAudiencia(audiencia) {
            try {
                const audienciaData = {
                    processo_id: audiencia.processoId,
                    titulo: audiencia.titulo,
                    descricao: audiencia.descricao,
                    data_audiencia: audiencia.dataAudiencia,
                    local: audiencia.local,
                    tipo_audiencia: audiencia.tipoAudiencia,
                    participantes: audiencia.participantes,
                    resultado: audiencia.resultado,
                    status: audiencia.status
                };

                if (audiencia.id) {
                    const { data, error } = await supabase
                        .from('calendario_audiencias')
                        .update(audienciaData)
                        .eq('id', audiencia.id)
                        .select();
                    if (error) throw error;
                    return data[0];
                } else {
                    const { data, error } = await supabase
                        .from('calendario_audiencias')
                        .insert([audienciaData])
                        .select();
                    if (error) throw error;
                    return data[0];
                }
            } catch (error) {
                console.error('Erro ao salvar audiência:', error);
                return null;
            }
        }

        async function deleteAudiencia(id) {
            try {
                const { error } = await supabase
                    .from('calendario_audiencias')
                    .delete()
                    .eq('id', id);
                return !error;
            } catch (error) {
                console.error('Erro ao excluir audiência:', error);
                return false;
            }
        }

        // --- Sistema de Login ---
        async function handleLogin(e) { 
            e.preventDefault(); 
            const email = document.getElementById('email').value; 
            const password = document.getElementById('password').value; 
            const userType = document.getElementById('userType').value; 
            
            try {
                const { data: users, error } = await supabase
                    .from('usuários')
                    .select('*')
                    .eq('email', email)
                    .eq('password', password)
                    .eq('user_type', userType === 'admin' ? 'admin' : 'client')
                    .eq('status', 'ativo');
                
                if (error) {
                    console.error('Erro no login:', error);
                    showAlert('Erro ao fazer login!', 'error');
                    return;
                }
                
                if (!users || users.length === 0) { 
                    showAlert('Credenciais inválidas ou usuário inativo!', 'error'); 
                    return;
                }
                
                const user = users[0];
                currentUser = user;
                
                // Atualizar último acesso
                await supabase
                    .from('usuários')
                    .update({ last_access: new Date().toISOString() })
                    .eq('id', user.id);
                
                showDashboard(); 
            } catch (error) {
                console.error('Erro no login:', error);
                showAlert('Erro ao fazer login!', 'error');
            }
        }

        // --- DOM Refs ---
        const loginPage = document.getElementById('loginPage'); 
        const adminDashboard = document.getElementById('adminDashboard'); 
        const clientDashboard = document.getElementById('clientDashboard'); 
        const header = document.getElementById('header');
        const loginForm = document.getElementById('loginForm'); 
        const logoutBtn = document.getElementById('logoutBtn'); 
        const userNameDisplay = document.getElementById('userNameDisplay'); 
        const userRole = document.getElementById('userRole');
        const tabs = document.querySelectorAll('.tab');

        // --- Event Listeners ---
        document.addEventListener('DOMContentLoaded', async ()=>{
            console.log('=== INICIANDO SISTEMA MPS ADVOGADOS ===');
            
            // Verificar se há usuário salvo
            const savedUser = localStorage.getItem('currentUser');
            if(savedUser){ 
                try {
                    currentUser = JSON.parse(savedUser);
                    // Verificar se o usuário ainda é válido
                    const { data: users } = await supabase
                        .from('usuários')
                        .select('*')
                        .eq('id', currentUser.id)
                        .eq('status', 'ativo');
                        
                    if (users && users.length > 0) {
                        showDashboard();
                    } else {
                        localStorage.removeItem('currentUser');
                        currentUser = null;
                    }
                } catch (e) {
                    localStorage.removeItem('currentUser');
                    currentUser = null;
                }
            }

            // Configurar eventos
            setupEventListeners();
            
            // Inicializar componentes
            initCalendar();
            
            console.log('Sistema MPS Advogados carregado com sucesso!');
        });

        function setupEventListeners() {
            // Login
            loginForm.addEventListener('submit', handleLogin); 
            logoutBtn.addEventListener('click', handleLogout);
            
            // Botões principais
            document.getElementById('addClientBtn').addEventListener('click', ()=>openClientModal()); 
            document.getElementById('addProcessBtn').addEventListener('click', ()=>openProcessModal()); 
            document.getElementById('addUserBtn').addEventListener('click', ()=>openUserModal());
            document.getElementById('addPrazoBtn').addEventListener('click', ()=>openPrazoModal());
            document.getElementById('addAudienciaBtn').addEventListener('click', ()=>openAudienciaModal());
            
            // Forms
            document.getElementById('clientForm').addEventListener('submit', handleClientSubmit); 
            document.getElementById('processForm').addEventListener('submit', handleProcessSubmit); 
            document.getElementById('userForm').addEventListener('submit', handleUserSubmit); 
            document.getElementById('prazoForm').addEventListener('submit', handlePrazoSubmit);
            document.getElementById('audienciaForm').addEventListener('submit', handleAudienciaSubmit);
            
            const clientProfileForm = document.getElementById('clientProfileForm');
            if(clientProfileForm) {
                clientProfileForm.addEventListener('submit', handleClientProfileSubmit);
            }

            // Buscas
            document.getElementById('clientSearch').addEventListener('input', debounce(loadClientsTable, 300)); 
            document.getElementById('processSearch').addEventListener('input', debounce(loadProcessesTable, 300));
            document.getElementById('prazoSearch').addEventListener('input', debounce(searchPrazos, 300));

            // Calendário
            document.getElementById('calendarView').addEventListener('change', changeCalendarView);

            // Tabs
            tabs.forEach(tab=>tab.addEventListener('click', ()=>{ 
                switchTab(tab.getAttribute('data-tab')); 
            }));

            // Tabs do modal
            document.querySelectorAll('.modal-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabId = tab.getAttribute('data-tab');
                    switchModalTab(tabId);
                });
            });

            // Notificações
            document.getElementById('notificationBtn').addEventListener('click', toggleNotifications);
            
            // Relatórios
            document.getElementById('generateReport').addEventListener('click', generateReports);
            
            // Backup
            document.getElementById('backupFile').addEventListener('change', handleBackupImport);
            
            // Close modals on outside click
            window.addEventListener('click', function(event){ 
                ['clientModal','processModal','userModal','processDetailsModal','prazoModal','audienciaModal'].forEach(id=>{ 
                    const m=document.getElementById(id); 
                    if(event.target===m) {
                        if (id === 'processDetailsModal') closeProcessDetails();
                        else m.classList.remove('active'); 
                    }
                }); 
                
                // Fechar dropdown de notificações ao clicar fora
                if (!event.target.closest('.notifications')) {
                    document.getElementById('notificationDropdown').classList.remove('show');
                }
            });

            // Verificar prazos a cada minuto
            setInterval(checkDeadlines, 60000);
            
            // Configurar eventos do sistema Kanban
            setupKanbanEventListeners();
        }

        // ========== SISTEMA KANBAN ==========

        // Configurar event listeners do Kanban
        function setupKanbanEventListeners() {
            // Filtros rápidos
            document.querySelectorAll('.filter-buttons .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-buttons .btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    const filter = this.getAttribute('data-filter');
                    applyQuickFilter(filter);
                });
            });

            // Alternar visualização
            document.querySelectorAll('.view-toggle .btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.view-toggle .btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentView = this.getAttribute('data-view');
                    switchView(currentView);
                });
            });

            // Filtros avançados
            document.getElementById('toggleAdvancedFilters').addEventListener('click', function() {
                const filters = document.getElementById('advancedFilters');
                filters.style.display = filters.style.display === 'none' ? 'block' : 'none';
                if (filters.style.display === 'block') {
                    loadFilterOptions();
                }
            });

            // Busca em tempo real
            document.getElementById('prazoSearch').addEventListener('input', debounce(searchPrazos, 300));

            // Drag and Drop
            setupDragAndDrop();
        }

        // Inicializar sistema Kanban
        async function initKanbanSystem() {
            await loadKanbanData();
            initCalendarPrazos();
        }

        // Carregar dados para o Kanban
        async function loadKanbanData() {
            try {
                kanbanPrazos = await getPrazosInternos();
                renderKanban();
                renderListView();
                updateCalendarPrazos();
                updateKanbanStats();
            } catch (error) {
                console.error('Erro ao carregar dados do Kanban:', error);
                showAlert('Erro ao carregar prazos!', 'error');
            }
        }

        // Renderizar Kanban
        function renderKanban() {
            const filteredPrazos = filterPrazos(kanbanPrazos);
            
            // Limpar colunas
            ['pendente', 'andamento', 'concluido', 'arquivado'].forEach(status => {
                const column = document.getElementById(`column-${status}`);
                if (column) column.innerHTML = '';
            });

            // Adicionar cards às colunas
            filteredPrazos.forEach(prazo => {
                const card = createKanbanCard(prazo);
                const column = document.getElementById(`column-${prazo.status}`);
                if (column) {
                    column.appendChild(card);
                }
            });

            // Atualizar contadores
            updateColumnCounts();
        }

        // Criar card do Kanban
        function createKanbanCard(prazo) {
            const card = document.createElement('div');
            card.className = `kanban-card ${prazo.prioridade} ${isPrazoVencido(prazo.data_vencimento) ? 'vencido' : ''}`;
            card.setAttribute('draggable', 'true');
            card.setAttribute('data-id', prazo.id);
            card.setAttribute('data-status', prazo.status);
            
            const daysLeft = calculateDaysLeft(prazo.data_vencimento);
            const daysText = getDaysText(daysLeft);
            const priorityColors = {
                'urgente': '#dc3545',
                'alta': '#ff6b6b',
                'media': '#ffd93d',
                'baixa': '#6bcf7f'
            };
            
            card.innerHTML = `
                <div class="kanban-card-header">
                    <div class="kanban-card-title">${prazo.titulo}</div>
                    <span class="kanban-card-priority" style="background: ${priorityColors[prazo.prioridade] || '#6c757d'}; color: white;">
                        ${prazo.prioridade}
                    </span>
                </div>
                
                <div class="kanban-card-body">
                    <div class="kanban-card-desc">${prazo.descricao || 'Sem descrição'}</div>
                    <div class="kanban-card-meta">
                        <span class="kanban-card-meta-item">
                            <i class="fas fa-gavel"></i>
                            <span>${prazo.processos?.numero_processo || 'N/A'}</span>
                        </span>
                        <span class="kanban-card-meta-item">
                            <i class="fas fa-user"></i>
                            <span>${prazo.usuarios?.name || 'N/A'}</span>
                        </span>
                        <span class="kanban-card-meta-item">
                            <i class="fas fa-tag"></i>
                            <span>${prazo.tipo_prazo}</span>
                        </span>
                    </div>
                </div>
                
                <div class="kanban-card-footer">
                    <div class="kanban-card-date">
                        <i class="fas fa-calendar"></i>
                        ${formatDate(prazo.data_vencimento)}
                        <span style="margin-left: 0.5rem; color: ${getDaysColor(daysLeft)}; font-weight: bold;">
                            ${daysText}
                        </span>
                    </div>
                    <div class="kanban-card-actions">
                        <button class="kanban-card-action-btn" onclick="editPrazoInterno(${prazo.id})" title="Editar">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="kanban-card-action-btn" onclick="quickUpdateStatus(${prazo.id}, '${prazo.status === 'concluido' ? 'pendente' : 'concluido'}')" title="${prazo.status === 'concluido' ? 'Reabrir' : 'Concluir'}">
                            <i class="fas fa-${prazo.status === 'concluido' ? 'undo' : 'check'}"></i>
                        </button>
                        <button class="kanban-card-action-btn" onclick="deletePrazoConfirm(${prazo.id})" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
            
            // Adicionar eventos de drag and drop
            card.addEventListener('dragstart', dragStart);
            card.addEventListener('dragend', dragEnd);
            
            return card;
        }

        // Drag and Drop functions
        function setupDragAndDrop() {
            const columns = document.querySelectorAll('.kanban-column-content');
            columns.forEach(col => {
                col.addEventListener('dragover', allowDrop);
                col.addEventListener('drop', drop);
                col.addEventListener('dragenter', dragEnter);
                col.addEventListener('dragleave', dragLeave);
            });
        }

        function allowDrop(e) {
            e.preventDefault();
        }

        function dragEnter(e) {
            e.preventDefault();
            this.classList.add('drag-over');
        }

        function dragLeave() {
            this.classList.remove('drag-over');
        }

        function dragStart(e) {
            e.dataTransfer.setData('text/plain', e.target.getAttribute('data-id'));
            e.target.classList.add('dragging');
            
            // Adicionar efeito de arrasto
            setTimeout(() => {
                e.target.style.display = 'none';
            }, 0);
        }

        function dragEnd(e) {
            e.target.classList.remove('dragging');
            e.target.style.display = 'block';
            
            // Remover classes drag-over de todas as colunas
            document.querySelectorAll('.kanban-column-content').forEach(col => {
                col.classList.remove('drag-over');
            });
        }

        async function drop(e) {
            e.preventDefault();
            const prazoId = e.dataTransfer.getData('text/plain');
            const newStatus = e.target.closest('.kanban-column-content').parentElement.getAttribute('data-status');
            
            // Atualizar status do prazo
            await updatePrazoStatus(prazoId, newStatus);
            
            // Remover classe drag-over
            this.classList.remove('drag-over');
        }

        // Atualizar status do prazo
        async function updatePrazoStatus(prazoId, newStatus) {
            try {
                const prazos = await getPrazosInternos();
                const prazo = prazos.find(p => p.id == prazoId);
                
                if (prazo) {
                    prazo.status = newStatus;
                    const saved = await savePrazoInterno(prazo);
                    
                    if (saved) {
                        showAlert(`Prazo movido para ${newStatus}!`, 'success');
                        await loadKanbanData();
                        
                        // Criar notificação
                        await createNotification({
                            type: 'info',
                            title: 'Prazo Atualizado',
                            message: `Prazo "${prazo.titulo}" foi movido para ${newStatus}`,
                            user_id: currentUser.id
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao atualizar status:', error);
                showAlert('Erro ao atualizar status!', 'error');
            }
        }

        // Atualização rápida de status
        async function quickUpdateStatus(prazoId, newStatus) {
            await updatePrazoStatus(prazoId, newStatus);
        }

        // Renderizar visualização em lista
        function renderListView() {
            const filteredPrazos = filterPrazos(kanbanPrazos);
            const tbody = document.getElementById('prazosTableBody');
            
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            if (filteredPrazos.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" class="empty-state">
                            <i class="fas fa-clock"></i>
                            <p>Nenhum prazo encontrado</p>
                        </td>
                    </tr>
                `;
                return;
            }
            
            filteredPrazos.forEach((prazo, index) => {
                const daysLeft = calculateDaysLeft(prazo.data_vencimento);
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <strong>${prazo.titulo}</strong>
                        <div style="font-size: 0.85rem; color: var(--text-medium); margin-top: 0.25rem;">
                            ${prazo.descricao?.substring(0, 100) || ''}${prazo.descricao?.length > 100 ? '...' : ''}
                        </div>
                    </td>
                    <td>
                        <span class="process-tag">${prazo.processos?.numero_processo || 'N/A'}</span>
                        <div style="font-size: 0.85rem; color: var(--text-medium); margin-top: 0.25rem;">
                            ${prazo.processos?.clients?.name || ''}
                        </div>
                    </td>
                    <td>${prazo.tipo_prazo}</td>
                    <td>
                        <span class="priority-badge priority-${prazo.prioridade}">
                            ${prazo.prioridade}
                        </span>
                    </td>
                    <td>${prazo.usuarios?.name || 'N/A'}</td>
                    <td>
                        ${formatDateTime(prazo.data_vencimento)}
                        <div style="font-size: 0.85rem; color: ${getDaysColor(daysLeft)}; font-weight: bold;">
                            ${getDaysText(daysLeft)}
                        </div>
                    </td>
                    <td>
                        <span class="status-kanban status-${prazo.status}">
                            ${prazo.status}
                        </span>
                    </td>
                    <td>
                        <div style="display: flex; gap: 0.5rem;">
                            <button class="action-btn" onclick="editPrazoInterno(${prazo.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn" onclick="quickUpdateStatus(${prazo.id}, '${prazo.status === 'concluido' ? 'pendente' : 'concluido'}')" title="${prazo.status === 'concluido' ? 'Reabrir' : 'Concluir'}">
                                <i class="fas fa-${prazo.status === 'concluido' ? 'undo' : 'check'}"></i>
                            </button>
                            <button class="action-btn btn-danger" onclick="deletePrazoConfirm(${prazo.id})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
        }

        // Inicializar calendário de prazos
        function initCalendarPrazos() {
            const calendarEl = document.getElementById('calendarPrazos');
            
            if (!calendarEl) return;
            
            calendarPrazos = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                events: function(info, successCallback, failureCallback) {
                    const events = kanbanPrazos.map(prazo => ({
                        id: prazo.id,
                        title: prazo.titulo,
                        start: prazo.data_vencimento,
                        extendedProps: {
                            processo: prazo.processos?.numero_processo,
                            responsavel: prazo.usuarios?.name,
                            tipo: prazo.tipo_prazo,
                            prioridade: prazo.prioridade
                        },
                        backgroundColor: getCalendarEventColor(prazo),
                        borderColor: getCalendarEventColor(prazo),
                        textColor: 'white',
                        classNames: ['fc-event-prazo']
                    }));
                    successCallback(events);
                },
                eventClick: function(info) {
                    editPrazoInterno(info.event.id);
                },
                eventContent: function(arg) {
                    return {
                        html: `
                            <div style="padding: 2px; font-size: 0.85rem;">
                                <div style="font-weight: bold; margin-bottom: 2px;">${arg.event.title}</div>
                                <div style="font-size: 0.75rem; opacity: 0.9;">
                                    ${arg.event.extendedProps.processo || ''}
                                </div>
                            </div>
                        `
                    };
                }
            });
            
            calendarPrazos.render();
        }

        // Atualizar calendário de prazos
        function updateCalendarPrazos() {
            if (calendarPrazos) {
                calendarPrazos.refetchEvents();
            }
        }

        // Alternar entre visualizações
        function switchView(view) {
            document.getElementById('kanbanView').style.display = view === 'kanban' ? 'block' : 'none';
            document.getElementById('listaView').style.display = view === 'lista' ? 'block' : 'none';
            document.getElementById('calendarioView').style.display = view === 'calendario' ? 'block' : 'none';
            
            if (view === 'lista') {
                renderListView();
            } else if (view === 'calendario') {
                updateCalendarPrazos();
            }
        }

        // Filtrar prazos
        function filterPrazos(prazos) {
            let filtered = [...prazos];
            
            // Aplicar filtro rápido
            const activeFilter = document.querySelector('.filter-buttons .btn.active')?.getAttribute('data-filter');
            if (activeFilter) {
                filtered = applyQuickFilterLogic(filtered, activeFilter);
            }
            
            // Aplicar filtros avançados
            if (Object.keys(currentFilters).length > 0) {
                filtered = applyAdvancedFiltersLogic(filtered);
            }
            
            // Aplicar busca
            const searchTerm = document.getElementById('prazoSearch').value.toLowerCase();
            if (searchTerm) {
                filtered = filtered.filter(p => 
                    p.titulo.toLowerCase().includes(searchTerm) ||
                    p.descricao.toLowerCase().includes(searchTerm) ||
                    (p.processos?.numero_processo || '').toLowerCase().includes(searchTerm) ||
                    (p.usuarios?.name || '').toLowerCase().includes(searchTerm)
                );
            }
            
            return filtered;
        }

        // Aplicar filtro rápido
        function applyQuickFilter(filter) {
            currentFilters.quickFilter = filter;
            renderKanban();
            renderListView();
            updateCalendarPrazos();
            updateKanbanStats();
        }

        function applyQuickFilterLogic(prazos, filter) {
            const hoje = new Date();
            const umaSemana = new Date(hoje.getTime() + 7 * 24 * 60 * 60 * 1000);
            
            switch(filter) {
                case 'hoje':
                    return prazos.filter(p => {
                        const data = new Date(p.data_vencimento);
                        return data.toDateString() === hoje.toDateString();
                    });
                case 'semana':
                    return prazos.filter(p => {
                        const data = new Date(p.data_vencimento);
                        return data >= hoje && data <= umaSemana;
                    });
                case 'atrasados':
                    return prazos.filter(p => {
                        const data = new Date(p.data_vencimento);
                        return data < hoje && p.status !== 'concluido';
                    });
                case 'concluidos':
                    return prazos.filter(p => p.status === 'concluido');
                default:
                    return prazos;
            }
        }

        // Carregar opções de filtro
        async function loadFilterOptions() {
            // Carregar responsáveis
            const usuarios = await getUsers();
            const responsavelSelect = document.getElementById('filterResponsavel');
            responsavelSelect.innerHTML = '';
            
            usuarios.filter(u => u.user_type === 'admin').forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                option.textContent = user.name;
                responsavelSelect.appendChild(option);
            });
            
            // Carregar processos
            const processos = await getProcesses();
            const processoSelect = document.getElementById('filterProcesso');
            const currentValue = processoSelect.value;
            processoSelect.innerHTML = '<option value="">Todos os processos</option>';
            
            processos.forEach(proc => {
                const option = document.createElement('option');
                option.value = proc.id;
                option.textContent = `${proc.numero_processo} - ${proc.clients?.name || ''}`;
                processoSelect.appendChild(option);
            });
            
            if (currentValue) {
                processoSelect.value = currentValue;
            }
        }

        // Aplicar filtros avançados
        function aplicarFiltrosAvancados() {
            currentFilters = {};
            
            // Prioridade
            const prioridades = Array.from(document.getElementById('filterPrioridade').selectedOptions).map(o => o.value);
            if (prioridades.length > 0) {
                currentFilters.prioridades = prioridades;
            }
            
            // Tipo
            const tipos = Array.from(document.getElementById('filterTipo').selectedOptions).map(o => o.value);
            if (tipos.length > 0) {
                currentFilters.tipos = tipos;
            }
            
            // Responsável
            const responsaveis = Array.from(document.getElementById('filterResponsavel').selectedOptions).map(o => o.value);
            if (responsaveis.length > 0) {
                currentFilters.responsaveis = responsaveis;
            }
            
            // Processo
            const processo = document.getElementById('filterProcesso').value;
            if (processo) {
                currentFilters.processo = processo;
            }
            
            // Datas
            const dataDe = document.getElementById('filterDataDe').value;
            const dataAte = document.getElementById('filterDataAte').value;
            if (dataDe) currentFilters.dataDe = dataDe;
            if (dataAte) currentFilters.dataAte = dataAte;
            
            // Apenas meus
            if (document.getElementById('filterApenasMeus').checked) {
                currentFilters.apenasMeus = true;
            }
            
            renderKanban();
            renderListView();
            updateCalendarPrazos();
            updateKanbanStats();
            
            showAlert('Filtros aplicados!', 'success');
        }

        function applyAdvancedFiltersLogic(prazos) {
            let filtered = [...prazos];
            
            // Prioridade
            if (currentFilters.prioridades) {
                filtered = filtered.filter(p => currentFilters.prioridades.includes(p.prioridade));
            }
            
            // Tipo
            if (currentFilters.tipos) {
                filtered = filtered.filter(p => currentFilters.tipos.includes(p.tipo_prazo));
            }
            
            // Responsável
            if (currentFilters.responsaveis) {
                filtered = filtered.filter(p => currentFilters.responsaveis.includes(p.responsavel_id.toString()));
            }
            
            // Processo
            if (currentFilters.processo) {
                filtered = filtered.filter(p => p.processo_id == currentFilters.processo);
            }
            
            // Datas
            if (currentFilters.dataDe) {
                const dataDe = new Date(currentFilters.dataDe);
                filtered = filtered.filter(p => new Date(p.data_vencimento) >= dataDe);
            }
            
            if (currentFilters.dataAte) {
                const dataAte = new Date(currentFilters.dataAte);
                dataAte.setHours(23, 59, 59, 999);
                filtered = filtered.filter(p => new Date(p.data_vencimento) <= dataAte);
            }
            
            // Apenas meus
            if (currentFilters.apenasMeus && currentUser) {
                filtered = filtered.filter(p => p.responsavel_id === currentUser.id);
            }
            
            return filtered;
        }

        // Limpar filtros
        function limparFiltrosAvancados() {
            currentFilters = {};
            
            // Resetar controles
            document.getElementById('filterPrioridade').selectedIndex = -1;
            document.getElementById('filterTipo').selectedIndex = -1;
            document.getElementById('filterResponsavel').selectedIndex = -1;
            document.getElementById('filterProcesso').value = '';
            document.getElementById('filterDataDe').value = '';
            document.getElementById('filterDataAte').value = '';
            document.getElementById('filterApenasMeus').checked = false;
            
            renderKanban();
            renderListView();
            updateCalendarPrazos();
            updateKanbanStats();
            
            showAlert('Filtros removidos!', 'success');
        }

        // Buscar prazos
        function searchPrazos() {
            renderKanban();
            renderListView();
            updateCalendarPrazos();
        }

        // Atualizar contadores das colunas
        function updateColumnCounts() {
            const counts = {
                pendente: 0,
                andamento: 0,
                concluido: 0,
                arquivado: 0
            };
            
            kanbanPrazos.forEach(prazo => {
                if (counts.hasOwnProperty(prazo.status)) {
                    counts[prazo.status]++;
                }
            });
            
            Object.keys(counts).forEach(status => {
                const countElement = document.getElementById(`count-${status}`);
                if (countElement) {
                    countElement.textContent = counts[status];
                }
            });
        }

        // Atualizar estatísticas
        function updateKanbanStats() {
            const filteredPrazos = filterPrazos(kanbanPrazos);
            
            // Estatísticas básicas
            document.getElementById('totalPrazos').textContent = filteredPrazos.length;
            
            // Prazos que vencem hoje
            const hoje = new Date();
            const prazosHoje = filteredPrazos.filter(p => {
                const data = new Date(p.data_vencimento);
                return data.toDateString() === hoje.toDateString() && p.status !== 'concluido';
            });
            document.getElementById('prazosHoje').textContent = prazosHoje.length;
            
            // Prazos atrasados
            const prazosAtrasados = filteredPrazos.filter(p => {
                const data = new Date(p.data_vencimento);
                return data < hoje && p.status !== 'concluido';
            });
            document.getElementById('prazosAtrasados').textContent = prazosAtrasados.length;
            
            // Prazos concluídos
            const prazosConcluidos = filteredPrazos.filter(p => p.status === 'concluido');
            document.getElementById('prazosConcluidos').textContent = prazosConcluidos.length;
            
            // Estatísticas avançadas
            const urgentes = filteredPrazos.filter(p => p.prioridade === 'urgente' && p.status !== 'concluido');
            const proximos = filteredPrazos.filter(p => {
                const daysLeft = calculateDaysLeft(p.data_vencimento);
                return daysLeft <= 3 && daysLeft > 0 && p.status !== 'concluido';
            });
            const noPrazo = filteredPrazos.filter(p => {
                const daysLeft = calculateDaysLeft(p.data_vencimento);
                return daysLeft > 3 && p.status !== 'concluido';
            });
            const semPrazo = filteredPrazos.filter(p => !p.data_vencimento && p.status !== 'concluido');
            
            document.getElementById('stat-urgentes').textContent = urgentes.length;
            document.getElementById('stat-proximos').textContent = proximos.length;
            document.getElementById('stat-no-prazo').textContent = noPrazo.length;
            document.getElementById('stat-sem-prazo').textContent = semPrazo.length;
        }

        // Funções auxiliares para textos
        function getDaysText(daysLeft) {
            if (daysLeft === 0) return 'Hoje';
            if (daysLeft === 1) return 'Amanhã';
            if (daysLeft > 1) return `${daysLeft} dias`;
            if (daysLeft === -1) return 'Ontem';
            return `${Math.abs(daysLeft)} dias atrás`;
        }

        function getDaysColor(daysLeft) {
            if (daysLeft < 0) return 'var(--danger)';
            if (daysLeft === 0) return 'var(--warning)';
            if (daysLeft <= 3) return 'var(--warning)';
            return 'var(--success)';
        }

        function getCalendarEventColor(prazo) {
            if (isPrazoVencido(prazo.data_vencimento)) return '#dc3545';
            
            const colors = {
                'urgente': '#dc3545',
                'alta': '#ff6b6b',
                'media': '#ffd93d',
                'baixa': '#6bcf7f'
            };
            
            return colors[prazo.prioridade] || '#6c757d';
        }

        // Funções de ação em massa
        async function moverTodosParaAndamento() {
            if (!confirm('Mover todos os prazos pendentes para "Em Andamento"?')) return;
            
            try {
                const prazosPendentes = kanbanPrazos.filter(p => p.status === 'pendente');
                
                for (const prazo of prazosPendentes) {
                    prazo.status = 'andamento';
                    await savePrazoInterno(prazo);
                }
                
                showAlert(`${prazosPendentes.length} prazos movidos para "Em Andamento"!`, 'success');
                await loadKanbanData();
            } catch (error) {
                console.error('Erro ao mover prazos:', error);
                showAlert('Erro ao mover prazos!', 'error');
            }
        }

        async function limparConcluidos() {
            if (!confirm('Excluir todos os prazos concluídos?')) return;
            
            try {
                const prazosConcluidos = kanbanPrazos.filter(p => p.status === 'concluido');
                
                for (const prazo of prazosConcluidos) {
                    await deletePrazoInterno(prazo.id);
                }
                
                showAlert(`${prazosConcluidos.length} prazos concluídos removidos!`, 'success');
                await loadKanbanData();
            } catch (error) {
                console.error('Erro ao limpar prazos:', error);
                showAlert('Erro ao limpar prazos!', 'error');
            }
        }

        async function restaurarArquivados() {
            if (!confirm('Restaurar todos os prazos arquivados para "Pendente"?')) return;
            
            try {
                const prazosArquivados = kanbanPrazos.filter(p => p.status === 'arquivado');
                
                for (const prazo of prazosArquivados) {
                    prazo.status = 'pendente';
                    await savePrazoInterno(prazo);
                }
                
                showAlert(`${prazosArquivados.length} prazos restaurados!`, 'success');
                await loadKanbanData();
            } catch (error) {
                console.error('Erro ao restaurar prazos:', error);
                showAlert('Erro ao restaurar prazos!', 'error');
            }
        }

        // Confirmar exclusão de prazo
        async function deletePrazoConfirm(id) {
            if (confirm('Tem certeza que deseja excluir este prazo?')) {
                const success = await deletePrazoInterno(id);
                if (success) {
                    await loadKanbanData();
                    showAlert('Prazo excluído com sucesso!', 'success');
                } else {
                    showAlert('Erro ao excluir prazo!', 'error');
                }
            }
        }

        // Gerar relatório de prazos
        function gerarRelatorioPrazos() {
            const filteredPrazos = filterPrazos(kanbanPrazos);
            
            if (filteredPrazos.length === 0) {
                showAlert('Nenhum prazo para exportar!', 'warning');
                return;
            }
            
            const data = filteredPrazos.map(prazo => ({
                'Título': prazo.titulo,
                'Processo': prazo.processos?.numero_processo || 'N/A',
                'Cliente': prazo.processos?.clients?.name || 'N/A',
                'Tipo': prazo.tipo_prazo,
                'Prioridade': prazo.prioridade,
                'Responsável': prazo.usuarios?.name || 'N/A',
                'Vencimento': formatDateTime(prazo.data_vencimento),
                'Status': prazo.status,
                'Dias Restantes': calculateDaysLeft(prazo.data_vencimento),
                'Descrição': prazo.descricao || ''
            }));
            
            // Converter para CSV
            const headers = Object.keys(data[0]);
            const csv = [
                headers.join(','),
                ...data.map(row => headers.map(header => `"${row[header]}"`).join(','))
            ].join('\n');
            
            // Criar e baixar arquivo
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_prazos_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Relatório exportado com sucesso!', 'success');
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Funções Principais ---
        function handleLogout(){ 
            currentUser=null; 
            localStorage.removeItem('currentUser');
            showLogin(); 
        }

        function showLogin(){ 
            loginPage.style.display='flex'; 
            adminDashboard.style.display='none'; 
            clientDashboard.style.display='none'; 
            header.style.display='none'; 
            loginForm.reset(); 
        }

        async function showDashboard(){ 
            loginPage.style.display='none'; 
            header.style.display='block'; 
            userNameDisplay.textContent=currentUser.name; 
            userRole.textContent = currentUser.user_type==='admin'?'Administrador':'Cliente'; 
            
            // Salvar usuário no localStorage para persistência
            localStorage.setItem('currentUser', JSON.stringify(currentUser));
            
            if(currentUser.user_type==='admin'){ 
                adminDashboard.style.display='block'; 
                clientDashboard.style.display='none'; 
                await loadAdminData(); 
            } else { 
                adminDashboard.style.display='none'; 
                clientDashboard.style.display='block'; 
                await loadClientData(); 
            } 
            await loadNotifications();
            await checkDeadlines();
        }

        function switchTab(tabId){ 
            document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); 
            document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); 
            const tab = document.querySelector(`.tab[data-tab="${tabId}"]`); 
            if(tab) tab.classList.add('active'); 
            const content=document.getElementById(`${tabId}-tab`) || document.getElementById(`${tabId}`); 
            if(content) content.classList.add('active'); 
            
            if (tabId === 'reports') {
                generateReports();
            } else if (tabId === 'calendar') {
                calendar.render();
            } else if (tabId === 'prazos') {
                // Inicializar sistema Kanban
                setTimeout(() => {
                    if (!calendarPrazos) {
                        initKanbanSystem();
                    } else {
                        loadKanbanData();
                    }
                }, 100);
            }
        }

        function switchModalTab(tabId) {
            document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
            
            document.querySelector(`.modal-tab[data-tab="${tabId}"]`).classList.add('active');
            document.getElementById(`${tabId}-tab`).classList.add('active');
            
            // Recarregar conteúdo específico da aba
            if (tabId === 'prazos' && currentProcessId) {
                loadProcessPrazos(currentProcessId);
            } else if (tabId === 'financial' && currentProcessId) {
                loadFinancialData(currentProcessId);
            }
        }

        // --- Notificações ---
        async function loadNotifications() {
            const notifications = await getNotifications();
            const unreadCount = notifications.filter(n => !n.read).length;
            const badge = document.getElementById('notificationBadge');
            const list = document.getElementById('notificationList');
            
            if (unreadCount > 0) {
                badge.style.display = 'flex';
                badge.textContent = unreadCount;
            } else {
                badge.style.display = 'none';
            }
            
            list.innerHTML = '';
            
            if (notifications.length === 0) {
                list.innerHTML = '<div class="notification-item" style="text-align: center; color: var(--text-medium);">Nenhuma notificação</div>';
                return;
            }
            
            notifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
            
            notifications.forEach(notification => {
                const item = document.createElement('div');
                item.className = `notification-item ${notification.read ? '' : 'unread'}`;
                item.innerHTML = `
                    <div class="notification-title">${notification.title}</div>
                    <div class="notification-message">${notification.message}</div>
                    <div class="notification-time">${formatDateTime(notification.created_at)}</div>
                `;
                item.addEventListener('click', () => markNotificationAsRead(notification.id));
                list.appendChild(item);
            });
        }

        function toggleNotifications() {
            const dropdown = document.getElementById('notificationDropdown');
            dropdown.classList.toggle('show');
        }

        async function markAllNotificationsAsRead() {
            const notifications = await getNotifications();
            for (const notification of notifications) {
                if (notification.user_id === currentUser.id && !notification.read) {
                    await markNotificationAsRead(notification.id);
                }
            }
            loadNotifications();
        }

        async function createNotification(notificationData) {
            const notification = {
                ...notificationData,
                read: false,
                user_id: currentUser.id,
                created_at: new Date().toISOString()
            };
            await saveNotification(notification);
            loadNotifications();
        }

        // --- Sistema de Prazos ---
        async function checkDeadlines() {
            const prazos = await getPrazosInternos();
            const hoje = new Date();
            const warningDate = new Date();
            warningDate.setDate(hoje.getDate() + 7);
            
            for (const prazo of prazos) {
                if (prazo.data_vencimento && prazo.status === 'pendente') {
                    const deadline = new Date(prazo.data_vencimento);
                    if (deadline <= warningDate && deadline >= hoje) {
                        await createNotification({
                            type: 'warning',
                            title: 'Prazo próximo',
                            message: `Prazo: ${prazo.titulo} vence em ${formatDate(prazo.data_vencimento)}`,
                            user_id: prazo.responsavel_id
                        });
                    }
                }
            }
            
            // Atualizar estatísticas
            if (currentUser && currentUser.user_type === 'admin') {
                updateDashboardStats();
            }
        }

        // Aplicar template de prazo
        function applyPrazoTemplate(templateType) {
            if (!templatesPrazos[templateType]) return;
            
            const template = templatesPrazos[templateType];
            document.getElementById('prazoTitulo').value = template.titulo;
            document.getElementById('prazoTipo').value = template.tipo;
            document.getElementById('prazoPrioridade').value = template.prioridade;
            document.getElementById('prazoDescricao').value = template.descricao;
            
            // Calcular data de vencimento padrão
            const vencimento = new Date();
            switch(templateType) {
                case 'contestacao':
                    vencimento.setDate(vencimento.getDate() + 15);
                    break;
                case 'recurso':
                    vencimento.setDate(vencimento.getDate() + 10);
                    break;
                case 'audiencia':
                    vencimento.setDate(vencimento.getDate() + 2);
                    break;
                default:
                    vencimento.setDate(vencimento.getDate() + 7);
            }
            
            document.getElementById('prazoVencimento').value = formatDateTimeForInput(vencimento);
            
            showAlert(`Template "${template.titulo}" aplicado!`, 'success');
        }

        // Calcular dias restantes
        function calculateDaysLeft(dataVencimento) {
            if (!dataVencimento) return 999; // Sem prazo definido
            const hoje = new Date();
            const vencimento = new Date(dataVencimento);
            const diffTime = vencimento - hoje;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // Verificar se prazo está vencido
        function isPrazoVencido(dataVencimento) {
            return calculateDaysLeft(dataVencimento) < 0;
        }

        // --- Calendário ---
        function initCalendar() {
            const calendarEl = document.getElementById('calendar');
            
            calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'pt-br',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listMonth'
                },
                events: async function(info, successCallback, failureCallback) {
                    try {
                        const audiencias = await getAudiencias();
                        const events = audiencias.map(audiencia => ({
                            id: audiencia.id,
                            title: audiencia.titulo,
                            start: audiencia.data_audiencia,
                            extendedProps: {
                                processo: audiencia.processos?.numero_processo,
                                local: audiencia.local,
                                tipo: audiencia.tipo_audiencia
                            },
                            backgroundColor: getEventColor(audiencia.tipo_audiencia)
                        }));
                        successCallback(events);
                    } catch (error) {
                        failureCallback(error);
                    }
                },
                eventClick: function(info) {
                    openAudienciaModal(info.event.id);
                },
                dateClick: function(info) {
                    // Abrir modal para criar nova audiência na data clicada
                    openAudienciaModal(null, info.dateStr);
                }
            });
            
            calendar.render();
        }

        function changeCalendarView() {
            const view = document.getElementById('calendarView').value;
            calendar.changeView(view);
        }

        function getEventColor(tipoAudiencia) {
            const colors = {
                'inicial': '#3498db',
                'conciliacao': '#2ecc71',
                'instrucao': '#e74c3c',
                'julgamento': '#f39c12',
                'outra': '#9b59b6'
            };
            return colors[tipoAudiencia] || '#95a5a6';
        }

        // --- Admin data load ---
        async function loadAdminData(){ 
            await loadClientsTable(); 
            await loadProcessesTable(); 
            await loadUsersTable(); 
            await loadKanbanData();
            await updateDashboardStats();
        }

        async function updateDashboardStats() {
            try {
                const processes = await getProcesses();
                const clients = await getClients();
                const prazos = await getPrazosInternos();
                const audiencias = await getAudiencias();
                const financials = await getFinancials();
                
                const hoje = new Date();
                const prazosProximos = prazos.filter(p => {
                    const data = new Date(p.data_vencimento);
                    const umaSemana = new Date(hoje.getTime() + 7 * 24 * 60 * 60 * 1000);
                    return data >= hoje && data <= umaSemana && p.status === 'pendente';
                });
                
                const audienciasHoje = audiencias.filter(a => {
                    const data = new Date(a.data_audiencia);
                    return data.toDateString() === hoje.toDateString();
                });
                
                const processosAndamento = processes.filter(p => p.status === 'andamento').length;
                
                // CÁLCULO ATUALIZADO: Apenas honorários pagos são receita
                const honorariosPagos = financials
                    .filter(f => f.type === 'honorario' && f.status === 'pago')
                    .reduce((sum, f) => sum + f.value, 0);
                
                document.getElementById('totalProcesses').textContent = processes.length;
                document.getElementById('activeClients').textContent = clients.filter(c => c.status === 'ativo').length;
                document.getElementById('prazosProximos').textContent = prazosProximos.length;
                document.getElementById('audienciasHoje').textContent = audienciasHoje.length;
                document.getElementById('processosAndamento').textContent = processosAndamento;
                document.getElementById('receitaTotal').textContent = `R$ ${honorariosPagos.toLocaleString('pt-BR')}`;
            } catch (error) {
                console.error('Erro ao atualizar estatísticas:', error);
            }
        }

        async function loadClientsTable(){ 
            try {
                const clients = await getClients(); 
                const search = document.getElementById('clientSearch').value.toLowerCase(); 
                const filtered = clients.filter(c=> 
                    c.name.toLowerCase().includes(search) || 
                    c.email.toLowerCase().includes(search) || 
                    (c.cpf||'').includes(search)
                ); 
                const tbody=document.getElementById('clientsTableBody'); 
                tbody.innerHTML=''; 
                
                if (filtered.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-users"></i>
                                <p>Nenhum cliente encontrado</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                filtered.forEach(client=>{ 
                    const tr=document.createElement('tr'); 
                    tr.innerHTML = `
                        <td>${client.name}</td>
                        <td>${client.email}</td>
                        <td>${client.phone||''}</td>
                        <td>${client.cpf||''}</td>
                        <td><span class="status-badge ${client.status==='ativo'?'status-andamento':'status-arquivado'}">${client.status==='ativo'?'Ativo':'Inativo'}</span></td>
                        <td>
                            <button class="action-btn" onclick="editClient(${client.id})" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="action-btn btn-danger" onclick="deleteClientConfirm(${client.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    `; 
                    tbody.appendChild(tr); 
                }); 
                await populateUserClientSelect(); 
            } catch (error) {
                console.error('Erro ao carregar clients:', error);
                showAlert('Erro ao carregar clients!', 'error');
            }
        }

        async function loadProcessesTable(){ 
            try {
                const processes = await getProcesses(); 
                const search = document.getElementById('processSearch').value.toLowerCase(); 
                const filtered = processes.filter(p=> 
                    (p.numero_processo||'').toLowerCase().includes(search) || 
                    (p.descricao||'').toLowerCase().includes(search)
                ); 
                const tbody=document.getElementById('processesTableBody'); 
                tbody.innerHTML=''; 
                
                if (filtered.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="empty-state">
                                <i class="fas fa-gavel"></i>
                                <p>Nenhum processo encontrado</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                // Obter prazos para cada processo
                const prazos = await getPrazosInternos();
                
                filtered.forEach(process=>{ 
                    const client = process.clients; 
                    const processPrazos = prazos.filter(p => p.processo_id === process.id && p.status === 'pendente');
                    const prazosCount = processPrazos.length;
                    const prazosVencidos = processPrazos.filter(p => isPrazoVencido(p.data_vencimento)).length;
                    
                    const row=document.createElement('tr'); 
                    row.innerHTML = `
                        <td>${process.numero_processo}</td>
                        <td>${client?client.name:'N/A'}</td>
                        <td>${process.tipo_processo}</td>
                        <td><span class="status-badge status-${process.status}">${getStatusText(process.status)}</span></td>
                        <td>${formatDate(process.data_abertura)}</td>
                        <td>${process.advogados ? process.advogados.name : 'N/A'}</td>
                        <td>
                            ${prazosCount > 0 ? `
                                <span style="color: ${prazosVencidos > 0 ? 'var(--danger)' : 'var(--warning)'}; font-weight: bold;">
                                    ${prazosCount} ${prazosVencidos > 0 ? `(${prazosVencidos} vencidos)` : ''}
                                </span>
                            ` : '<span style="color: var(--text-medium);">Nenhum</span>'}
                        </td>
                        <td>
                            <button class="action-btn" onclick="editProcess(${process.id})" title="Editar"><i class="fas fa-edit"></i></button>
                            <button class="action-btn" onclick="viewProcess(${process.id})" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
                            <button class="action-btn btn-danger" onclick="deleteProcessConfirm(${process.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                        </td>
                    `; 
                    tbody.appendChild(row); 
                }); 
            } catch (error) {
                console.error('Erro ao carregar processos:', error);
                showAlert('Erro ao carregar processos!', 'error');
            }
        }

        async function loadUsersTable(){ 
            try {
                const users = await getUsers(); 
                const tbody=document.getElementById('usersTableBody'); 
                tbody.innerHTML=''; 
                
                if (users.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="empty-state">
                                <i class="fas fa-user"></i>
                                <p>Nenhum usuário encontrado</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                users.forEach(user=>{ 
                    const clientName = user.client_id ? (user.clients?.name || 'N/A') : '-'; 
                    const tr=document.createElement('tr'); 
                    tr.innerHTML = `
                        <td>${user.name}</td>
                        <td>${user.email}</td>
                        <td>${user.user_type==='admin'?'Administrador':'Cliente'}</td>
                        <td>${clientName}</td>
                        <td><span class="status-badge ${user.status==='ativo'?'status-andamento':'status-arquivado'}">${user.status==='ativo'?'Ativo':'Inativo'}</span></td>
                        <td>${user.last_access?formatDate(user.last_access):'-'}</td>
                        <td>
                            <button class="action-btn" onclick="editUser(${user.id})" title="Editar"><i class="fas fa-edit"></i></button>
                            ${user.id!==currentUser?.id?`<button class="action-btn btn-danger" onclick="deleteUserConfirm(${user.id})" title="Excluir"><i class="fas fa-trash"></i></button>`:''}
                        </td>
                    `; 
                    tbody.appendChild(tr); 
                }); 
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                showAlert('Erro ao carregar usuários!', 'error');
            }
        }

        // --- Client data load ---
        async function loadClientData(){ 
            await loadClientProcessesTable(); 
            await loadClientPrazosGrid();
            await loadClientDocumentsTable(); 
            await loadClientProfile(); 
        }

        async function loadClientProcessesTable(){ 
            try {
                const processes = await getProcesses(); 
                const tbody=document.getElementById('clientProcessesTableBody'); 
                tbody.innerHTML=''; 
                if(!currentUser?.client_id) return; 
                const clientProcesses = processes.filter(p=> p.cliente_id === currentUser.client_id); 
                
                if (clientProcesses.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" class="empty-state">
                                <i class="fas fa-gavel"></i>
                                <p>Nenhum processo encontrado</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                clientProcesses.forEach(process=>{ 
                    const tr=document.createElement('tr'); 
                    tr.innerHTML = `
                        <td>${process.numero_processo}</td>
                        <td>${process.tipo_processo}</td>
                        <td><span class="status-badge status-${process.status}">${getStatusText(process.status)}</span></td>
                        <td>${formatDate(process.data_abertura)}</td>
                        <td>${process.advogados ? process.advogados.name : 'N/A'}</td>
                        <td>
                            <button class="action-btn" onclick="viewProcess(${process.id})" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
                        </td>
                    `; 
                    tbody.appendChild(tr); 
                }); 
            } catch (error) {
                console.error('Erro ao carregar processos do cliente:', error);
                showAlert('Erro ao carregar processos!', 'error');
            }
        }

        async function loadClientPrazosGrid() {
            try {
                if (!currentUser?.client_id) return;
                
                const processes = await getProcesses();
                const clientProcesses = processes.filter(p => p.cliente_id === currentUser.client_id);
                const processIds = clientProcesses.map(p => p.id);
                
                const prazos = await getPrazosInternos();
                const clientPrazos = prazos.filter(p => 
                    processIds.includes(p.processo_id) && p.visivel_cliente
                );
                
                const grid = document.getElementById('clientPrazosGrid');
                grid.innerHTML = '';
                
                if (clientPrazos.length === 0) {
                    grid.innerHTML = `
                        <div class="empty-state" style="grid-column: 1 / -1;">
                            <i class="fas fa-clock"></i>
                            <p>Nenhum prazo visível</p>
                        </div>
                    `;
                    return;
                }
                
                clientPrazos.forEach(prazo => {
                    const card = document.createElement('div');
                    card.className = `prazo-card ${prazo.prioridade}`;
                    
                    const daysLeft = calculateDaysLeft(prazo.data_vencimento);
                    const daysText = daysLeft === 0 ? 'Hoje' : 
                                    daysLeft === 1 ? '1 dia' : 
                                    daysLeft > 0 ? `${daysLeft} dias` : 
                                    `Vencido há ${Math.abs(daysLeft)} dias`;
                    
                    card.innerHTML = `
                        <div class="prazo-header">
                            <div>
                                <div class="prazo-title">${prazo.titulo}</div>
                                <div class="prazo-desc">${prazo.descricao}</div>
                            </div>
                            <span class="priority-badge priority-${prazo.prioridade}">${prazo.prioridade}</span>
                        </div>
                        <div class="prazo-meta">
                            <span><strong>Processo:</strong> ${prazo.processos?.numero_processo || 'N/A'}</span>
                            <span><strong>Vence:</strong> ${formatDate(prazo.data_vencimento)}</span>
                        </div>
                        <div class="prazo-meta">
                            <span><strong>Status:</strong> ${prazo.status}</span>
                            <span style="color: ${daysLeft <= 3 ? 'var(--danger)' : daysLeft <= 7 ? 'var(--warning)' : 'var(--success)'}">
                                ${daysText}
                            </span>
                        </div>
                    `;
                    
                    grid.appendChild(card);
                });
            } catch (error) {
                console.error('Erro ao carregar prazos do cliente:', error);
                showAlert('Erro ao carregar prazos!', 'error');
            }
        }

        async function loadClientDocumentsTable(){ 
            try {
                const documents = await getDocuments(); 
                const processes = await getProcesses(); 
                const clientProcesses = processes.filter(p=> p.cliente_id === currentUser.client_id); 
                const clientDocuments = documents.filter(d=> clientProcesses.some(p=>p.id===d.processo_id)); 
                const tbody=document.getElementById('clientDocumentsTableBody'); 
                tbody.innerHTML=''; 
                
                if (clientDocuments.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="5" class="empty-state">
                                <i class="fas fa-file"></i>
                                <p>Nenhum documento encontrado</p>
                            </td>
                        </tr>
                    `;
                    return;
                }
                
                clientDocuments.forEach(doc=>{ 
                    const proc = processes.find(p=>p.id===doc.processo_id); 
                    const tr=document.createElement('tr'); 
                    tr.innerHTML = `
                        <td>${doc.name}</td>
                        <td>${proc?proc.numero_processo:'N/A'}</td>
                        <td>${formatDate(doc.upload_date)}</td>
                        <td>${doc.type}</td>
                        <td>
                            <button class="action-btn" title="Download"><i class="fas fa-download"></i></button>
                            <button class="action-btn" title="Visualizar"><i class="fas fa-eye"></i></button>
                        </td>
                    `; 
                    tbody.appendChild(tr); 
                }); 
            } catch (error) {
                console.error('Erro ao carregar documentos:', error);
                showAlert('Erro ao carregar documentos!', 'error');
            }
        }

        async function loadClientProfile(){ 
            try {
                const clients = await getClients(); 
                const client = clients.find(c=> c.id === currentUser.client_id); 
                if(client){ 
                    document.getElementById('clientProfileName').value = client.name; 
                    document.getElementById('clientProfileEmail').value = client.email; 
                    document.getElementById('clientProfilePhone').value = client.phone; 
                    document.getElementById('clientProfileCPF').value = client.cpf; 
                    document.getElementById('clientProfileAddress').value = client.address; 
                } 
            } catch (error) {
                console.error('Erro ao carregar perfil:', error);
            }
        }

        // --- Modais open/close ---
        async function openClientModal(id=null){ 
            const modal=document.getElementById('clientModal'); 
            const title=document.getElementById('clientModalTitle'); 
            const form=document.getElementById('clientForm'); 
            if(id){ 
                title.textContent='Editar Cliente'; 
                const clients = await getClients();
                const client = clients.find(c=>c.id===id); 
                if(client){ 
                    document.getElementById('clientId').value = client.id; 
                    document.getElementById('clientName').value = client.name; 
                    document.getElementById('clientEmail').value = client.email; 
                    document.getElementById('clientPhone').value = client.phone; 
                    document.getElementById('clientCPF').value = client.cpf; 
                    document.getElementById('clientAddress').value = client.address || ''; 
                    document.getElementById('clientStatus').value = client.status; 
                } 
            } else { 
                title.textContent='Adicionar Cliente'; 
                form.reset(); 
                document.getElementById('clientId').value=''; 
            } 
            modal.classList.add('active'); 
        }

        function closeClientModal(){ 
            document.getElementById('clientModal').classList.remove('active'); 
        }

        async function openProcessModal(id=null){ 
            const modal=document.getElementById('processModal'); 
            const title=document.getElementById('processModalTitle'); 
            const form=document.getElementById('processForm'); 
            const clientSelect=document.getElementById('processClient'); 
            
            // Carregar clientes
            const clients = await getClients();
            clientSelect.innerHTML = '<option value="">Selecione um cliente</option>'; 
            clients.filter(c=>c.status==='ativo').forEach(c=>{ 
                const opt=document.createElement('option'); 
                opt.value=c.id; 
                opt.textContent=c.name; 
                clientSelect.appendChild(opt); 
            }); 
            
            // Carregar advogados
            const lawyers = await getLawyers();
            const lawyerSelect = document.getElementById('processLawyer');
            lawyerSelect.innerHTML = '<option value="">Selecione o advogado</option>';
            lawyers.forEach(lawyer => {
                const opt = document.createElement('option');
                opt.value = lawyer.name;
                opt.textContent = lawyer.name;
                lawyerSelect.appendChild(opt);
            });
            
            if(id){ 
                title.textContent='Editar Processo'; 
                const processes = await getProcesses();
                const proc = processes.find(p=>p.id===id); 
                if(proc){ 
                    document.getElementById('processId').value=proc.id; 
                    document.getElementById('processNumber').value=proc.numero_processo; 
                    document.getElementById('processClient').value=proc.cliente_id; 
                    document.getElementById('processType').value=proc.tipo_processo; 
                    document.getElementById('processStatus').value=proc.status; 
                    document.getElementById('processLawyer').value=proc.advogados?.name || ''; 
                    document.getElementById('processStartDate').value=proc.data_abertura; 
                    document.getElementById('processDeadline').value=proc.prazo_final || ''; 
                    document.getElementById('processDescription').value=proc.descricao; 
                } 
            } else { 
                title.textContent='Adicionar Processo'; 
                form.reset(); 
                document.getElementById('processId').value=''; 
                document.getElementById('processStartDate').valueAsDate=new Date(); 
            } 
            modal.classList.add('active'); 
        }

        function closeProcessModal(){ 
            document.getElementById('processModal').classList.remove('active'); 
        }

        async function openUserModal(id=null){ 
            const modal=document.getElementById('userModal'); 
            const title=document.getElementById('userModalTitle'); 
            const form=document.getElementById('userForm'); 
            await populateUserClientSelect(); 
            if(id){ 
                title.textContent='Editar Usuário'; 
                const users = await getUsers();
                const user = users.find(u=>u.id===id); 
                if(user){ 
                    document.getElementById('userId').value=user.id; 
                    document.getElementById('userNameInput').value=user.name; 
                    document.getElementById('userEmail').value=user.email; 
                    document.getElementById('userPassword').value=user.password; 
                    document.getElementById('userTypeModal').value=user.user_type; 
                    document.getElementById('userStatus').value=user.status; 
                    document.getElementById('userClientSelect').value = user.client_id || ''; 
                } 
            } else { 
                title.textContent='Adicionar Usuário'; 
                form.reset(); 
                document.getElementById('userId').value=''; 
            } 
            modal.classList.add('active'); 
        }

        function closeUserModal(){ 
            document.getElementById('userModal').classList.remove('active'); 
        }

        // Modais de Prazos e Audiências
        async function openPrazoModal(id=null, processoId=null, templateType=null, defaultStatus=null) {
            const modal = document.getElementById('prazoModal');
            const title = document.getElementById('prazoModalTitle');
            const form = document.getElementById('prazoForm');
            
            // Carregar processos
            const processos = await getProcesses();
            const processoSelect = document.getElementById('prazoProcesso');
            processoSelect.innerHTML = '<option value="">Selecione um processo</option>';
            processos.forEach(proc => {
                const opt = document.createElement('option');
                opt.value = proc.id;
                opt.textContent = `${proc.numero_processo} - ${proc.clients?.name || 'N/A'}`;
                processoSelect.appendChild(opt);
            });
            
            // Carregar responsáveis
            const usuarios = await getUsers();
            const responsavelSelect = document.getElementById('prazoResponsavel');
            responsavelSelect.innerHTML = '<option value="">Selecione o responsável</option>';
            usuarios.filter(u => u.user_type === 'admin').forEach(user => {
                const opt = document.createElement('option');
                opt.value = user.id;
                opt.textContent = user.name;
                responsavelSelect.appendChild(opt);
            });
            
            if (id) {
                title.textContent = 'Editar Prazo';
                const prazos = await getPrazosInternos();
                const prazo = prazos.find(p => p.id === id);
                if (prazo) {
                    document.getElementById('prazoId').value = prazo.id;
                    document.getElementById('prazoTitulo').value = prazo.titulo;
                    document.getElementById('prazoProcesso').value = prazo.processo_id;
                    document.getElementById('prazoTipo').value = prazo.tipo_prazo;
                    document.getElementById('prazoPrioridade').value = prazo.prioridade;
                    document.getElementById('prazoVencimento').value = formatDateTimeForInput(prazo.data_vencimento);
                    document.getElementById('prazoResponsavel').value = prazo.responsavel_id;
                    document.getElementById('prazoDescricao').value = prazo.descricao;
                    document.getElementById('prazoVisivelCliente').checked = prazo.visivel_cliente;
                }
            } else {
                title.textContent = 'Adicionar Prazo';
                form.reset();
                document.getElementById('prazoId').value = '';
                
                // Preencher com template se fornecido
                if (templateType && templatesPrazos[templateType]) {
                    const template = templatesPrazos[templateType];
                    document.getElementById('prazoTitulo').value = template.titulo;
                    document.getElementById('prazoTipo').value = templateType;
                    document.getElementById('prazoPrioridade').value = template.prioridade;
                    document.getElementById('prazoDescricao').value = template.descricao;
                    
                    // Calcular data de vencimento
                    const vencimento = new Date();
                    vencimento.setDate(vencimento.getDate() + (templateType === 'contestacao' ? 15 : templateType === 'recurso' ? 10 : templateType === 'audiencia' ? 2 : 7));
                    document.getElementById('prazoVencimento').value = formatDateTimeForInput(vencimento);
                }
                
                // Preencher processo se fornecido
                if (processoId) {
                    document.getElementById('prazoProcesso').value = processoId;
                }
                
                // Definir status padrão
                if (defaultStatus) {
                    // O status é gerenciado pelo Kanban, não pelo modal
                }
                
                // Data padrão: 7 dias a partir de hoje
                const defaultDate = new Date();
                defaultDate.setDate(defaultDate.getDate() + 7);
                document.getElementById('prazoVencimento').value = formatDateTimeForInput(defaultDate);
            }
            
            modal.classList.add('active');
        }

        function closePrazoModal() {
            document.getElementById('prazoModal').classList.remove('active');
        }

        async function openAudienciaModal(id=null, data=null) {
            const modal = document.getElementById('audienciaModal');
            const title = document.getElementById('audienciaModalTitle');
            const form = document.getElementById('audienciaForm');
            
            // Carregar processos
            const processos = await getProcesses();
            const processoSelect = document.getElementById('audienciaProcesso');
            processoSelect.innerHTML = '<option value="">Selecione um processo</option>';
            processos.forEach(proc => {
                const opt = document.createElement('option');
                opt.value = proc.id;
                opt.textContent = `${proc.numero_processo} - ${proc.clients?.name || 'N/A'}`;
                processoSelect.appendChild(opt);
            });
            
            if (id) {
                title.textContent = 'Editar Audiência';
                const audiencias = await getAudiencias();
                const audiencia = audiencias.find(a => a.id === id);
                if (audiencia) {
                    document.getElementById('audienciaId').value = audiencia.id;
                    document.getElementById('audienciaTitulo').value = audiencia.titulo;
                    document.getElementById('audienciaProcesso').value = audiencia.processo_id;
                    document.getElementById('audienciaData').value = formatDateTimeForInput(audiencia.data_audiencia);
                    document.getElementById('audienciaTipo').value = audiencia.tipo_audiencia;
                    document.getElementById('audienciaLocal').value = audiencia.local || '';
                    document.getElementById('audienciaParticipantes').value = audiencia.participantes || '';
                    document.getElementById('audienciaObservacoes').value = audiencia.descricao || '';
                }
            } else {
                title.textContent = 'Agendar Audiência';
                form.reset();
                document.getElementById('audienciaId').value = '';
                
                // Preencher data se fornecida
                if (data) {
                    document.getElementById('audienciaData').value = data + 'T09:00';
                } else {
                    // Data padrão: próxima segunda-feira 09:00
                    const nextMonday = new Date();
                    nextMonday.setDate(nextMonday.getDate() + (1 + 7 - nextMonday.getDay()) % 7);
                    nextMonday.setHours(9, 0, 0, 0);
                    document.getElementById('audienciaData').value = formatDateTimeForInput(nextMonday);
                }
            }
            
            modal.classList.add('active');
        }

        function closeAudienciaModal() {
            document.getElementById('audienciaModal').classList.remove('active');
        }

        // --- Form handlers ---
        async function handleClientSubmit(e){ 
            e.preventDefault(); 
            const client = { 
                id: document.getElementById('clientId').value ? parseInt(document.getElementById('clientId').value) : null, 
                name: document.getElementById('clientName').value, 
                email: document.getElementById('clientEmail').value, 
                phone: document.getElementById('clientPhone').value, 
                cpf: document.getElementById('clientCPF').value, 
                address: document.getElementById('clientAddress').value, 
                status: document.getElementById('clientStatus').value 
            }; 
            const saved = await saveClient(client); 
            if (saved) {
                await loadClientsTable(); 
                closeClientModal(); 
                showAlert('Cliente salvo com sucesso!','success'); 
                
                // Link automático com usuário de mesmo email
                const users = await getUsers(); 
                const userMatch = users.find(u=>u.email===saved.email && u.user_type==='client'); 
                if(userMatch){ 
                    userMatch.client_id = saved.id; 
                    await saveUser(userMatch); 
                    await loadUsersTable(); 
                }
            } else {
                showAlert('Erro ao salvar cliente!', 'error');
            }
        }

        async function handleProcessSubmit(e){ 
            e.preventDefault(); 
            const process = { 
                id: document.getElementById('processId').value ? parseInt(document.getElementById('processId').value) : null, 
                number: document.getElementById('processNumber').value, 
                clientId: parseInt(document.getElementById('processClient').value), 
                type: document.getElementById('processType').value, 
                status: document.getElementById('processStatus').value, 
                lawyer: document.getElementById('processLawyer').value, 
                startDate: document.getElementById('processStartDate').value, 
                deadline: document.getElementById('processDeadline').value || null,
                description: document.getElementById('processDescription').value 
            }; 
            const saved = await saveProcess(process); 
            if (saved) {
                await loadProcessesTable(); 
                closeProcessModal(); 
                showAlert('Processo salvo com sucesso!','success'); 
            } else {
                showAlert('Erro ao salvar processo!', 'error');
            }
        }

        async function handleUserSubmit(e){ 
            e.preventDefault(); 
            const user = { 
                id: document.getElementById('userId').value ? parseInt(document.getElementById('userId').value) : null, 
                name: document.getElementById('userNameInput').value, 
                email: document.getElementById('userEmail').value, 
                password: document.getElementById('userPassword').value, 
                type: document.getElementById('userTypeModal').value, 
                status: document.getElementById('userStatus').value 
            }; 
            const clientSelect = document.getElementById('userClientSelect').value; 
            if(user.type === 'client'){ 
                if(clientSelect) user.clientId = parseInt(clientSelect); 
                else { 
                    // Tentar encontrar por email
                    const clients = await getClients();
                    const c = clients.find(c=>c.email===user.email); 
                    if(c) user.clientId = c.id; 
                }
            }
            const saved = await saveUser(user); 
            if (saved) {
                await loadUsersTable(); 
                closeUserModal(); 
                showAlert('Usuário salvo com sucesso!','success'); 
            } else {
                showAlert('Erro ao salvar usuário!', 'error');
            }
        }

        // Handlers de Prazos e Audiências
        async function handlePrazoSubmit(e) {
            e.preventDefault();
            const prazo = {
                id: document.getElementById('prazoId').value ? parseInt(document.getElementById('prazoId').value) : null,
                processoId: parseInt(document.getElementById('prazoProcesso').value),
                titulo: document.getElementById('prazoTitulo').value,
                tipoPrazo: document.getElementById('prazoTipo').value,
                prioridade: document.getElementById('prazoPrioridade').value,
                dataVencimento: document.getElementById('prazoVencimento').value,
                responsavelId: parseInt(document.getElementById('prazoResponsavel').value),
                descricao: document.getElementById('prazoDescricao').value,
                visivelCliente: document.getElementById('prazoVisivelCliente').checked,
                status: 'pendente'
            };
            
            const saved = await savePrazoInterno(prazo);
            if (saved) {
                await loadKanbanData();
                if (currentProcessId) {
                    await loadProcessPrazos(currentProcessId);
                }
                closePrazoModal();
                showAlert('Prazo salvo com sucesso!', 'success');
            } else {
                showAlert('Erro ao salvar prazo!', 'error');
            }
        }

        async function handleAudienciaSubmit(e) {
            e.preventDefault();
            const audiencia = {
                id: document.getElementById('audienciaId').value ? parseInt(document.getElementById('audienciaId').value) : null,
                processoId: parseInt(document.getElementById('audienciaProcesso').value),
                titulo: document.getElementById('audienciaTitulo').value,
                dataAudiencia: document.getElementById('audienciaData').value,
                tipoAudiencia: document.getElementById('audienciaTipo').value,
                local: document.getElementById('audienciaLocal').value,
                participantes: document.getElementById('audienciaParticipantes').value,
                descricao: document.getElementById('audienciaObservacoes').value,
                status: 'agendada'
            };
            
            const saved = await saveAudiencia(audiencia);
            if (saved) {
                calendar.refetchEvents();
                closeAudienciaModal();
                showAlert('Audiência agendada com sucesso!', 'success');
            } else {
                showAlert('Erro ao agendar audiência!', 'error');
            }
        }

        async function handleClientProfileSubmit(e){ 
            e.preventDefault(); 
            const client = { 
                id: currentUser.client_id, 
                name: document.getElementById('clientProfileName').value, 
                email: document.getElementById('clientProfileEmail').value, 
                phone: document.getElementById('clientProfilePhone').value, 
                cpf: document.getElementById('clientProfileCPF').value, 
                address: document.getElementById('clientProfileAddress').value, 
                status:'ativo' 
            }; 
            const saved = await saveClient(client); 
            if (saved) {
                // Atualizar usuário vinculado
                const users = await getUsers(); 
                const user = users.find(u=>u.id===currentUser.id); 
                if(user){ 
                    user.name = client.name; 
                    user.email = client.email; 
                    await saveUser(user); 
                    currentUser = user; 
                    localStorage.setItem('currentUser', JSON.stringify(user)); 
                    userNameDisplay.textContent = user.name; 
                }
                showAlert('Perfil atualizado com sucesso!','success'); 
            } else {
                showAlert('Erro ao atualizar perfil!', 'error');
            }
        }

        // --- Edit / Delete ---
        function editClient(id){ openClientModal(id); }
        function editProcess(id){ openProcessModal(id); }
        function editUser(id){ openUserModal(id); }
        function editPrazoInterno(id){ openPrazoModal(id); }
        function editAudiencia(id){ openAudienciaModal(id); }

        async function deleteClientConfirm(id){ 
            if(confirm('Tem certeza que deseja excluir este cliente?')){ 
                const success = await deleteClient(id);
                if (success) {
                    // Desvincular usuários
                    const users = await getUsers(); 
                    const clientUsers = users.filter(u=>u.client_id===id);
                    for (const user of clientUsers) {
                        user.client_id = null;
                        await saveUser(user);
                    }
                    await loadClientsTable(); 
                    await loadUsersTable(); 
                    showAlert('Cliente excluído com sucesso!','success'); 
                } else {
                    showAlert('Erro ao excluir cliente!', 'error');
                }
            } 
        }

        async function deleteProcessConfirm(id){ 
            if(confirm('Tem certeza?')){ 
                const success = await deleteProcess(id);
                if (success) {
                    await loadProcessesTable(); 
                    showAlert('Processo excluído com sucesso!','success'); 
                } else {
                    showAlert('Erro ao excluir processo!', 'error');
                }
            } 
        }

        async function deleteUserConfirm(id){ 
            if(confirm('Tem certeza?')){ 
                const success = await deleteUser(id);
                if (success) {
                    await loadUsersTable(); 
                    showAlert('Usuário excluído com sucesso!','success'); 
                } else {
                    showAlert('Erro ao excluir usuário!', 'error');
                }
            } 
        }

        // --- Utilities ---
        function getStatusText(s){ 
            const map = { 
                'pendente':'Pendente', 
                'andamento':'Em Andamento', 
                'concluido':'Concluído', 
                'arquivado':'Arquivado' 
            }; 
            return map[s] || s; 
        }

        function formatDate(d){ 
            if(!d) return '-'; 
            const date = new Date(d); 
            return date.toLocaleDateString('pt-BR'); 
        }

        function formatDateTime(d){ 
            if(!d) return '-'; 
            const date = new Date(d); 
            return date.toLocaleString('pt-BR'); 
        }

        function formatDateTimeForInput(d) {
            if (!d) return '';
            const date = new Date(d);
            return date.toISOString().slice(0, 16);
        }

        function showAlert(message, type){ 
            const main=document.querySelector('.main-container'); 
            const a=document.createElement('div'); 
            a.className = `alert alert-${type}`; 
            a.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
                ${message}
            `;
            main.insertBefore(a, main.firstChild); 
            setTimeout(()=>a.remove(),5000); 
        }

        // Populate client select for user modal
        async function populateUserClientSelect(){ 
            const sel = document.getElementById('userClientSelect'); 
            if(!sel) return; 
            const clients = await getClients(); 
            sel.innerHTML = '<option value="">Nenhum</option>'; 
            clients.filter(c=>c.status==='ativo').forEach(c=>{ 
                const opt = document.createElement('option'); 
                opt.value = c.id; 
                opt.textContent = c.name; 
                sel.appendChild(opt); 
            }); 
        }

        // --- Busca Avançada ---
        function toggleAdvancedSearch(type) {
            const element = document.getElementById(`${type}AdvancedSearch`);
            element.style.display = element.style.display === 'none' ? 'block' : 'none';
        }

        function applyAdvancedSearch(type) {
            if (type === 'clients') {
                loadClientsTable();
            } else if (type === 'processes') {
                loadProcessesTable();
            }
        }

        function clearAdvancedSearch(type) {
            if (type === 'clients') {
                document.getElementById('searchClientStatus').value = '';
                document.getElementById('searchClientDateFrom').value = '';
                document.getElementById('searchClientDateTo').value = '';
            } else if (type === 'processes') {
                document.getElementById('searchProcessStatus').value = '';
                document.getElementById('searchProcessDateFrom').value = '';
                document.getElementById('searchProcessDateTo').value = '';
            }
            applyAdvancedSearch(type);
        }

        // --- Timeline / Details ---
        async function viewProcess(id){ 
            currentProcessId = id;
            const processes = await getProcesses();
            const proc = processes.find(p=>p.id===id); 
            if(!proc) return; 
            const clients = await getClients();
            const client = clients.find(c=>c.id===proc.cliente_id); 
            
            // Reset para a aba de timeline
            switchModalTab('timeline');
            
            const updates = await getProcessUpdates(id);
            
            let html = `<h3 style="margin-bottom:.25rem">${proc.numero_processo}</h3><div style="font-size:.95rem; color:var(--text-medium); margin-bottom:.75rem">Cliente: ${client?client.name:'N/A'} • Advogado: ${proc.advogados?.name || 'N/A'}</div><p style="margin-bottom:.75rem">${proc.descricao}</p><h4>Timeline</h4><div class="timeline">`; 
            
            if (updates.length === 0) {
                html += `<div class="timeline-item"><span class="timeline-date">${formatDate(new Date())}</span><div class="timeline-desc">Processo criado</div></div>`;
            } else {
                updates.forEach(u=>{ 
                    html += `<div class="timeline-item"><span class="timeline-date">${formatDate(u.data_atualizacao)}</span><div class="timeline-desc">${u.description}</div></div>`; 
                }); 
            }
            
            html += `</div>`; 
            document.getElementById('processDetailsContent').innerHTML = html;
            
            // Adicionar formulário para adicionar atualizações (apenas para admin)
            const addUpdateContainer = document.getElementById('addUpdateContainer');
            if(currentUser.user_type === 'admin') {
                addUpdateContainer.innerHTML = `
                    <h4>Adicionar Atualização</h4>
                    <form id="addUpdateForm">
                        <input type="hidden" id="updateProcessId" value="${proc.id}">
                        <div style="margin-bottom:1rem">
                            <label>Descrição da Atualização</label>
                            <textarea id="updateDescription" class="form-control" rows="3" required></textarea>
                        </div>
                        <div style="text-align:right">
                            <button type="submit" class="btn">Adicionar</button>
                        </div>
                    </form>
                `;
                
                document.getElementById('addUpdateForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const processId = parseInt(document.getElementById('updateProcessId').value);
                    const description = document.getElementById('updateDescription').value;
                    
                    if(!description) return;
                    
                    const update = {
                        processo_id: processId,
                        data_atualizacao: new Date().toISOString().split('T')[0],
                        description: description
                    };
                    
                    const saved = await saveProcessUpdate(update);
                    if (saved) {
                        await viewProcess(processId);
                        showAlert('Atualização adicionada com sucesso!', 'success');
                    } else {
                        showAlert('Erro ao adicionar atualização!', 'error');
                    }
                });
            } else {
                addUpdateContainer.innerHTML = '';
            }
            
            // Carregar dados dos prazos
            await loadProcessPrazos(id);
            
            // Carregar dados financeiros
            await loadFinancialData(id);
            
            document.getElementById('processDetailsModal').classList.add('active'); 
        }

        // Carregar Prazos do Processo
        async function loadProcessPrazos(processId) {
            const prazos = await getPrazosInternos(processId);
            const container = document.getElementById('processPrazosContent');
            
            if (prazos.length === 0) {
                container.innerHTML = '<p>Nenhum prazo cadastrado para este processo.</p>';
            } else {
                let html = '<h4>Prazos do Processo</h4><div class="prazos-grid">';
                
                prazos.forEach(prazo => {
                    const daysLeft = calculateDaysLeft(prazo.data_vencimento);
                    const daysText = daysLeft === 0 ? 'Hoje' : 
                                    daysLeft === 1 ? '1 dia' : 
                                    daysLeft > 0 ? `${daysLeft} dias` : 
                                    `Vencido há ${Math.abs(daysLeft)} dias`;
                    
                    html += `
                        <div class="prazo-card ${prazo.prioridade}">
                            <div class="prazo-header">
                                <div>
                                    <div class="prazo-title">${prazo.titulo}</div>
                                    <div class="prazo-desc">${prazo.descricao}</div>
                                </div>
                                <span class="priority-badge priority-${prazo.prioridade}">${prazo.prioridade}</span>
                            </div>
                            <div class="prazo-meta">
                                <span><strong>Tipo:</strong> ${prazo.tipo_prazo}</span>
                                <span><strong>Vence:</strong> ${formatDate(prazo.data_vencimento)}</span>
                            </div>
                            <div class="prazo-meta">
                                <span><strong>Responsável:</strong> ${prazo.usuarios?.name || 'N/A'}</span>
                                <span style="color: ${daysLeft <= 3 ? 'var(--danger)' : daysLeft <= 7 ? 'var(--warning)' : 'var(--success)'}">
                                    ${daysText}
                                </span>
                            </div>
                            <div class="prazo-meta">
                                <span><strong>Status:</strong> ${prazo.status}</span>
                                <span><strong>Visível ao cliente:</strong> ${prazo.visivel_cliente ? 'Sim' : 'Não'}</span>
                            </div>
                            ${currentUser.user_type === 'admin' ? `
                            <div style="margin-top: 1rem; display: flex; gap: 0.5rem;">
                                <button class="btn btn-small" onclick="editPrazoInterno(${prazo.id})">
                                    <i class="fas fa-edit"></i> Editar
                                </button>
                                <button class="btn btn-small btn-secondary" onclick="concluirPrazo(${prazo.id})">
                                    <i class="fas fa-check"></i> Concluir
                                </button>
                            </div>
                            ` : ''}
                        </div>
                    `;
                });
                
                html += '</div>';
                container.innerHTML = html;
            }
            
            // Adicionar botão para adicionar prazo (apenas para admin)
            const addPrazoContainer = document.getElementById('addPrazoProcessoContainer');
            if (currentUser.user_type === 'admin') {
                addPrazoContainer.innerHTML = `
                    <h4>Adicionar Prazo</h4>
                    <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-bottom: 1rem;">
                        ${Object.entries(templatesPrazos).map(([key, template]) => `
                            <button type="button" class="btn btn-small" onclick="openPrazoModal(null, ${processId}, '${key}')">
                                <i class="fas fa-plus"></i> ${template.titulo}
                            </button>
                        `).join('')}
                    </div>
                    <button type="button" class="btn btn-small btn-secondary" onclick="openPrazoModal(null, ${processId})">
                        <i class="fas fa-plus"></i> Prazo Personalizado
                    </button>
                `;
            } else {
                addPrazoContainer.innerHTML = '';
            }
        }

        async function concluirPrazo(id) {
            if (confirm('Marcar este prazo como concluído?')) {
                const prazos = await getPrazosInternos();
                const prazo = prazos.find(p => p.id === id);
                if (prazo) {
                    prazo.status = 'concluido';
                    const saved = await savePrazoInterno(prazo);
                    if (saved) {
                        await loadKanbanData();
                        showAlert('Prazo marcado como concluído!', 'success');
                    } else {
                        showAlert('Erro ao atualizar prazo!', 'error');
                    }
                }
            }
        }

        // Verificação de permissão para financeiro
        function checkFinancialAccess() {
            return currentUser && currentUser.user_type === 'admin';
        }

        // NOVA FUNÇÃO: Carregar dados financeiros com cálculo atualizado
        async function loadFinancialData(processId) {
            // VERIFICAÇÃO DE PERMISSÃO
            if (!checkFinancialAccess()) {
                const financialContainer = document.getElementById('financialDetailsContent');
                financialContainer.innerHTML = `
                    <div class="alert alert-error">
                        <i class="fas fa-lock"></i> Acesso restrito. Apenas administradores podem visualizar informações financeiras.
                    </div>
                `;
                document.getElementById('addFinancialContainer').innerHTML = '';
                return;
            }
            
            const financials = await getFinancials();
            const processFinancials = financials.filter(f => f.processo_id === processId);
            const financialContainer = document.getElementById('financialDetailsContent');
            
            let html = `<h4>Resumo Financeiro</h4>`;
            
            // CÁLCULO ATUALIZADO: Honorários pendentes são negativos
            const honorariosPagos = processFinancials.filter(f => f.type === 'honorario' && f.status === 'pago').reduce((sum, f) => sum + f.value, 0);
            const honorariosPendentes = processFinancials.filter(f => f.type === 'honorario' && f.status === 'pendente').reduce((sum, f) => sum + f.value, 0);
            const custos = processFinancials.filter(f => f.type === 'custo').reduce((sum, f) => sum + f.value, 0);
            const saldo = honorariosPagos - honorariosPendentes - custos;
            
            html += `
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                    <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">R$ ${honorariosPagos.toLocaleString('pt-BR')}</div>
                        <div style="font-size: 0.9rem; color: var(--text-medium);">Honorários Pagos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--warning);">R$ ${honorariosPendentes.toLocaleString('pt-BR')}</div>
                        <div style="font-size: 0.9rem; color: var(--text-medium);">Honorários Pendentes</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: var(--danger);">R$ ${custos.toLocaleString('pt-BR')}</div>
                        <div style="font-size: 0.9rem; color: var(--text-medium);">Custos</div>
                    </div>
                    <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                        <div style="font-size: 1.5rem; font-weight: bold; color: ${saldo >= 0 ? 'var(--success)' : 'var(--danger)'};">R$ ${saldo.toLocaleString('pt-BR')}</div>
                        <div style="font-size: 0.9rem; color: var(--text-medium);">Saldo Final</div>
                    </div>
                </div>
            `;
            
            html += `<h4>Lançamentos Financeiros</h4>`;
            
            if (processFinancials.length > 0) {
                html += `
                    <table style="width: 100%; border-collapse: collapse;">
                        <thead>
                            <tr style="background: var(--primary-dark); color: var(--text-light);">
                                <th style="padding: 0.75rem;">Data</th>
                                <th style="padding: 0.75rem;">Tipo</th>
                                <th style="padding: 0.75rem;">Descrição</th>
                                <th style="padding: 0.75rem;">Valor</th>
                                <th style="padding: 0.75rem;">Status</th>
                                <th style="padding: 0.75rem;">Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                processFinancials.forEach(financial => {
                    const tipoText = financial.type === 'honorario' ? 'Honorário' : 'Custo';
                    const tipoClass = financial.type === 'honorario' ? 'financial-receita' : 'financial-despesa';
                    const statusClass = financial.status === 'pago' ? 'financial-pago' : 'financial-pendente';
                    const statusText = financial.status === 'pago' ? 'Pago' : 'Pendente';
                    
                    html += `
                        <tr>
                            <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">${formatDate(financial.date)}</td>
                            <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;"><span class="financial-badge ${tipoClass}">${tipoText}</span></td>
                            <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">${financial.description}</td>
                            <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">R$ ${financial.value.toLocaleString('pt-BR')}</td>
                            <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;"><span class="financial-badge ${statusClass}">${statusText}</span></td>
                            <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">
                                <button class="action-btn" onclick="editFinancial(${financial.id})" title="Editar"><i class="fas fa-edit"></i></button>
                                <button class="action-btn btn-danger" onclick="deleteFinancialConfirm(${financial.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
                
                html += `</tbody></table>`;
            } else {
                html += `<p style="text-align: center; color: var(--text-medium); padding: 2rem;">Nenhum lançamento financeiro registrado.</p>`;
            }
            
            financialContainer.innerHTML = html;
            
            // Adicionar formulário para novos lançamentos (apenas para admin)
            const addFinancialContainer = document.getElementById('addFinancialContainer');
            if(currentUser.user_type === 'admin') {
                addFinancialContainer.innerHTML = `
                    <h4>Adicionar Lançamento Financeiro</h4>
                    <form id="addFinancialForm">
                        <input type="hidden" id="financialProcessId" value="${processId}">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label>Tipo</label>
                                <select id="financialType" class="form-control" required>
                                    <option value="">Selecione</option>
                                    <option value="honorario">Honorário</option>
                                    <option value="custo">Custo</option>
                                </select>
                            </div>
                            <div>
                                <label>Status</label>
                                <select id="financialStatus" class="form-control" required>
                                    <option value="pendente">Pendente</option>
                                    <option value="pago">Pago</option>
                                </select>
                            </div>
                        </div>
                        <div style="margin-bottom: 1rem">
                            <label>Descrição</label>
                            <input type="text" id="financialDescription" class="form-control" required>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label>Valor (R$)</label>
                                <input type="number" id="financialValue" class="form-control" step="0.01" min="0" required>
                            </div>
                            <div>
                                <label>Data</label>
                                <input type="date" id="financialDate" class="form-control" required>
                            </div>
                        </div>
                        <div style="text-align:right">
                            <button type="submit" class="btn">Adicionar</button>
                        </div>
                    </form>
                `;
                
                // Definir data atual como padrão
                document.getElementById('financialDate').valueAsDate = new Date();
                
                document.getElementById('addFinancialForm').addEventListener('submit', async function(e) {
                    e.preventDefault();
                    const processId = parseInt(document.getElementById('financialProcessId').value);
                    const type = document.getElementById('financialType').value;
                    const description = document.getElementById('financialDescription').value;
                    const value = parseFloat(document.getElementById('financialValue').value);
                    const date = document.getElementById('financialDate').value;
                    const status = document.getElementById('financialStatus').value;
                    
                    if(!type || !description || !value) return;
                    
                    const financial = {
                        processId: processId,
                        type: type,
                        description: description,
                        value: value,
                        date: date,
                        status: status
                    };
                    
                    const saved = await saveFinancial(financial);
                    if (saved) {
                        await loadFinancialData(processId);
                        showAlert('Lançamento financeiro adicionado com sucesso!', 'success');
                        
                        // Limpar formulário
                        document.getElementById('addFinancialForm').reset();
                        document.getElementById('financialDate').valueAsDate = new Date();
                    } else {
                        showAlert('Erro ao adicionar lançamento financeiro!', 'error');
                    }
                });
            } else {
                addFinancialContainer.innerHTML = '';
            }
        }

        function closeProcessDetails(){ 
            document.getElementById('processDetailsModal').classList.remove('active'); 
            document.getElementById('addUpdateContainer').innerHTML = '';
            document.getElementById('addFinancialContainer').innerHTML = '';
            document.getElementById('addPrazoProcessoContainer').innerHTML = '';
            currentProcessId = null;
        }

        async function editFinancial(id) {
            const financials = await getFinancials();
            const financial = financials.find(f => f.id === id);
            if (!financial) return;
            
            // Preencher o formulário com os dados existentes
            document.getElementById('financialType').value = financial.type;
            document.getElementById('financialStatus').value = financial.status;
            document.getElementById('financialDescription').value = financial.description;
            document.getElementById('financialValue').value = financial.value;
            document.getElementById('financialDate').value = financial.date;
            
            // Rolar para o formulário
            document.getElementById('addFinancialContainer').scrollIntoView({ behavior: 'smooth' });
            
            // Alterar o botão para "Atualizar"
            const form = document.getElementById('addFinancialForm');
            const submitButton = form.querySelector('button[type="submit"]');
            const originalText = submitButton.textContent;
            submitButton.textContent = 'Atualizar';
            
            // Substituir o event listener
            const newForm = form.cloneNode(true);
            form.parentNode.replaceChild(newForm, form);
            
            document.getElementById('addFinancialForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                // Atualizar o lançamento
                financial.type = document.getElementById('financialType').value;
                financial.status = document.getElementById('financialStatus').value;
                financial.description = document.getElementById('financialDescription').value;
                financial.value = parseFloat(document.getElementById('financialValue').value);
                financial.date = document.getElementById('financialDate').value;
                
                const saved = await saveFinancial(financial);
                if (saved) {
                    await loadFinancialData(currentProcessId);
                    showAlert('Lançamento financeiro atualizado com sucesso!', 'success');
                    
                    // Restaurar o formulário para adição
                    document.getElementById('addFinancialForm').reset();
                    document.getElementById('financialDate').valueAsDate = new Date();
                    submitButton.textContent = originalText;
                } else {
                    showAlert('Erro ao atualizar lançamento financeiro!', 'error');
                }
            });
        }

        async function deleteFinancialConfirm(id) {
            if(confirm('Tem certeza que deseja excluir este lançamento financeiro?')) {
                const success = await deleteFinancial(id);
                if (success) {
                    await loadFinancialData(currentProcessId);
                    showAlert('Lançamento financeiro excluído com sucesso!', 'success');
                } else {
                    showAlert('Erro ao excluir lançamento financeiro!', 'error');
                }
            }
        }

        // --- SISTEMA DE RELATÓRIOS COMPLETO COM CÁLCULO ATUALIZADO ---

        // NOVA FUNÇÃO: Gerar relatórios com cálculo atualizado
        async function generateReports() {
            try {
                showAlert('Gerando relatório...', 'info');
                
                const period = document.getElementById('reportPeriod').value;
                const lawyer = document.getElementById('reportLawyer').value;
                const type = document.getElementById('reportType').value;
                
                const processes = await getProcesses();
                const clients = await getClients();
                const financials = await getFinancials();
                const prazos = await getPrazosInternos();
                
                // Aplicar filtros
                let filteredProcesses = processes;
                
                if (lawyer !== 'all') {
                    filteredProcesses = filteredProcesses.filter(p => p.advogados?.name === lawyer);
                }
                
                if (type !== 'all') {
                    filteredProcesses = filteredProcesses.filter(p => p.tipo_processo === type);
                }
                
                if (period !== 'all') {
                    const days = parseInt(period);
                    const cutoffDate = new Date();
                    cutoffDate.setDate(cutoffDate.getDate() - days);
                    
                    filteredProcesses = filteredProcesses.filter(p => {
                        const processDate = new Date(p.data_abertura);
                        return processDate >= cutoffDate;
                    });
                }
                
                // CÁLCULO ATUALIZADO: Honorários pendentes são negativos
                let totalHonorariosPagos = 0;
                let totalHonorariosPendentes = 0;
                let totalExpenses = 0;
                
                filteredProcesses.forEach(process => {
                    const processFinancials = financials.filter(f => f.processo_id === process.id);
                    const honorariosPagos = processFinancials.filter(f => f.type === 'honorario' && f.status === 'pago').reduce((sum, f) => sum + f.value, 0);
                    const honorariosPendentes = processFinancials.filter(f => f.type === 'honorario' && f.status === 'pendente').reduce((sum, f) => sum + f.value, 0);
                    const custos = processFinancials.filter(f => f.type === 'custo').reduce((sum, f) => sum + f.value, 0);
                    
                    totalHonorariosPagos += honorariosPagos;
                    totalHonorariosPendentes += honorariosPendentes;
                    totalExpenses += custos;
                });
                
                const totalReceita = totalHonorariosPagos;
                const totalProfit = totalHonorariosPagos - totalHonorariosPendentes - totalExpenses;
                const totalReceitaPotencial = totalHonorariosPagos + totalHonorariosPendentes;
                
                // Atualizar estatísticas
                document.getElementById('reportTotalProcesses').textContent = filteredProcesses.length;
                document.getElementById('reportRevenue').textContent = `R$ ${totalReceita.toLocaleString('pt-BR')}`;
                document.getElementById('reportExpenses').textContent = `R$ ${totalExpenses.toLocaleString('pt-BR')}`;
                document.getElementById('reportProfit').textContent = `R$ ${totalProfit.toLocaleString('pt-BR')}`;
                document.getElementById('reportPendingHonorarios').textContent = `R$ ${totalHonorariosPendentes.toLocaleString('pt-BR')}`;
                document.getElementById('reportReceitaPotencial').textContent = `R$ ${totalReceitaPotencial.toLocaleString('pt-BR')}`;
                
                // Renderizar gráficos
                renderReportCharts(filteredProcesses, prazos);
                
                // Atualizar tabela com cálculo atualizado
                updateReportTable(filteredProcesses, clients, financials);
                
                showAlert('Relatório gerado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao gerar relatório:', error);
                showAlert('Erro ao gerar relatório!', 'error');
            }
        }

        function renderReportCharts(processes, prazos) {
            // Gráfico de status
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const statusData = {
                'pendente': processes.filter(p => p.status === 'pendente').length,
                'andamento': processes.filter(p => p.status === 'andamento').length,
                'concluido': processes.filter(p => p.status === 'concluido').length,
                'arquivado': processes.filter(p => p.status === 'arquivado').length
            };
            
            // Destruir gráfico anterior se existir
            if (window.statusChartInstance) {
                window.statusChartInstance.destroy();
            }
            
            window.statusChartInstance = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Pendente', 'Em Andamento', 'Concluído', 'Arquivado'],
                    datasets: [{
                        data: Object.values(statusData),
                        backgroundColor: ['#FFF3CD', '#D1ECF1', '#D4EDDA', '#E2E3E5'],
                        borderColor: ['#856404', '#0C5460', '#155724', '#383D41'],
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        title: {
                            display: true,
                            text: 'Distribuição por Status'
                        }
                    }
                }
            });
            
            // Gráfico de advogados
            const lawyerCtx = document.getElementById('lawyerChart').getContext('2d');
            const lawyerData = {};
            processes.forEach(p => {
                const lawyerName = p.advogados?.name || 'Sem advogado';
                lawyerData[lawyerName] = (lawyerData[lawyerName] || 0) + 1;
            });
            
            if (window.lawyerChartInstance) {
                window.lawyerChartInstance.destroy();
            }
            
            window.lawyerChartInstance = new Chart(lawyerCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(lawyerData),
                    datasets: [{
                        label: 'Processos',
                        data: Object.values(lawyerData),
                        backgroundColor: '#C9A769',
                        borderColor: '#004D4D',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Processos'
                            }
                        }
                    }
                }
            });
            
            // Gráfico de tipos
            const typeCtx = document.getElementById('typeChart').getContext('2d');
            const typeData = {};
            processes.forEach(p => {
                const type = p.tipo_processo;
                typeData[type] = (typeData[type] || 0) + 1;
            });
            
            if (window.typeChartInstance) {
                window.typeChartInstance.destroy();
            }
            
            window.typeChartInstance = new Chart(typeCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(typeData),
                    datasets: [{
                        data: Object.values(typeData),
                        backgroundColor: [
                            '#C9A769', '#004D4D', '#002B2B', '#001A1A',
                            '#D4B989', '#006666', '#003D3D', '#002222'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
            
            // Gráfico de timeline (processos por mês)
            const timelineCtx = document.getElementById('timelineChart').getContext('2d');
            const timelineData = {};
            processes.forEach(p => {
                const date = new Date(p.data_abertura);
                const monthYear = `${date.getMonth()+1}/${date.getFullYear()}`;
                timelineData[monthYear] = (timelineData[monthYear] || 0) + 1;
            });
            
            // Ordenar por data
            const sortedMonths = Object.keys(timelineData).sort((a, b) => {
                const [monthA, yearA] = a.split('/').map(Number);
                const [monthB, yearB] = b.split('/').map(Number);
                return new Date(yearA, monthA-1) - new Date(yearB, monthB-1);
            });
            
            if (window.timelineChartInstance) {
                window.timelineChartInstance.destroy();
            }
            
            window.timelineChartInstance = new Chart(timelineCtx, {
                type: 'line',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: 'Processos Abertos',
                        data: sortedMonths.map(month => timelineData[month]),
                        borderColor: '#004D4D',
                        backgroundColor: 'rgba(0, 77, 77, 0.1)',
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Quantidade de Processos'
                            }
                        }
                    }
                }
            });
        }

        // NOVA FUNÇÃO: Atualizar tabela de relatórios com cálculo atualizado
        function updateReportTable(processes, clients, financials) {
            const tbody = document.getElementById('reportProcessesBody');
            tbody.innerHTML = '';
            
            processes.forEach(process => {
                const client = clients.find(c => c.id === process.cliente_id);
                const processFinancials = financials.filter(f => f.processo_id === process.id);
                
                // CÁLCULO ATUALIZADO: Honorários pendentes são negativos
                const honorariosPagos = processFinancials.filter(f => f.type === 'honorario' && f.status === 'pago').reduce((sum, f) => sum + f.value, 0);
                const honorariosPendentes = processFinancials.filter(f => f.type === 'honorario' && f.status === 'pendente').reduce((sum, f) => sum + f.value, 0);
                const custos = processFinancials.filter(f => f.type === 'custo').reduce((sum, f) => sum + f.value, 0);
                const saldo = honorariosPagos - honorariosPendentes - custos;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${process.numero_processo}</td>
                    <td>${client ? client.name : 'N/A'}</td>
                    <td>${process.tipo_processo}</td>
                    <td><span class="status-badge status-${process.status}">${getStatusText(process.status)}</span></td>
                    <td>${formatDate(process.data_abertura)}</td>
                    <td>${process.advogados?.name || 'N/A'}</td>
                    <td>R$ ${honorariosPagos.toLocaleString('pt-BR')}</td>
                    <td>R$ ${honorariosPendentes.toLocaleString('pt-BR')}</td>
                    <td>R$ ${custos.toLocaleString('pt-BR')}</td>
                    <td style="font-weight: bold; color: ${saldo >= 0 ? 'var(--success)' : 'var(--danger)'};">R$ ${saldo.toLocaleString('pt-BR')}</td>
                `;
                tbody.appendChild(row);
            });
            
            if (processes.length === 0) {
                const row = document.createElement('tr');
                row.innerHTML = `<td colspan="10" style="text-align: center; color: var(--text-medium); padding: 2rem;">Nenhum processo encontrado</td>`;
                tbody.appendChild(row);
            }
        }

        // --- FUNÇÕES DE EXPORTAÇÃO ---

        function exportToPDF() {
            const table = document.querySelector('#reports-tab table');
            
            if (!table) {
                showAlert('Nenhuma tabela de processos encontrada.', 'error');
                return;
            }

            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Processos MPS Advogados</title>
                        <style>
                            body { font-family: Arial; margin: 20px; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                            th { background: #001A1A; color: white; }
                        </style>
                    </head>
                    <body>
                        <h2>Processos - MPS Advogados</h2>
                        <p>Data: ${new Date().toLocaleDateString('pt-BR')}</p>
                        ${table.outerHTML}
                    </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
            showAlert('Relatório gerado para impressão!', 'success');
        }

        function exportToExcel() {
            const table = document.querySelector('#reports-tab table');
            if (!table) {
                alert('Nenhuma tabela encontrada para exportar.');
                return;
            }

            let csv = [];
            const headers = [];
            
            // Cabeçalhos
            table.querySelectorAll('thead th').forEach(th => {
                let text = th.innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/,/g, ";");
                // Remover badges HTML
                text = text.replace(/<[^>]*>/g, '');
                headers.push(text);
            });
            csv.push(headers.join(','));
            
            // Dados
            table.querySelectorAll('tbody tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td').forEach(td => {
                    let text = td.innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/,/g, ";");
                    // Remover badges HTML
                    text = text.replace(/<[^>]*>/g, '');
                    row.push(text);
                });
                csv.push(row.join(','));
            });
            
            const csvString = csv.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', `relatorio_mps_${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showAlert('Relatório exportado com sucesso!', 'success');
        }

        function exportToCSV() {
            exportToExcel(); // Reutiliza a mesma funcionalidade
        }

        // --- Backup e Restauração ---
        async function exportBackup() {
            try {
                const backupData = {
                    clients: await getClients(),
                    processes: await getProcesses(),
                    users: await getUsers(),
                    documents: await getDocuments(),
                    financials: await getFinancials(),
                    notifications: await getNotifications(),
                    prazos_internos: await getPrazosInternos(),
                    audiencias: await getAudiencias(),
                    exportDate: new Date().toISOString()
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataBlob = new Blob([dataStr], {type: 'application/json'});
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `backup_mps_${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                showAlert('Backup exportado com sucesso!', 'success');
            } catch (error) {
                console.error('Erro ao exportar backup:', error);
                showAlert('Erro ao exportar backup!', 'error');
            }
        }

        function importBackup() {
            document.getElementById('backupFile').click();
        }

        async function handleBackupImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = async function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // Validar estrutura do backup
                    if (!backupData.clients || !backupData.processes || !backupData.users) {
                        throw new Error('Arquivo de backup inválido');
                    }
                    
                    showAlert('Importando backup...', 'info');
                    
                    // Restaurar dados
                    for (const client of backupData.clients) {
                        await saveClient(client);
                    }
                    for (const process of backupData.processes) {
                        await saveProcess(process);
                    }
                    for (const user of backupData.users) {
                        await saveUser(user);
                    }
                    
                    // Recarregar dados
                    if (currentUser.user_type === 'admin') {
                        await loadAdminData();
                    } else {
                        await loadClientData();
                    }
                    
                    showAlert('Backup restaurado com sucesso!', 'success');
                    
                    // Limpar input
                    event.target.value = '';
                    
                } catch (error) {
                    console.error('Erro ao importar backup:', error);
                    showAlert('Erro ao importar backup: ' + error.message, 'error');
                }
            };
            reader.readAsText(file);
        }

        // Adicionar html2pdf para exportação de PDF
        const script = document.createElement('script');
        script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js';
        document.head.appendChild(script);

        // Atualizar a cada 30 segundos para manter os dados frescos
        setInterval(() => {
            if (document.querySelector('.tab.active[data-tab="prazos"]') && currentView === 'kanban') {
                loadKanbanData();
            }
        }, 30000);

    </script>
</body>
</html>
