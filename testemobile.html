<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sistema MPS Advogados - Gestão Completa</title>
    
    <!-- Fontes e ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.cdnfonts.com/css/neue-haas-grotesk-display-pro" rel="stylesheet">
    <!-- Seus meta tags e estilos atuais -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root{
            --primary-dark:#001A1A; --primary-medium:#002B2B; --primary-light:#004D4D;
            --accent:#C9A769; --accent-light:#D4B989; --text-light:#f8f8f8; --text-dark:#1A1A1A;
            --text-medium:#5A5A5A; --white:#ffffff; --gray-light:#f5f5f5; --transition: all .4s cubic-bezier(.23,1,.32,1);
            --success:#28a745; --warning:#ffc107; --danger:#dc3545; --info:#17a2b8;
            --border-radius: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.08);
            --shadow-hover: 0 8px 30px rgba(0,0,0,0.12);
        }
        body{ 
            font-family:'Neue Haas Grotesk Display Pro', 'Inter', sans-serif; 
            background:var(--white); 
            color:var(--text-dark);
            line-height: 1.6;
        }
        
        /* Layout principal */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        
        .header{ 
            background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary-medium) 50%,var(--primary-light) 100%); 
            padding:1rem 1.5rem; 
            color:var(--text-light);
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content{ 
            max-width:1200px; 
            margin:0 auto; 
            display:flex; 
            justify-content:space-between; 
            align-items:center;
        }
        .logo{ 
            font-family:'Playfair Display', serif; 
            font-size:1.4rem; 
            letter-spacing:1px; 
            text-transform:uppercase;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .logo-icon {
            background: var(--accent);
            width: 32px;
            height: 32px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .user-info{ 
            display:flex; 
            gap:1rem; 
            align-items:center;
        }
        .logout-btn{ 
            background:transparent; 
            border:1px solid var(--accent); 
            color:var(--accent); 
            padding:.5rem 1.2rem; 
            border-radius:6px; 
            cursor:pointer;
            font-weight: 500;
            transition: var(--transition);
        }
        .logout-btn:hover {
            background: rgba(201, 167, 105, 0.1);
        }

        .main-container{ 
            max-width:1200px; 
            margin:0 auto; 
            padding:1.5rem; 
            flex: 1;
            width: 100%;
        }
        
        /* Página de Login */
        .login-container{ 
            display:flex; 
            justify-content:center; 
            align-items:center; 
            min-height:100vh;
            background: linear-gradient(135deg, var(--primary-dark) 0%, var(--primary-medium) 100%);
            position: relative;
            overflow: hidden;
        }
        
        .login-container::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-image: 
                radial-gradient(circle at 25% 25%, rgba(201, 167, 105, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 75% 75%, rgba(0, 77, 77, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 50% 50%, rgba(0, 43, 43, 0.1) 0%, transparent 50%);
            background-size: 400px 400px, 300px 300px, 500px 500px;
            background-position: 0 0, 100px 100px, 200px 200px;
            animation: backgroundShift 20s infinite linear;
        }
        
        @keyframes backgroundShift {
            0% { background-position: 0 0, 100px 100px, 200px 200px; }
            100% { background-position: 400px 400px, 500px 500px, 600px 600px; }
        }
        
        .login-card{ 
            background: var(--white);
            padding:2.5rem; 
            border-radius:var(--border-radius); 
            box-shadow:var(--shadow-hover);
            max-width:450px;
            width: 90%;
            z-index: 1;
            position: relative;
        }
        .login-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        .login-header h2 {
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        .login-header p {
            color: var(--text-medium);
            font-size: 0.95rem;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: var(--text-dark);
        }
        .form-control{ 
            width:100%; 
            padding:1rem; 
            border-radius:8px; 
            border:1px solid rgba(0,0,0,.12);
            font-family: inherit;
            font-size: 1rem;
            transition: var(--transition);
        }
        .form-control:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(201, 167, 105, 0.2);
        }
        .btn{ 
            background:var(--accent); 
            color:var(--primary-dark); 
            padding:1rem 1.6rem; 
            border:none; 
            border-radius:8px; 
            cursor:pointer;
            font-weight: 600;
            font-size: 1rem;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:hover {
            background: var(--accent-light);
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        .btn-full {
            width: 100%;
        }

        /* Tabelas e abas */
        .tabs{ 
            display:flex; 
            gap:0.5rem; 
            margin-bottom:1.5rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
            overflow-x: auto;
            padding-bottom: 0;
            scrollbar-width: none;
        }
        .tabs::-webkit-scrollbar {
            display: none;
        }
        .tab{ 
            padding:1rem 1.2rem; 
            cursor:pointer;
            white-space: nowrap;
            border-bottom: 2px solid transparent;
            transition: var(--transition);
            font-weight: 500;
        }
        .tab.active{ 
            border-bottom:2px solid var(--accent);
            color: var(--primary-dark);
        }
        .tab-content{ display:none }
        .tab-content.active{ display:block }

        table{ 
            width:100%; 
            border-collapse:collapse;
            box-shadow: var(--shadow);
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        th, td{ 
            padding:1rem; 
            text-align:left;
        }
        thead{ 
            background:var(--primary-dark); 
            color:var(--text-light);
        }
        tbody tr {
            border-bottom: 1px solid rgba(0,0,0,0.05);
            transition: var(--transition);
        }
        tbody tr:hover {
            background: rgba(0,0,0,0.02);
        }

        /* Modal base */
        .modal{ 
            display:none; 
            position:fixed; 
            inset:0; 
            background:rgba(0,0,0,.45); 
            z-index:1000; 
            align-items:center; 
            justify-content:center;
            padding: 1rem;
        }
        .modal.active{ 
            display:flex;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal-content{ 
            background:var(--white); 
            width:90%; 
            max-width:900px; 
            border-radius:var(--border-radius); 
            padding:1.6rem; 
            max-height:90vh; 
            overflow:auto;
            box-shadow: var(--shadow-hover);
            animation: slideUp 0.3s ease;
        }
        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .modal-header{ 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            margin-bottom:1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        .modal-close{ 
            background:none; 
            border:none; 
            font-size:1.6rem; 
            cursor:pointer;
            color: var(--text-medium);
            transition: var(--transition);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .modal-close:hover {
            background: rgba(0,0,0,0.05);
            color: var(--text-dark);
        }

        /* Timeline */
        .timeline{ 
            border-left:3px solid var(--accent); 
            padding-left:18px; 
            margin-top:8px;
        }
        .timeline-item{ 
            margin-bottom:18px; 
            position:relative;
            padding: 1rem;
            background: var(--gray-light);
            border-radius: 8px;
        }
        .timeline-item::before{ 
            content:""; 
            width:12px; 
            height:12px; 
            background:var(--accent); 
            border-radius:50%; 
            position:absolute; 
            left:-30px; 
            top:20px;
        }
        .timeline-date{ 
            display:block; 
            font-size:0.9rem; 
            color:var(--text-medium); 
            margin-bottom:4px;
            font-weight: 500;
        }

        /* Tabs dentro do modal */
        .modal-tabs { 
            display: flex; 
            border-bottom: 1px solid #e0e0e0; 
            margin-bottom: 1.5rem;
            overflow-x: auto;
        }
        .modal-tab { 
            padding:0.75rem 1.5rem; 
            cursor: pointer; 
            border-bottom: 2px solid transparent;
            white-space: nowrap;
            transition: var(--transition);
        }
        .modal-tab.active { 
            border-bottom: 2px solid var(--accent); 
            color: var(--primary-dark); 
            font-weight: 500;
        }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pendente { background-color: #FFF3CD; color: #856404; }
        .status-andamento { background-color: #D1ECF1; color: #0C5460; }
        .status-concluido { background-color: #D4EDDA; color: #155724; }
        .status-arquivado { background-color: #E2E3E5; color: #383D41; }

        /* Financial badges */
        .financial-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .financial-receita { background-color: #D4EDDA; color: #155724; }
        .financial-despesa { background-color: #F8D7DA; color: #721C24; }
        .financial-pendente { background-color: #FFF3CD; color: #856404; }
        .financial-pago { background-color: #D1ECF1; color: #0C5460; }

        /* Alertas */
        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-success {
            background-color: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        
        .alert-error {
            background-color: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }

        /* Botões de ação */
        .action-btn {
            background: none;
            border: none;
            color: var(--primary-dark);
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.8rem;
            transition: var(--transition);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .action-btn:hover {
            background: rgba(0,0,0,0.05);
            color: var(--accent);
        }
        
        .btn-danger {
            color: #dc3545;
        }
        
        .btn-danger:hover {
            color: #c82333;
            background: rgba(220, 53, 69, 0.1);
        }

        /* Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            text-align: center;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            color: var(--primary-dark);
        }
        
        .stat-label {
            color: var(--text-medium);
            font-size: 0.9rem;
        }

        /* Notificações */
        .notifications {
            position: relative;
        }
        
        .notification-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
            position: relative;
            padding: 0.5rem;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        
        .notification-btn:hover {
            background: rgba(255,255,255,0.1);
        }
        
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
        }
        
        .notification-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 350px;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-hover);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-dropdown.show {
            display: block;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: var(--transition);
        }
        
        .notification-item.unread {
            background: #f8f9fa;
        }
        
        .notification-item:hover {
            background: #f0f0f0;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .notification-message {
            font-size: 0.9rem;
            color: var(--text-medium);
        }
        
        .notification-time {
            font-size: 0.8rem;
            color: var(--text-medium);
            margin-top: 0.25rem;
        }

        /* Gráficos */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .chart-card {
            background: var(--white);
            border-radius: var(--border-radius);
            padding: 1.5rem;
            box-shadow: var(--shadow);
        }
        
        .chart-card h4 {
            margin-bottom: 1rem;
            text-align: center;
            color: var(--primary-dark);
        }
        
        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 8px;
            color: var(--text-medium);
        }

        /* Busca Avançada */
        .advanced-search {
            background: var(--gray-light);
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
        }
        
        .advanced-search-toggle {
            background: none;
            border: none;
            color: var(--primary-dark);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            transition: var(--transition);
        }
        
        .advanced-search-toggle:hover {
            background: rgba(0,0,0,0.05);
        }

        /* Loading */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Backup Section */
        .backup-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--gray-light);
            border-radius: var(--border-radius);
        }

        /* Dashboard Header */
        .dashboard-header {
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .dashboard-header h1 {
            color: var(--primary-dark);
            margin-bottom: 0.5rem;
            font-weight: 600;
        }
        
        .dashboard-header p {
            color: var(--text-medium);
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
            gap: 1rem;
        }
        
        /* Table Container */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
        }
        
        /* Mobile Menu */
        .mobile-menu-btn {
            display: none;
            background: none;
            border: none;
            color: var(--text-light);
            font-size: 1.5rem;
            cursor: pointer;
        }
        
        /* Small screens */
        @media (max-width: 768px){ 
            .header {
                padding: 1rem;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .logo {
                font-size: 1.2rem;
            }
            
            .user-info span:not(.notification-badge) {
                display: none;
            }
            
            .main-container{ 
                padding:1rem;
            } 
            
            .modal-content { 
                width: 95%; 
                padding: 1rem; 
            }
            
            .charts-container { 
                grid-template-columns: 1fr; 
            }
            
            .notification-dropdown { 
                width: 300px; 
                right: -50px; 
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }
            
            .form-actions {
                flex-direction: column;
            }
            
            .form-actions > div {
                width: 100%;
            }
            
            .form-actions input {
                width: 100%;
            }
            
            .tabs {
                padding-bottom: 0.5rem;
            }
            
            .tab {
                padding: 0.75rem 1rem;
            }
            
            table {
                font-size: 0.9rem;
            }
            
            th, td {
                padding: 0.75rem 0.5rem;
            }
            
            .login-card {
                padding: 2rem 1.5rem;
            }
            
            .modal-content form > div {
                grid-template-columns: 1fr !important;
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .notification-dropdown {
                width: 280px;
                right: -80px;
            }
            
            .charts-container {
                gap: 1rem;
            }
            
            .chart-card {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <div class="header" id="header" style="display:none;">
            <div class="header-content">
                <button class="mobile-menu-btn" id="mobileMenuBtn">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-balance-scale"></i>
                    </div>
                    MEDEIROS, PAIVA & SOARES
                </div>
                <div class="user-info">
                    <div class="notifications">
                        <button class="notification-btn" id="notificationBtn" title="Notificações">
                            <i class="fas fa-bell"></i>
                            <span class="notification-badge" id="notificationBadge" style="display:none">0</span>
                        </button>
                        <div class="notification-dropdown" id="notificationDropdown">
                            <div class="notification-header">
                                <h3>Notificações</h3>
                                <button class="mark-all-read" onclick="markAllNotificationsAsRead()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:0.9rem;">Marcar todas como lidas</button>
                            </div>
                            <div class="notification-list" id="notificationList"></div>
                        </div>
                    </div>
                    <span id="userNameDisplay">Usuário</span>
                    <span id="userRole" style="opacity:.85; font-size:.95rem"></span>
                    <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> <span class="logout-text">Sair</span></button>
                </div>
            </div>
        </div>

        <div class="main-container">
            <!-- Login -->
            <div id="loginPage" class="login-container">
                <div class="login-card">
                    <div class="login-header">
                        <h2>Acesso ao Sistema</h2>
                        <p>Entre com suas credenciais para acessar o sistema</p>
                    </div>
                    <form id="loginForm">
                        <div class="form-group">
                            <label>E-mail</label>
                            <input id="email" class="form-control" type="email" required placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label>Senha</label>
                            <input id="password" class="form-control" type="password" required placeholder="Sua senha">
                        </div>
                        <div class="form-group">
                            <label>Tipo de Usuário</label>
                            <select id="userType" class="form-control" required>
                                <option value="">Selecione</option>
                                <option value="admin">Advogado/Administrador</option>
                                <option value="client">Cliente</option>
                            </select>
                        </div>
                        <button class="btn btn-full" type="submit">
                            <i class="fas fa-sign-in-alt"></i>
                            Entrar
                        </button>
                    </form>
                </div>
            </div>

            <!-- Admin Dashboard -->
            <div id="adminDashboard" class="dashboard-container" style="display:none">
                <div class="dashboard-header">
                    <h1>Dashboard do Administrador</h1>
                    <p>Gerencie clientes, processos e usuários</p>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="clients">
                        <i class="fas fa-users"></i>
                        Clientes
                    </div>
                    <div class="tab" data-tab="processes">
                        <i class="fas fa-gavel"></i>
                        Processos
                    </div>
                    <div class="tab" data-tab="users">
                        <i class="fas fa-user-cog"></i>
                        Usuários
                    </div>
                    <div class="tab" data-tab="reports">
                        <i class="fas fa-chart-bar"></i>
                        Relatórios
                    </div>
                </div>

                <div id="clients-tab" class="tab-content active">
                    <div class="form-actions">
                        <div>
                            <input id="clientSearch" class="form-control" placeholder="Buscar cliente..." style="width:100%">
                            <button class="advanced-search-toggle" onclick="toggleAdvancedSearch('clients')">
                                <i class="fas fa-filter"></i> Busca Avançada
                            </button>
                        </div>
                        <div>
                            <button class="btn" id="addClientBtn">
                                <i class="fas fa-plus"></i>
                                Adicionar Cliente
                            </button>
                        </div>
                    </div>

                    <div class="advanced-search" id="clientsAdvancedSearch" style="display:none">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <label>Status</label>
                                <select id="searchClientStatus" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="ativo">Ativo</option>
                                    <option value="inativo">Inativo</option>
                                </select>
                            </div>
                            <div>
                                <label>Data Cadastro (De)</label>
                                <input id="searchClientDateFrom" class="form-control" type="date">
                            </div>
                            <div>
                                <label>Data Cadastro (Até)</label>
                                <input id="searchClientDateTo" class="form-control" type="date">
                            </div>
                        </div>
                        <div style="margin-top: 1rem; text-align: right;">
                            <button class="btn" onclick="applyAdvancedSearch('clients')">Aplicar Filtros</button>
                            <button class="btn" onclick="clearAdvancedSearch('clients')" style="background: transparent; border: 1px solid var(--primary-dark); color: var(--primary-dark);">Limpar</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="clientsTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Telefone</th>
                                    <th>CPF/CNPJ</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="processes-tab" class="tab-content">
                    <div class="form-actions">
                        <div>
                            <input id="processSearch" class="form-control" placeholder="Buscar processo..." style="width:100%">
                            <button class="advanced-search-toggle" onclick="toggleAdvancedSearch('processes')">
                                <i class="fas fa-filter"></i> Busca Avançada
                            </button>
                        </div>
                        <button class="btn" id="addProcessBtn">
                            <i class="fas fa-plus"></i>
                            Adicionar Processo
                        </button>
                    </div>

                    <div class="advanced-search" id="processesAdvancedSearch" style="display:none">
                        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                            <div>
                                <label>Status</label>
                                <select id="searchProcessStatus" class="form-control">
                                    <option value="">Todos</option>
                                    <option value="pendente">Pendente</option>
                                    <option value="andamento">Em Andamento</option>
                                    <option value="concluido">Concluído</option>
                                    <option value="arquivado">Arquivado</option>
                                </select>
                            </div>
                            <div>
                                <label>Data Início (De)</label>
                                <input id="searchProcessDateFrom" class="form-control" type="date">
                            </div>
                            <div>
                                <label>Data Início (Até)</label>
                                <input id="searchProcessDateTo" class="form-control" type="date">
                            </div>
                        </div>
                        <div style="margin-top: 1rem; text-align: right;">
                            <button class="btn" onclick="applyAdvancedSearch('processes')">Aplicar Filtros</button>
                            <button class="btn" onclick="clearAdvancedSearch('processes')" style="background: transparent; border: 1px solid var(--primary-dark); color: var(--primary-dark);">Limpar</button>
                        </div>
                    </div>

                    <div class="table-container">
                        <table id="processesTable">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Data Início</th>
                                    <th>Advogado</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="processesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="users-tab" class="tab-content">
                    <div class="form-actions">
                        <button class="btn" id="addUserBtn">
                            <i class="fas fa-plus"></i>
                            Adicionar Usuário
                        </button>
                    </div>
                    <div class="table-container">
                        <table id="usersTable">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>E-mail</th>
                                    <th>Tipo</th>
                                    <th>Vinculado</th>
                                    <th>Status</th>
                                    <th>Último Acesso</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="reports-tab" class="tab-content">
                    <div class="form-container">
                        <div class="dashboard-header">
                            <h1>Relatórios e Analytics</h1>
                            <p>Análise de desempenho e métricas do escritório</p>
                        </div>
                        
                        <!-- Filtros -->
                        <div class="filters" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1.5rem; padding:1.5rem; background:var(--gray-light); border-radius:var(--border-radius);">
                            <div>
                                <label>Período</label>
                                <select id="reportPeriod" class="form-control">
                                    <option value="all">Todo o período</option>
                                    <option value="30">Últimos 30 dias</option>
                                    <option value="90">Últimos 3 meses</option>
                                    <option value="365">Último ano</option>
                                </select>
                            </div>
                            <div>
                                <label>Advogado</label>
                                <select id="reportLawyer" class="form-control">
                                    <option value="all">Todos</option>
                                    <option value="Dr. Lukas Medeiros">Dr. Lukas Medeiros</option>
                                    <option value="Dra. Losainny Silva">Dra. Losainny Silva</option>
                                    <option value="Taiza Barros">Taiza Barros</option>
                                    <option value="Marvilei Soares">Marvilei Soares</option>
                                </select>
                            </div>
                            <div style="display: flex; align-items: flex-end;">
                                <button class="btn" id="generateReport">
                                    <i class="fas fa-chart-line"></i>
                                    Gerar Relatório
                                </button>
                            </div>
                        </div>
                        
                        <!-- Gráficos -->
                        <div class="charts-container">
                            <div class="chart-card">
                                <h4>Processos por Status</h4>
                                <div class="chart-placeholder" id="statusChart">
                                    Gráfico será gerado aqui
                                </div>
                            </div>
                            <div class="chart-card">
                                <h4>Processos por Advogado</h4>
                                <div class="chart-placeholder" id="lawyerChart">
                                    Gráfico será gerado aqui
                                </div>
                            </div>
                        </div>
                        
                        <!-- Estatísticas -->
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-value" id="totalProcesses">0</div>
                                <div class="stat-label">Total de Processos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="activeClients">0</div>
                                <div class="stat-label">Clientes Ativos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="processesInProgress">0</div>
                                <div class="stat-label">Processos em Andamento</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="totalRevenue">R$ 0</div>
                                <div class="stat-label">Receita Total</div>
                            </div>
                        </div>
                        
                        <!-- Tabela de Processos -->
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Número</th>
                                        <th>Cliente</th>
                                        <th>Tipo</th>
                                        <th>Status</th>
                                        <th>Honorários</th>
                                        <th>Custos</th>
                                        <th>Saldo</th>
                                    </tr>
                                </thead>
                                <tbody id="reportProcessesBody">
                                    <!-- Dados carregados dinamicamente -->
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="export-options" style="display:flex; gap:1rem; margin-top:1.5rem; justify-content:flex-end;">
                            <button class="btn" onclick="exportToPDF()">
                                <i class="fas fa-file-pdf"></i>
                                Exportar PDF
                            </button>
                            <button class="btn" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i>
                                Exportar Excel
                            </button>
                        </div>

                        <!-- Backup Section -->
                        <div class="backup-section">
                            <h3>Backup de Dados</h3>
                            <div style="display: flex; gap: 1rem; margin-top: 1rem; flex-wrap: wrap;">
                                <button class="btn" onclick="exportBackup()">
                                    <i class="fas fa-download"></i>
                                    Exportar Backup
                                </button>
                                <button class="btn" onclick="importBackup()" style="background: var(--primary-dark); color: white;">
                                    <i class="fas fa-upload"></i>
                                    Importar Backup
                                </button>
                                <input type="file" id="backupFile" accept=".json" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Client Dashboard -->
            <div id="clientDashboard" class="dashboard-container" style="display:none">
                <div class="dashboard-header">
                    <h1>Área do Cliente</h1>
                    <p>Acompanhe seus processos</p>
                </div>

                <div class="tabs">
                    <div class="tab active" data-tab="my-processes">
                        <i class="fas fa-gavel"></i>
                        Meus Processos
                    </div>
                    <div class="tab" data-tab="my-documents">
                        <i class="fas fa-file-alt"></i>
                        Meus Documentos
                    </div>
                    <div class="tab" data-tab="my-profile">
                        <i class="fas fa-user"></i>
                        Meu Perfil
                    </div>
                </div>

                <div id="my-processes-tab" class="tab-content active">
                    <div class="table-container">
                        <table id="clientProcessesTable">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Data Início</th>
                                    <th>Advogado</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientProcessesTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="my-documents-tab" class="tab-content">
                    <div class="table-container">
                        <table id="clientDocumentsTable">
                            <thead>
                                <tr>
                                    <th>Documento</th>
                                    <th>Processo</th>
                                    <th>Data</th>
                                    <th>Tipo</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="clientDocumentsTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <div id="my-profile-tab" class="tab-content">
                    <form id="clientProfileForm">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                            <div class="form-group">
                                <label>Nome</label>
                                <input id="clientProfileName" class="form-control" required>
                            </div>
                            <div class="form-group">
                                <label>E-mail</label>
                                <input id="clientProfileEmail" class="form-control" required>
                            </div>
                        </div>
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                            <div class="form-group">
                                <label>Telefone</label>
                                <input id="clientProfilePhone" class="form-control">
                            </div>
                            <div class="form-group">
                                <label>CPF/CNPJ</label>
                                <input id="clientProfileCPF" class="form-control">
                            </div>
                        </div>
                        <div class="form-group" style="margin-top:1rem">
                            <label>Endereço</label>
                            <input id="clientProfileAddress" class="form-control">
                        </div>
                        <div style="margin-top:1.5rem; text-align:right">
                            <button class="btn" type="submit">
                                <i class="fas fa-save"></i>
                                Atualizar Perfil
                            </button>
                        </div>
                    </form>
                </div>
            </div>

        </div>
    </div>

    <!-- Modais: Client / Process / User -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="clientModalTitle">Adicionar Cliente</h2>
                <button class="modal-close" onclick="closeClientModal()">&times;</button>
            </div>
            <form id="clientForm">
                <input type="hidden" id="clientId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Nome</label>
                        <input id="clientName" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input id="clientEmail" class="form-control" required>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Telefone</label>
                        <input id="clientPhone" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>CPF/CNPJ</label>
                        <input id="clientCPF" class="form-control" required>
                    </div>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Endereço</label>
                    <input id="clientAddress" class="form-control">
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Status</label>
                    <select id="clientStatus" class="form-control">
                        <option value="ativo">Ativo</option>
                        <option value="inativo">Inativo</option>
                    </select>
                </div>
                <div style="margin-top:1.5rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn" onclick="closeClientModal()" style="background:transparent; border:1px solid var(--primary-dark); color:var(--primary-dark)">Cancelar</button>
                    <button class="btn" type="submit">
                        <i class="fas fa-save"></i>
                        Salvar Cliente
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="processModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="processModalTitle">Adicionar Processo</h2>
                <button class="modal-close" onclick="closeProcessModal()">&times;</button>
            </div>
            <form id="processForm">
                <input type="hidden" id="processId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Número do Processo</label>
                        <input id="processNumber" class="form-control" required>
                        <div style="font-size:.85rem; color:var(--text-medium); margin-top: 0.25rem">Formato: NNNNNN-DD.AAAA.J.TR.OOOO</div>
                    </div>
                    <div class="form-group">
                        <label>Cliente</label>
                        <select id="processClient" class="form-control" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Tipo</label>
                        <select id="processType" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="civil">Civil</option>
                            <option value="trabalhista">Trabalhista</option>
                            <option value="penal">Penal</option>
                            <option value="previdenciario">Previdenciário</option>
                            <option value="empresarial">Empresarial</option>
                            <option value="familia">Família</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="processStatus" class="form-control" required>
                            <option value="pendente">Pendente</option>
                            <option value="andamento">Em Andamento</option>
                            <option value="concluido">Concluído</option>
                            <option value="arquivado">Arquivado</option>
                        </select>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Advogado</label>
                        <select id="processLawyer" class="form-control" required>
                            <option value="">Selecione o advogado</option>
                            <option value="lucas">Dr. Lukas Medeiros</option>
                            <option value="losainny">Dra. Losainny Silva</option>
                            <option value="taiza">Taiza Barros</option>
                            <option value="marvilei">Marvilei Soares</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Data de Início</label>
                        <input id="processStartDate" class="form-control" type="date" required>
                    </div>
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Prazo Final (Opcional)</label>
                    <input id="processDeadline" class="form-control" type="date">
                </div>
                <div class="form-group" style="margin-top:1rem">
                    <label>Descrição</label>
                    <textarea id="processDescription" class="form-control" rows="4" required></textarea>
                </div>
                <div style="margin-top:1.5rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn" onclick="closeProcessModal()" style="background:transparent; border:1px solid var(--primary-dark); color:var(--primary-dark)">Cancelar</button>
                    <button class="btn" type="submit">
                        <i class="fas fa-save"></i>
                        Salvar Processo
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="userModalTitle">Adicionar Usuário</h2>
                <button class="modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Nome</label>
                        <input id="userNameInput" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>E-mail</label>
                        <input id="userEmail" class="form-control" required>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div class="form-group">
                        <label>Senha</label>
                        <input id="userPassword" class="form-control" required>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Usuário</label>
                        <select id="userTypeModal" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="admin">Administrador</option>
                            <option value="client">Cliente</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:1rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div class="form-group">
                        <label>Vincular a Cliente (opcional)</label>
                        <select id="userClientSelect" class="form-control">
                            <option value="">Nenhum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <select id="userStatus" class="form-control">
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top:1.5rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn" onclick="closeUserModal()" style="background:transparent; border:1px solid var(--primary-dark); color:var(--primary-dark)">Cancelar</button>
                    <button class="btn" type="submit">
                        <i class="fas fa-save"></i>
                        Salvar Usuário
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de detalhes do processo (timeline + finanças) -->
    <div class="modal" id="processDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Processo</h2>
                <button class="modal-close" onclick="closeProcessDetails()">&times;</button>
            </div>
            
            <!-- Tabs dentro do modal -->
            <div class="modal-tabs">
                <div class="modal-tab active" data-tab="timeline">
                    <i class="fas fa-stream"></i>
                    Timeline
                </div>
                <div class="modal-tab" data-tab="financial">
                    <i class="fas fa-chart-line"></i>
                    Financeiro
                </div>
            </div>
            
            <!-- Conteúdo da Timeline -->
            <div id="timeline-tab" class="modal-tab-content active">
                <div id="processDetailsContent"></div>
                <div id="addUpdateContainer" style="margin-top:1.5rem; border-top:1px solid #ccc; padding-top:1rem;"></div>
            </div>
            
            <!-- Conteúdo do Financeiro -->
            <div id="financial-tab" class="modal-tab-content">
                <div id="financialDetailsContent"></div>
                <div id="addFinancialContainer" style="margin-top:1.5rem; border-top:1px solid #ccc; padding-top:1rem;"></div>
            </div>
        </div>
    </div>

    <script>
        /// Configuração do Supabase
const SUPABASE_URL = 'https://vzwwmiupvfdrmgcmuldf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6d3dtaXVwdmZkcm1nY211bGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjQ2NzQsImV4cCI6MjA3OTk0MDY3NH0.tsQkCfxcZQmt6fJf6lLBnAdzl4fjQPWPAVmWlMQe1ss';

// Inicializar cliente Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- Variáveis Globais ---
let currentUser = null;
let currentProcessId = null;

// --- Funções para Supabase ---

// Clientes
async function getClients() {
    try {
        const { data, error } = await supabase
            .from('clients')
            .select('*')
            .order('name');
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar clients:', error);
        return [];
    }
}

async function saveClient(client) {
    try {
        const clientData = {
            name: client.name,
            email: client.email,
            phone: client.phone,
            cpf: client.cpf,
            address: client.address,
            status: client.status
        };

        if (client.id) {
            const { data, error } = await supabase
                .from('clients')
                .update(clientData)
                .eq('id', client.id)
                .select();
            if (error) throw error;
            return data[0];
        } else {
            const { data, error } = await supabase
                .from('clients')
                .insert([clientData])
                .select();
            if (error) throw error;
            return data[0];
        }
    } catch (error) {
        console.error('Erro ao salvar client:', error);
        return null;
    }
}

async function deleteClient(id) {
    try {
        const { error } = await supabase
            .from('clients')
            .delete()
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao excluir client:', error);
        return false;
    }
}

// Processos
async function getProcesses() {
    try {
        const { data, error } = await supabase
            .from('processos')
            .select(`
                *,
                clients (name, email),
                advogados (name)
            `)
            .order('data_abertura', { ascending: false });
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar processos:', error);
        return [];
    }
}

async function saveProcess(process) {
    try {
        // Converter lawyer name para ID
        const lawyers = await getLawyers();
        const lawyer = lawyers.find(l => l.name === process.lawyer);
        const lawyerId = lawyer ? lawyer.id : 1;

        const processData = {
            numero_processo: process.number,
            cliente_id: process.clientId,
            tipo_processo: process.type,
            status: process.status,
            descricao: process.description,
            advogado_id: lawyerId,
            data_abertura: process.startDate,
            prazo_final: process.deadline
        };

        if (process.id) {
            const { data, error } = await supabase
                .from('processos')
                .update(processData)
                .eq('id', process.id)
                .select();
            if (error) throw error;
            return data[0];
        } else {
            const { data, error } = await supabase
                .from('processos')
                .insert([processData])
                .select();
            if (error) throw error;
            return data[0];
        }
    } catch (error) {
        console.error('Erro ao salvar processo:', error);
        return null;
    }
}

async function deleteProcess(id) {
    try {
        const { error } = await supabase
            .from('processos')
            .delete()
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao excluir processo:', error);
        return false;
    }
}

// Usuários
async function getUsers() {
    try {
        const { data, error } = await supabase
            .from('usuários')
            .select('*, clients(name)')
            .order('name');
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar usuários:', error);
        return [];
    }
}

async function saveUser(user) {
    try {
        const userData = {
            name: user.name,
            email: user.email,
            password: user.password,
            user_type: user.type,
            status: user.status,
            client_id: user.clientId || null
        };

        if (user.id) {
            const { data, error } = await supabase
                .from('usuários')
                .update(userData)
                .eq('id', user.id)
                .select();
            if (error) throw error;
            return data[0];
        } else {
            const { data, error } = await supabase
                .from('usuários')
                .insert([userData])
                .select();
            if (error) throw error;
            return data[0];
        }
    } catch (error) {
        console.error('Erro ao salvar usuário:', error);
        return null;
    }
}

async function deleteUser(id) {
    try {
        const { error } = await supabase
            .from('usuários')
            .delete()
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao excluir usuário:', error);
        return false;
    }
}

// Advogados
async function getLawyers() {
    try {
        const { data, error } = await supabase
            .from('advogados')
            .select('*');
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar advogados:', error);
        return [];
    }
}

// Financeiro
async function getFinancials() {
    try {
        const { data, error } = await supabase
            .from('financeiro')
            .select('*')
            .order('date');
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar dados financeiros:', error);
        return [];
    }
}

async function saveFinancial(financial) {
    try {
        const financialData = {
            processo_id: financial.processId,
            type: financial.type,
            description: financial.description,
            value: financial.value,
            date: financial.date,
            status: financial.status
        };

        if (financial.id) {
            const { data, error } = await supabase
                .from('financeiro')
                .update(financialData)
                .eq('id', financial.id)
                .select();
            if (error) throw error;
            return data[0];
        } else {
            const { data, error } = await supabase
                .from('financeiro')
                .insert([financialData])
                .select();
            if (error) throw error;
            return data[0];
        }
    } catch (error) {
        console.error('Erro ao salvar dado financeiro:', error);
        return null;
    }
}

async function deleteFinancial(id) {
    try {
        const { error } = await supabase
            .from('financeiro')
            .delete()
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao excluir dado financeiro:', error);
        return false;
    }
}

// Notificações
async function getNotifications() {
    if (!currentUser) return [];
    try {
        const { data, error } = await supabase
            .from('notificações')
            .select('*')
            .eq('user_id', currentUser.id)
            .order('created_at', { ascending: false });
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar notificações:', error);
        return [];
    }
}

async function saveNotification(notification) {
    try {
        const { data, error } = await supabase
            .from('notificações')
            .insert([notification])
            .select();
        if (error) throw error;
        return data[0];
    } catch (error) {
        console.error('Erro ao salvar notificação:', error);
        return null;
    }
}

async function markNotificationAsRead(id) {
    try {
        const { error } = await supabase
            .from('notificações')
            .update({ read: true })
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao marcar notificação como lida:', error);
        return false;
    }
}

// Documentos
async function getDocuments() {
    try {
        const { data, error } = await supabase
            .from('documentos')
            .select('*');
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar documentos:', error);
        return [];
    }
}

// Processo Atualizações (Timeline)
async function getProcessUpdates(processId) {
    try {
        const { data, error } = await supabase
            .from('processo_atualizacoes')
            .select('*')
            .eq('processo_id', processId)
            .order('data_atualizacao', { ascending: false });
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar atualizações do processo:', error);
        return [];
    }
}

async function saveProcessUpdate(update) {
    try {
        const { data, error } = await supabase
            .from('processo_atualizacoes')
            .insert([update])
            .select();
        if (error) throw error;
        return data[0];
    } catch (error) {
        console.error('Erro ao salvar atualização do processo:', error);
        return null;
    }
}
// --- DIAGNÓSTICO DO BANCO ---
async function diagnoseDatabase() {
    console.log('🔍 INICIANDO DIAGNÓSTICO DO BANCO...');
    
    try {
        // Testar tabela de usuários
        const { data: users, error: usersError } = await supabase
            .from('usuarios')  // Tente sem acento primeiro
            .select('*')
            .limit(1);
            
        if (usersError) {
            console.log('❌ Erro na tabela usuarios:', usersError);
            
            // Tentar com acento
            const { data: users2, error: usersError2 } = await supabase
                .from('usuários')  // Tente com acento
                .select('*')
                .limit(1);
                
            if (usersError2) {
                console.log('❌ Erro na tabela usuários:', usersError2);
                console.log('📋 TABELAS EXISTENTES:');
                
                // Listar todas as tabelas
                const { data: tables } = await supabase
                    .from('information_schema.tables')
                    .select('table_name')
                    .eq('table_schema', 'public');
                    
                console.log('Tabelas disponíveis:', tables);
                return false;
            } else {
                console.log('✅ Tabela usuários (com acento) encontrada!');
                return true;
            }
        } else {
            console.log('✅ Tabela usuarios (sem acento) encontrada!');
            return true;
        }
    } catch (error) {
        console.error('❌ Erro no diagnóstico:', error);
        return false;
    }
}

// --- LOGIN COM DIAGNÓSTICO ---
async function handleLogin(e) { 
    e.preventDefault(); 
    
    console.log('🔐 TENTATIVA DE LOGIN...');
    const email = document.getElementById('email').value; 
    const password = document.getElementById('password').value; 
    const userType = document.getElementById('userType').value; 
    
    // Primeiro fazer diagnóstico
    const dbOk = await diagnoseDatabase();
    if (!dbOk) {
        alert('❌ Problema no banco de dados. Verifique o console.');
        return;
    }
    
    try {
        console.log('📧 Buscando usuário:', email);
        
        // Tentar ambas as versões do nome da tabela
        let users = [];
        let error = null;
        
        // Primeiro tente sem acento
        let { data: usersData, error: usersError } = await supabase
            .from('usuarios')
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .eq('user_type', userType === 'admin' ? 'admin' : 'client')
            .eq('status', 'ativo');
            
        if (usersError) {
            console.log('❌ Erro na tabela usuarios, tentando com acento...');
            // Tente com acento
            const result = await supabase
                .from('usuários')
                .select('*')
                .eq('email', email)
                .eq('password', password)
                .eq('user_type', userType === 'admin' ? 'admin' : 'client')
                .eq('status', 'ativo');
                
            usersData = result.data;
            usersError = result.error;
        }
        
        users = usersData;
        error = usersError;
        
        if (error) {
            console.error('❌ Erro na consulta:', error);
            alert('Erro ao acessar o banco de dados!');
            return;
        }
        
        console.log('👥 Usuários encontrados:', users);
        
        if (!users || users.length === 0) { 
            console.log('❌ Nenhum usuário encontrado com essas credenciais');
            alert('Credenciais inválidas ou usuário inativo!'); 
            return;
        }
        
        const user = users[0];
        console.log('✅ Usuário autenticado:', user);
        currentUser = user;
        
        // Atualizar último acesso
        await supabase
            .from('usuarios')
            .update({ last_access: new Date().toISOString() })
            .eq('id', user.id);
        
        showDashboard(); 
        
    } catch (error) {
        console.error('❌ Erro no login:', error);
        alert('Erro inesperado ao fazer login!');
    }
}
// --- Sistema de Login ---
async function handleLogin(e) { 
    e.preventDefault(); 
    const email = document.getElementById('email').value; 
    const password = document.getElementById('password').value; 
    const userType = document.getElementById('userType').value; 
    
    try {
        const { data: users, error } = await supabase
            .from('usuários')
            .select('*')
            .eq('email', email)
            .eq('password', password)
            .eq('user_type', userType === 'admin' ? 'admin' : 'client')
            .eq('status', 'ativo');
        
        if (error) {
            console.error('Erro no login:', error);
            alert('Erro ao fazer login!');
            return;
        }
        
        if (!users || users.length === 0) { 
            alert('Credenciais inválidas ou usuário inativo!'); 
            return;
        }
        
        const user = users[0];
        currentUser = user;
        
        // Atualizar último acesso
        await supabase
            .from('usuários')
            .update({ last_access: new Date().toISOString() })
            .eq('id', user.id);
        
        showDashboard(); 
    } catch (error) {
        console.error('Erro no login:', error);
        alert('Erro ao fazer login!');
    }
}

// --- DOM Refs ---
const loginPage = document.getElementById('loginPage'); 
const adminDashboard = document.getElementById('adminDashboard'); 
const clientDashboard = document.getElementById('clientDashboard'); 
const header = document.getElementById('header');
const loginForm = document.getElementById('loginForm'); 
const logoutBtn = document.getElementById('logoutBtn'); 
const userNameDisplay = document.getElementById('userNameDisplay'); 
const userRole = document.getElementById('userRole');
const tabs = document.querySelectorAll('.tab');

// --- Event Listeners ---
document.addEventListener('DOMContentLoaded', async ()=>{
    console.log('=== INICIANDO SISTEMA MPS ===');
    
    // Testar conexão primeiro
    await testConnection();
    
    // Verificar se há usuário salvo
    const savedUser = localStorage.getItem('currentUser');
    if(savedUser){ 
        try {
            currentUser = JSON.parse(savedUser);
            // Verificar se o usuário ainda é válido
            const { data: users } = await supabase
                .from('usuários')
                .select('*')
                .eq('id', currentUser.id)
                .eq('status', 'ativo');
                
            if (users && users.length > 0) {
                showDashboard();
            } else {
                localStorage.removeItem('currentUser');
                currentUser = null;
            }
        } catch (e) {
            localStorage.removeItem('currentUser');
            currentUser = null;
        }
    }

    // Events
    loginForm.addEventListener('submit', handleLogin); 
    logoutBtn.addEventListener('click', handleLogout);
    document.getElementById('addClientBtn').addEventListener('click', ()=>openClientModal()); 
    document.getElementById('addProcessBtn').addEventListener('click', ()=>openProcessModal()); 
    document.getElementById('addUserBtn').addEventListener('click', ()=>openUserModal());
    document.getElementById('clientForm').addEventListener('submit', handleClientSubmit); 
    document.getElementById('processForm').addEventListener('submit', handleProcessSubmit); 
    document.getElementById('userForm').addEventListener('submit', handleUserSubmit); 
    
    const clientProfileForm = document.getElementById('clientProfileForm');
    if(clientProfileForm) {
        clientProfileForm.addEventListener('submit', handleClientProfileSubmit);
    }

    document.getElementById('clientSearch').addEventListener('input', loadClientsTable); 
    document.getElementById('processSearch').addEventListener('input', loadProcessesTable);

    tabs.forEach(tab=>tab.addEventListener('click', ()=>{ 
        switchTab(tab.getAttribute('data-tab')); 
    }));

    // Configurar tabs do modal
    document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            switchModalTab(tabId);
        });
    });

    // Notificações
    document.getElementById('notificationBtn').addEventListener('click', toggleNotifications);
    
    // Verificar prazos a cada minuto
    setInterval(checkDeadlines, 60000);
    
    // Close modals on outside click
    window.addEventListener('click', function(event){ 
        ['clientModal','processModal','userModal','processDetailsModal'].forEach(id=>{ 
            const m=document.getElementById(id); 
            if(event.target===m) {
                if (id === 'processDetailsModal') closeProcessDetails();
                else m.classList.remove('active'); 
            }
        }); 
        
        // Fechar dropdown de notificações ao clicar fora
        if (!event.target.closest('.notifications')) {
            document.getElementById('notificationDropdown').classList.remove('show');
        }
    });

    // Configurar relatórios
    document.getElementById('generateReport').addEventListener('click', generateReports);
    
    // Configurar backup
    document.getElementById('backupFile').addEventListener('change', handleBackupImport);
    
    // Initial load for selects
    await populateUserClientSelect();
});

// --- Funções Principais ---
function handleLogout(){ 
    currentUser=null; 
    localStorage.removeItem('currentUser');
    showLogin(); 
}

function showLogin(){ 
    loginPage.style.display='flex'; 
    adminDashboard.style.display='none'; 
    clientDashboard.style.display='none'; 
    header.style.display='none'; 
    loginForm.reset(); 
}

async function showDashboard(){ 
    loginPage.style.display='none'; 
    header.style.display='block'; 
    userNameDisplay.textContent=currentUser.name; 
    userRole.textContent = currentUser.user_type==='admin'?'Administrador':'Cliente'; 
    
    // Salvar usuário no localStorage para persistência
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    if(currentUser.user_type==='admin'){ 
        adminDashboard.style.display='block'; 
        clientDashboard.style.display='none'; 
        await loadAdminData(); 
    } else { 
        adminDashboard.style.display='none'; 
        clientDashboard.style.display='block'; 
        await loadClientData(); 
    } 
    await loadNotifications();
    await checkDeadlines();
}

function switchTab(tabId){ 
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active')); 
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active')); 
    const tab = document.querySelector(`.tab[data-tab="${tabId}"]`); 
    if(tab) tab.classList.add('active'); 
    const content=document.getElementById(`${tabId}-tab`) || document.getElementById(`${tabId}`); 
    if(content) content.classList.add('active'); 
    
    if (tabId === 'reports') {
        generateReports();
    }
}

function switchModalTab(tabId) {
    document.querySelectorAll('.modal-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.modal-tab-content').forEach(content => content.classList.remove('active'));
    
    document.querySelector(`.modal-tab[data-tab="${tabId}"]`).classList.add('active');
    document.getElementById(`${tabId}-tab`).classList.add('active');
}

// --- Notificações ---
async function loadNotifications() {
    const notifications = await getNotifications();
    const unreadCount = notifications.filter(n => !n.read).length;
    const badge = document.getElementById('notificationBadge');
    const list = document.getElementById('notificationList');
    
    if (unreadCount > 0) {
        badge.style.display = 'flex';
        badge.textContent = unreadCount;
    } else {
        badge.style.display = 'none';
    }
    
    list.innerHTML = '';
    
    if (notifications.length === 0) {
        list.innerHTML = '<div class="notification-item" style="text-align: center; color: var(--text-medium);">Nenhuma notificação</div>';
        return;
    }
    
    notifications.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    
    notifications.forEach(notification => {
        const item = document.createElement('div');
        item.className = `notification-item ${notification.read ? '' : 'unread'}`;
        item.innerHTML = `
            <div class="notification-title">${notification.title}</div>
            <div class="notification-message">${notification.message}</div>
            <div class="notification-time">${formatDateTime(notification.created_at)}</div>
        `;
        item.addEventListener('click', () => markNotificationAsRead(notification.id));
        list.appendChild(item);
    });
}

function toggleNotifications() {
    const dropdown = document.getElementById('notificationDropdown');
    dropdown.classList.toggle('show');
}

async function markNotificationAsRead(id) {
    await markNotificationAsRead(id);
    loadNotifications();
}

async function markAllNotificationsAsRead() {
    const notifications = await getNotifications();
    for (const notification of notifications) {
        if (notification.user_id === currentUser.id && !notification.read) {
            await markNotificationAsRead(notification.id);
        }
    }
    loadNotifications();
}

async function createNotification(notificationData) {
    const notification = {
        ...notificationData,
        read: false,
        user_id: currentUser.id,
        created_at: new Date().toISOString()
    };
    await saveNotification(notification);
    loadNotifications();
}

// --- Sistema de Prazos ---
async function checkDeadlines() {
    const processes = await getProcesses();
    const today = new Date();
    const warningDate = new Date();
    warningDate.setDate(today.getDate() + 7);
    
    for (const process of processes) {
        if (process.prazo_final) {
            const deadline = new Date(process.prazo_final);
            if (deadline <= warningDate && deadline >= today) {
                const users = await getUsers();
                const lawyerUser = users.find(u => u.name === process.advogados?.name);
                if (lawyerUser) {
                    await createNotification({
                        type: 'warning',
                        title: 'Prazo próximo',
                        message: `Processo ${process.numero_processo} vence em ${formatDate(process.prazo_final)}`,
                        user_id: lawyerUser.id
                    });
                }
            }
        }
    }
}

// --- Admin data load ---
async function loadAdminData(){ 
    await loadClientsTable(); 
    await loadProcessesTable(); 
    await loadUsersTable(); 
}

async function loadClientsTable(){ 
    try {
        const clients = await getClients(); 
        const search = document.getElementById('clientSearch').value.toLowerCase(); 
        const filtered = clients.filter(c=> 
            c.name.toLowerCase().includes(search) || 
            c.email.toLowerCase().includes(search) || 
            (c.cpf||'').includes(search)
        ); 
        const tbody=document.getElementById('clientsTableBody'); 
        tbody.innerHTML=''; 
        filtered.forEach(client=>{ 
            const tr=document.createElement('tr'); 
            tr.innerHTML = `
                <td>${client.name}</td>
                <td>${client.email}</td>
                <td>${client.phone||''}</td>
                <td>${client.cpf||''}</td>
                <td><span class="status-badge ${client.status==='ativo'?'status-andamento':'status-arquivado'}">${client.status==='ativo'?'Ativo':'Inativo'}</span></td>
                <td>
                    <button class="action-btn" onclick="editClient(${client.id})" title="Editar"><i class="fas fa-edit"></i></button>
                    <button class="action-btn btn-danger" onclick="deleteClientConfirm(${client.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                </td>
            `; 
            tbody.appendChild(tr); 
        }); 
        await populateUserClientSelect(); 
    } catch (error) {
        console.error('Erro ao carregar clients:', error);
        showAlert('Erro ao carregar clients!', 'error');
    }
}

async function loadProcessesTable(){ 
    try {
        const processes = await getProcesses(); 
        const search = document.getElementById('processSearch').value.toLowerCase(); 
        const filtered = processes.filter(p=> 
            (p.numero_processo||'').toLowerCase().includes(search) || 
            (p.descricao||'').toLowerCase().includes(search)
        ); 
        const tbody=document.getElementById('processesTableBody'); 
        tbody.innerHTML=''; 
        filtered.forEach(process=>{ 
            const client = process.clients; 
            const row=document.createElement('tr'); 
            row.innerHTML = `
                <td>${process.numero_processo}</td>
                <td>${client?client.name:'N/A'}</td>
                <td>${process.tipo_processo}</td>
                <td><span class="status-badge status-${process.status}">${getStatusText(process.status)}</span></td>
                <td>${formatDate(process.data_abertura)}</td>
                <td>${process.advogados ? process.advogados.name : 'N/A'}</td>
                <td>
                    <button class="action-btn" onclick="editProcess(${process.id})" title="Editar"><i class="fas fa-edit"></i></button>
                    <button class="action-btn" onclick="viewProcess(${process.id})" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
                    <button class="action-btn btn-danger" onclick="deleteProcessConfirm(${process.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                </td>
            `; 
            tbody.appendChild(row); 
        }); 
    } catch (error) {
        console.error('Erro ao carregar processos:', error);
        showAlert('Erro ao carregar processos!', 'error');
    }
}

async function loadUsersTable(){ 
    try {
        const users = await getUsers(); 
        const tbody=document.getElementById('usersTableBody'); 
        tbody.innerHTML=''; 
        users.forEach(user=>{ 
            const clientName = user.client_id ? (user.clients?.name || 'N/A') : '-'; 
            const tr=document.createElement('tr'); 
            tr.innerHTML = `
                <td>${user.name}</td>
                <td>${user.email}</td>
                <td>${user.user_type==='admin'?'Administrador':'Cliente'}</td>
                <td>${clientName}</td>
                <td><span class="status-badge ${user.status==='ativo'?'status-andamento':'status-arquivado'}">${user.status==='ativo'?'Ativo':'Inativo'}</span></td>
                <td>${user.last_access?formatDate(user.last_access):'-'}</td>
                <td>
                    <button class="action-btn" onclick="editUser(${user.id})" title="Editar"><i class="fas fa-edit"></i></button>
                    ${user.id!==currentUser?.id?`<button class="action-btn btn-danger" onclick="deleteUserConfirm(${user.id})" title="Excluir"><i class="fas fa-trash"></i></button>`:''}
                </td>
            `; 
            tbody.appendChild(tr); 
        }); 
    } catch (error) {
        console.error('Erro ao carregar usuários:', error);
        showAlert('Erro ao carregar usuários!', 'error');
    }
}

// --- Client data load ---
async function loadClientData(){ 
    await loadClientProcessesTable(); 
    await loadClientDocumentsTable(); 
    await loadClientProfile(); 
}

async function loadClientProcessesTable(){ 
    try {
        const processes = await getProcesses(); 
        const tbody=document.getElementById('clientProcessesTableBody'); 
        tbody.innerHTML=''; 
        if(!currentUser?.client_id) return; 
        const clientProcesses = processes.filter(p=> p.cliente_id === currentUser.client_id); 
        clientProcesses.forEach(process=>{ 
            const tr=document.createElement('tr'); 
            tr.innerHTML = `
                <td>${process.numero_processo}</td>
                <td>${process.tipo_processo}</td>
                <td><span class="status-badge status-${process.status}">${getStatusText(process.status)}</span></td>
                <td>${formatDate(process.data_abertura)}</td>
                <td>${process.advogados ? process.advogados.name : 'N/A'}</td>
                <td>
                    <button class="action-btn" onclick="viewProcess(${process.id})" title="Ver Detalhes"><i class="fas fa-eye"></i></button>
                </td>
            `; 
            tbody.appendChild(tr); 
        }); 
    } catch (error) {
        console.error('Erro ao carregar processos do cliente:', error);
        showAlert('Erro ao carregar processos!', 'error');
    }
}

async function loadClientDocumentsTable(){ 
    try {
        const documents = await getDocuments(); 
        const processes = await getProcesses(); 
        const clientProcesses = processes.filter(p=> p.cliente_id === currentUser.client_id); 
        const clientDocuments = documents.filter(d=> clientProcesses.some(p=>p.id===d.processo_id)); 
        const tbody=document.getElementById('clientDocumentsTableBody'); 
        tbody.innerHTML=''; 
        clientDocuments.forEach(doc=>{ 
            const proc = processes.find(p=>p.id===doc.processo_id); 
            const tr=document.createElement('tr'); 
            tr.innerHTML = `
                <td>${doc.name}</td>
                <td>${proc?proc.numero_processo:'N/A'}</td>
                <td>${formatDate(doc.upload_date)}</td>
                <td>${doc.type}</td>
                <td>
                    <button class="action-btn" title="Download"><i class="fas fa-download"></i></button>
                    <button class="action-btn" title="Visualizar"><i class="fas fa-eye"></i></button>
                </td>
            `; 
            tbody.appendChild(tr); 
        }); 
    } catch (error) {
        console.error('Erro ao carregar documentos:', error);
        showAlert('Erro ao carregar documentos!', 'error');
    }
}

async function loadClientProfile(){ 
    try {
        const clients = await getClients(); 
        const client = clients.find(c=> c.id === currentUser.client_id); 
        if(client){ 
            document.getElementById('clientProfileName').value = client.name; 
            document.getElementById('clientProfileEmail').value = client.email; 
            document.getElementById('clientProfilePhone').value = client.phone; 
            document.getElementById('clientProfileCPF').value = client.cpf; 
            document.getElementById('clientProfileAddress').value = client.address; 
        } 
    } catch (error) {
        console.error('Erro ao carregar perfil:', error);
    }
}

// --- Modais open/close ---
async function openClientModal(id=null){ 
    const modal=document.getElementById('clientModal'); 
    const title=document.getElementById('clientModalTitle'); 
    const form=document.getElementById('clientForm'); 
    if(id){ 
        title.textContent='Editar Cliente'; 
        const clients = await getClients();
        const client = clients.find(c=>c.id===id); 
        if(client){ 
            document.getElementById('clientId').value = client.id; 
            document.getElementById('clientName').value = client.name; 
            document.getElementById('clientEmail').value = client.email; 
            document.getElementById('clientPhone').value = client.phone; 
            document.getElementById('clientCPF').value = client.cpf; 
            document.getElementById('clientAddress').value = client.address || ''; 
            document.getElementById('clientStatus').value = client.status; 
        } 
    } else { 
        title.textContent='Adicionar Cliente'; 
        form.reset(); 
        document.getElementById('clientId').value=''; 
    } 
    modal.classList.add('active'); 
}

function closeClientModal(){ 
    document.getElementById('clientModal').classList.remove('active'); 
}

async function openProcessModal(id=null){ 
    const modal=document.getElementById('processModal'); 
    const title=document.getElementById('processModalTitle'); 
    const form=document.getElementById('processForm'); 
    const clientSelect=document.getElementById('processClient'); 
    
    // Carregar clientes
    const clients = await getClients();
    clientSelect.innerHTML = '<option value="">Selecione um cliente</option>'; 
    clients.filter(c=>c.status==='ativo').forEach(c=>{ 
        const opt=document.createElement('option'); 
        opt.value=c.id; 
        opt.textContent=c.name; 
        clientSelect.appendChild(opt); 
    }); 
    
    // Carregar advogados
    const lawyers = await getLawyers();
    const lawyerSelect = document.getElementById('processLawyer');
    lawyerSelect.innerHTML = '<option value="">Selecione o advogado</option>';
    lawyers.forEach(lawyer => {
        const opt = document.createElement('option');
        opt.value = lawyer.name;
        opt.textContent = lawyer.name;
        lawyerSelect.appendChild(opt);
    });
    
    if(id){ 
        title.textContent='Editar Processo'; 
        const processes = await getProcesses();
        const proc = processes.find(p=>p.id===id); 
        if(proc){ 
            document.getElementById('processId').value=proc.id; 
            document.getElementById('processNumber').value=proc.numero_processo; 
            document.getElementById('processClient').value=proc.cliente_id; 
            document.getElementById('processType').value=proc.tipo_processo; 
            document.getElementById('processStatus').value=proc.status; 
            document.getElementById('processLawyer').value=proc.advogados?.name || ''; 
            document.getElementById('processStartDate').value=proc.data_abertura; 
            document.getElementById('processDeadline').value=proc.prazo_final || ''; 
            document.getElementById('processDescription').value=proc.descricao; 
        } 
    } else { 
        title.textContent='Adicionar Processo'; 
        form.reset(); 
        document.getElementById('processId').value=''; 
        document.getElementById('processStartDate').valueAsDate=new Date(); 
    } 
    modal.classList.add('active'); 
}

function closeProcessModal(){ 
    document.getElementById('processModal').classList.remove('active'); 
}

async function openUserModal(id=null){ 
    const modal=document.getElementById('userModal'); 
    const title=document.getElementById('userModalTitle'); 
    const form=document.getElementById('userForm'); 
    await populateUserClientSelect(); 
    if(id){ 
        title.textContent='Editar Usuário'; 
        const users = await getUsers();
        const user = users.find(u=>u.id===id); 
        if(user){ 
            document.getElementById('userId').value=user.id; 
            document.getElementById('userNameInput').value=user.name; 
            document.getElementById('userEmail').value=user.email; 
            document.getElementById('userPassword').value=user.password; 
            document.getElementById('userTypeModal').value=user.user_type; 
            document.getElementById('userStatus').value=user.status; 
            document.getElementById('userClientSelect').value = user.client_id || ''; 
        } 
    } else { 
        title.textContent='Adicionar Usuário'; 
        form.reset(); 
        document.getElementById('userId').value=''; 
    } 
    modal.classList.add('active'); 
}

function closeUserModal(){ 
    document.getElementById('userModal').classList.remove('active'); 
}

// --- Form handlers ---
async function handleClientSubmit(e){ 
    e.preventDefault(); 
    const client = { 
        id: document.getElementById('clientId').value ? parseInt(document.getElementById('clientId').value) : null, 
        name: document.getElementById('clientName').value, 
        email: document.getElementById('clientEmail').value, 
        phone: document.getElementById('clientPhone').value, 
        cpf: document.getElementById('clientCPF').value, 
        address: document.getElementById('clientAddress').value, 
        status: document.getElementById('clientStatus').value 
    }; 
    const saved = await saveClient(client); 
    if (saved) {
        await loadClientsTable(); 
        closeClientModal(); 
        showAlert('Cliente salvo com sucesso!','success'); 
        
        // Link automático com usuário de mesmo email
        const users = await getUsers(); 
        const userMatch = users.find(u=>u.email===saved.email && u.user_type==='client'); 
        if(userMatch){ 
            userMatch.client_id = saved.id; 
            await saveUser(userMatch); 
            await loadUsersTable(); 
        }
    } else {
        showAlert('Erro ao salvar cliente!', 'error');
    }
}

async function handleProcessSubmit(e){ 
    e.preventDefault(); 
    const process = { 
        id: document.getElementById('processId').value ? parseInt(document.getElementById('processId').value) : null, 
        number: document.getElementById('processNumber').value, 
        clientId: parseInt(document.getElementById('processClient').value), 
        type: document.getElementById('processType').value, 
        status: document.getElementById('processStatus').value, 
        lawyer: document.getElementById('processLawyer').value, 
        startDate: document.getElementById('processStartDate').value, 
        deadline: document.getElementById('processDeadline').value || null,
        description: document.getElementById('processDescription').value 
    }; 
    const saved = await saveProcess(process); 
    if (saved) {
        await loadProcessesTable(); 
        closeProcessModal(); 
        showAlert('Processo salvo com sucesso!','success'); 
    } else {
        showAlert('Erro ao salvar processo!', 'error');
    }
}

async function handleUserSubmit(e){ 
    e.preventDefault(); 
    const user = { 
        id: document.getElementById('userId').value ? parseInt(document.getElementById('userId').value) : null, 
        name: document.getElementById('userNameInput').value, 
        email: document.getElementById('userEmail').value, 
        password: document.getElementById('userPassword').value, 
        type: document.getElementById('userTypeModal').value, 
        status: document.getElementById('userStatus').value 
    }; 
    const clientSelect = document.getElementById('userClientSelect').value; 
    if(user.type === 'client'){ 
        if(clientSelect) user.clientId = parseInt(clientSelect); 
        else { 
            // Tentar encontrar por email
            const clients = await getClients();
            const c = clients.find(c=>c.email===user.email); 
            if(c) user.clientId = c.id; 
        }
    }
    const saved = await saveUser(user); 
    if (saved) {
        await loadUsersTable(); 
        closeUserModal(); 
        showAlert('Usuário salvo com sucesso!','success'); 
    } else {
        showAlert('Erro ao salvar usuário!', 'error');
    }
}

async function handleClientProfileSubmit(e){ 
    e.preventDefault(); 
    const client = { 
        id: currentUser.client_id, 
        name: document.getElementById('clientProfileName').value, 
        email: document.getElementById('clientProfileEmail').value, 
        phone: document.getElementById('clientProfilePhone').value, 
        cpf: document.getElementById('clientProfileCPF').value, 
        address: document.getElementById('clientProfileAddress').value, 
        status:'ativo' 
    }; 
    const saved = await saveClient(client); 
    if (saved) {
        // Atualizar usuário vinculado
        const users = await getUsers(); 
        const user = users.find(u=>u.id===currentUser.id); 
        if(user){ 
            user.name = client.name; 
            user.email = client.email; 
            await saveUser(user); 
            currentUser = user; 
            localStorage.setItem('currentUser', JSON.stringify(user)); 
            userNameDisplay.textContent = user.name; 
        }
        showAlert('Perfil atualizado com sucesso!','success'); 
    } else {
        showAlert('Erro ao atualizar perfil!', 'error');
    }
}

// --- Edit / Delete ---
function editClient(id){ openClientModal(id); }
function editProcess(id){ openProcessModal(id); }
function editUser(id){ openUserModal(id); }

async function deleteClientConfirm(id){ 
    if(confirm('Tem certeza que deseja excluir este cliente?')){ 
        const success = await deleteClient(id);
        if (success) {
            // Desvincular usuários
            const users = await getUsers(); 
            const clientUsers = users.filter(u=>u.client_id===id);
            for (const user of clientUsers) {
                user.client_id = null;
                await saveUser(user);
            }
            await loadClientsTable(); 
            await loadUsersTable(); 
            showAlert('Cliente excluído com sucesso!','success'); 
        } else {
            showAlert('Erro ao excluir cliente!', 'error');
        }
    } 
}

async function deleteProcessConfirm(id){ 
    if(confirm('Tem certeza?')){ 
        const success = await deleteProcess(id);
        if (success) {
            await loadProcessesTable(); 
            showAlert('Processo excluído com sucesso!','success'); 
        } else {
            showAlert('Erro ao excluir processo!', 'error');
        }
    } 
}

async function deleteUserConfirm(id){ 
    if(confirm('Tem certeza?')){ 
        const success = await deleteUser(id);
        if (success) {
            await loadUsersTable(); 
            showAlert('Usuário excluído com sucesso!','success'); 
        } else {
            showAlert('Erro ao excluir usuário!', 'error');
        }
    } 
}

// --- Utilities ---
function getStatusText(s){ 
    const map = { 
        'pendente':'Pendente', 
        'andamento':'Em Andamento', 
        'concluido':'Concluído', 
        'arquivado':'Arquivado' 
    }; 
    return map[s] || s; 
}

function formatDate(d){ 
    if(!d) return '-'; 
    const date = new Date(d); 
    return date.toLocaleDateString('pt-BR'); 
}

function formatDateTime(d){ 
    if(!d) return '-'; 
    const date = new Date(d); 
    return date.toLocaleString('pt-BR'); 
}

function showAlert(message, type){ 
    const main=document.querySelector('.main-container'); 
    const a=document.createElement('div'); 
    a.className = `alert alert-${type}`; 
    a.style.padding='12px'; 
    a.style.borderRadius='6px'; 
    a.style.marginBottom='12px'; 
    a.textContent = message; 
    main.insertBefore(a, main.firstChild); 
    setTimeout(()=>a.remove(),5000); 
}

// Populate client select for user modal
async function populateUserClientSelect(){ 
    const sel = document.getElementById('userClientSelect'); 
    if(!sel) return; 
    const clients = await getClients(); 
    sel.innerHTML = '<option value="">Nenhum</option>'; 
    clients.filter(c=>c.status==='ativo').forEach(c=>{ 
        const opt = document.createElement('option'); 
        opt.value = c.id; 
        opt.textContent = c.name; 
        sel.appendChild(opt); 
    }); 
}

// --- Busca Avançada ---
function toggleAdvancedSearch(type) {
    const element = document.getElementById(`${type}AdvancedSearch`);
    element.style.display = element.style.display === 'none' ? 'block' : 'none';
}

function applyAdvancedSearch(type) {
    if (type === 'clients') {
        loadClientsTable();
    } else if (type === 'processes') {
        loadProcessesTable();
    }
}

function clearAdvancedSearch(type) {
    if (type === 'clients') {
        document.getElementById('searchClientStatus').value = '';
        document.getElementById('searchClientDateFrom').value = '';
        document.getElementById('searchClientDateTo').value = '';
    } else if (type === 'processes') {
        document.getElementById('searchProcessStatus').value = '';
        document.getElementById('searchProcessDateFrom').value = '';
        document.getElementById('searchProcessDateTo').value = '';
    }
    applyAdvancedSearch(type);
}

// --- Timeline / Details ---
async function viewProcess(id){ 
    currentProcessId = id;
    const processes = await getProcesses();
    const proc = processes.find(p=>p.id===id); 
    if(!proc) return; 
    const clients = await getClients();
    const client = clients.find(c=>c.id===proc.cliente_id); 
    
    // Reset para a aba de timeline
    switchModalTab('timeline');
    
    const updates = await getProcessUpdates(id);
    
    let html = `<h3 style="margin-bottom:.25rem">${proc.numero_processo}</h3><div style="font-size:.95rem; color:var(--text-medium); margin-bottom:.75rem">Cliente: ${client?client.name:'N/A'} • Advogado: ${proc.advogados?.name || 'N/A'}</div><p style="margin-bottom:.75rem">${proc.descricao}</p><h4>Timeline</h4><div class="timeline">`; 
    updates.forEach(u=>{ 
        html += `<div class="timeline-item"><span class="timeline-date">${formatDate(u.data_atualizacao)}</span><div class="timeline-desc">${u.description}</div></div>`; 
    }); 
    html += `</div>`; 
    document.getElementById('processDetailsContent').innerHTML = html;
    
    // Adicionar formulário para adicionar atualizações (apenas para admin)
    const addUpdateContainer = document.getElementById('addUpdateContainer');
    if(currentUser.user_type === 'admin') {
        addUpdateContainer.innerHTML = `
            <h4>Adicionar Atualização</h4>
            <form id="addUpdateForm">
                <input type="hidden" id="updateProcessId" value="${proc.id}">
                <div style="margin-bottom:1rem">
                    <label>Descrição da Atualização</label>
                    <textarea id="updateDescription" class="form-control" rows="3" required></textarea>
                </div>
                <div style="text-align:right">
                    <button type="submit" class="btn">Adicionar</button>
                </div>
            </form>
        `;
        
        document.getElementById('addUpdateForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const processId = parseInt(document.getElementById('updateProcessId').value);
            const description = document.getElementById('updateDescription').value;
            
            if(!description) return;
            
            const update = {
                processo_id: processId,
                data_atualizacao: new Date().toISOString().split('T')[0],
                description: description
            };
            
            const saved = await saveProcessUpdate(update);
            if (saved) {
                await viewProcess(processId);
                showAlert('Atualização adicionada com sucesso!', 'success');
            } else {
                showAlert('Erro ao adicionar atualização!', 'error');
            }
        });
    } else {
        addUpdateContainer.innerHTML = '';
    }
    
    // Carregar dados financeiros
    await loadFinancialData(id);
    
    document.getElementById('processDetailsModal').classList.add('active'); 
}

// --- Verificação de permissão para financeiro ---
function checkFinancialAccess() {
    return currentUser && currentUser.user_type === 'admin';
}

async function loadFinancialData(processId) {
    // VERIFICAÇÃO DE PERMISSÃO
    if (!checkFinancialAccess()) {
        const financialContainer = document.getElementById('financialDetailsContent');
        financialContainer.innerHTML = `
            <div class="alert alert-error">
                <i class="fas fa-lock"></i> Acesso restrito. Apenas administradores podem visualizar informações financeiras.
            </div>
        `;
        document.getElementById('addFinancialContainer').innerHTML = '';
        return;
    }
    
    const financials = await getFinancials();
    const processFinancials = financials.filter(f => f.processo_id === processId);
    const financialContainer = document.getElementById('financialDetailsContent');
    
    let html = `<h4>Resumo Financeiro</h4>`;
    
    // Calcular totais
    const honorarios = processFinancials.filter(f => f.type === 'honorario').reduce((sum, f) => sum + f.value, 0);
    const custos = processFinancials.filter(f => f.type === 'custo').reduce((sum, f) => sum + f.value, 0);
    const saldo = honorarios - custos;
    
    html += `
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--success);">R$ ${honorarios.toLocaleString('pt-BR')}</div>
                <div style="font-size: 0.9rem; color: var(--text-medium);">Honorários</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: var(--danger);">R$ ${custos.toLocaleString('pt-BR')}</div>
                <div style="font-size: 0.9rem; color: var(--text-medium);">Custos</div>
            </div>
            <div style="text-align: center; padding: 1rem; background: #f8f9fa; border-radius: 8px;">
                <div style="font-size: 1.5rem; font-weight: bold; color: ${saldo >= 0 ? 'var(--success)' : 'var(--danger)'};">R$ ${saldo.toLocaleString('pt-BR')}</div>
                <div style="font-size: 0.9rem; color: var(--text-medium);">Saldo</div>
            </div>
        </div>
    `;
    
    html += `<h4>Lançamentos Financeiros</h4>`;
    
    if (processFinancials.length > 0) {
        html += `
            <table style="width: 100%; border-collapse: collapse;">
                <thead>
                    <tr style="background: var(--primary-dark); color: var(--text-light);">
                        <th style="padding: 0.75rem;">Data</th>
                        <th style="padding: 0.75rem;">Tipo</th>
                        <th style="padding: 0.75rem;">Descrição</th>
                        <th style="padding: 0.75rem;">Valor</th>
                        <th style="padding: 0.75rem;">Status</th>
                        <th style="padding: 0.75rem;">Ações</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        processFinancials.forEach(financial => {
            const tipoText = financial.type === 'honorario' ? 'Honorário' : 'Custo';
            const tipoClass = financial.type === 'honorario' ? 'financial-receita' : 'financial-despesa';
            const statusClass = financial.status === 'pago' ? 'financial-pago' : 'financial-pendente';
            const statusText = financial.status === 'pago' ? 'Pago' : 'Pendente';
            
            html += `
                <tr>
                    <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">${formatDate(financial.date)}</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;"><span class="financial-badge ${tipoClass}">${tipoText}</span></td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">${financial.description}</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">R$ ${financial.value.toLocaleString('pt-BR')}</td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;"><span class="financial-badge ${statusClass}">${statusText}</span></td>
                    <td style="padding: 0.75rem; border-bottom: 1px solid #e0e0e0;">
                        <button class="action-btn" onclick="editFinancial(${financial.id})" title="Editar"><i class="fas fa-edit"></i></button>
                        <button class="action-btn btn-danger" onclick="deleteFinancialConfirm(${financial.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `;
        });
        
        html += `</tbody></table>`;
    } else {
        html += `<p style="text-align: center; color: var(--text-medium); padding: 2rem;">Nenhum lançamento financeiro registrado.</p>`;
    }
    
    financialContainer.innerHTML = html;
    
    // Adicionar formulário para novos lançamentos (apenas para admin)
    const addFinancialContainer = document.getElementById('addFinancialContainer');
    if(currentUser.user_type === 'admin') {
        addFinancialContainer.innerHTML = `
            <h4>Adicionar Lançamento Financeiro</h4>
            <form id="addFinancialForm">
                <input type="hidden" id="financialProcessId" value="${processId}">
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label>Tipo</label>
                        <select id="financialType" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="honorario">Honorário</option>
                            <option value="custo">Custo</option>
                        </select>
                    </div>
                    <div>
                        <label>Status</label>
                        <select id="financialStatus" class="form-control" required>
                            <option value="pendente">Pendente</option>
                            <option value="pago">Pago</option>
                        </select>
                    </div>
                </div>
                <div style="margin-bottom: 1rem">
                    <label>Descrição</label>
                    <input type="text" id="financialDescription" class="form-control" required>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-bottom: 1rem;">
                    <div>
                        <label>Valor (R$)</label>
                        <input type="number" id="financialValue" class="form-control" step="0.01" min="0" required>
                    </div>
                    <div>
                        <label>Data</label>
                        <input type="date" id="financialDate" class="form-control" required>
                    </div>
                </div>
                <div style="text-align:right">
                    <button type="submit" class="btn">Adicionar</button>
                </div>
            </form>
        `;
        
        // Definir data atual como padrão
        document.getElementById('financialDate').valueAsDate = new Date();
        
        document.getElementById('addFinancialForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const processId = parseInt(document.getElementById('financialProcessId').value);
            const type = document.getElementById('financialType').value;
            const description = document.getElementById('financialDescription').value;
            const value = parseFloat(document.getElementById('financialValue').value);
            const date = document.getElementById('financialDate').value;
            const status = document.getElementById('financialStatus').value;
            
            if(!type || !description || !value) return;
            
            const financial = {
                processId: processId,
                type: type,
                description: description,
                value: value,
                date: date,
                status: status
            };
            
            const saved = await saveFinancial(financial);
            if (saved) {
                await loadFinancialData(processId);
                showAlert('Lançamento financeiro adicionado com sucesso!', 'success');
                
                // Limpar formulário
                document.getElementById('addFinancialForm').reset();
                document.getElementById('financialDate').valueAsDate = new Date();
            } else {
                showAlert('Erro ao adicionar lançamento financeiro!', 'error');
            }
        });
    } else {
        addFinancialContainer.innerHTML = '';
    }
}

function closeProcessDetails(){ 
    document.getElementById('processDetailsModal').classList.remove('active'); 
    document.getElementById('addUpdateContainer').innerHTML = '';
    document.getElementById('addFinancialContainer').innerHTML = '';
    currentProcessId = null;
}

async function editFinancial(id) {
    const financials = await getFinancials();
    const financial = financials.find(f => f.id === id);
    if (!financial) return;
    
    // Preencher o formulário com os dados existentes
    document.getElementById('financialType').value = financial.type;
    document.getElementById('financialStatus').value = financial.status;
    document.getElementById('financialDescription').value = financial.description;
    document.getElementById('financialValue').value = financial.value;
    document.getElementById('financialDate').value = financial.date;
    
    // Rolar para o formulário
    document.getElementById('addFinancialContainer').scrollIntoView({ behavior: 'smooth' });
    
    // Alterar o botão para "Atualizar"
    const form = document.getElementById('addFinancialForm');
    const submitButton = form.querySelector('button[type="submit"]');
    submitButton.textContent = 'Atualizar';
    submitButton.onclick = async function(e) {
        e.preventDefault();
        
        // Atualizar o lançamento
        financial.type = document.getElementById('financialType').value;
        financial.status = document.getElementById('financialStatus').value;
        financial.description = document.getElementById('financialDescription').value;
        financial.value = parseFloat(document.getElementById('financialValue').value);
        financial.date = document.getElementById('financialDate').value;
        
        const saved = await saveFinancial(financial);
        if (saved) {
            await loadFinancialData(currentProcessId);
            showAlert('Lançamento financeiro atualizado com sucesso!', 'success');
            
            // Restaurar o formulário para adição
            document.getElementById('addFinancialForm').reset();
            document.getElementById('financialDate').valueAsDate = new Date();
            submitButton.textContent = 'Adicionar';
            submitButton.onclick = null;
        } else {
            showAlert('Erro ao atualizar lançamento financeiro!', 'error');
        }
    };
}

async function deleteFinancialConfirm(id) {
    if(confirm('Tem certeza que deseja excluir este lançamento financeiro?')) {
        const success = await deleteFinancial(id);
        if (success) {
            await loadFinancialData(currentProcessId);
            showAlert('Lançamento financeiro excluído com sucesso!', 'success');
        } else {
            showAlert('Erro ao excluir lançamento financeiro!', 'error');
        }
    }
}

// --- Relatórios ---
async function generateReports() {
    const period = document.getElementById('reportPeriod').value;
    const lawyer = document.getElementById('reportLawyer').value;
    
    // Obter dados
    const processes = await getProcesses();
    const clients = await getClients();
    const financials = await getFinancials();
    
    // Aplicar filtros
    let filteredProcesses = processes;
    
    if (lawyer !== 'all') {
        filteredProcesses = filteredProcesses.filter(p => p.advogados?.name === lawyer);
    }
    
    if (period !== 'all') {
        const days = parseInt(period);
        const cutoffDate = new Date();
        cutoffDate.setDate(cutoffDate.getDate() - days);
        
        filteredProcesses = filteredProcesses.filter(p => {
            const processDate = new Date(p.data_abertura);
            return processDate >= cutoffDate;
        });
    }
    
    // Calcular totais financeiros
    let totalRevenue = 0;
    let totalExpenses = 0;
    
    filteredProcesses.forEach(process => {
        const processFinancials = financials.filter(f => f.processo_id === process.id);
        const honorarios = processFinancials.filter(f => f.type === 'honorario').reduce((sum, f) => sum + f.value, 0);
        const custos = processFinancials.filter(f => f.type === 'custo').reduce((sum, f) => sum + f.value, 0);
        
        totalRevenue += honorarios;
        totalExpenses += custos;
    });
    
    // Atualizar estatísticas
    document.getElementById('totalProcesses').textContent = filteredProcesses.length;
    document.getElementById('activeClients').textContent = clients.filter(c => c.status === 'ativo').length;
    document.getElementById('processesInProgress').textContent = filteredProcesses.filter(p => p.status === 'andamento').length;
    document.getElementById('totalRevenue').textContent = `R$ ${totalRevenue.toLocaleString('pt-BR')}`;
    
    // Atualizar gráficos
    renderCharts(filteredProcesses);
    
    // Atualizar tabela de processos
    updateProcessesReportTable(filteredProcesses, clients, financials);
}

function updateProcessesReportTable(processes, clients, financials) {
    const tbody = document.getElementById('reportProcessesBody');
    tbody.innerHTML = '';
    
    processes.forEach(process => {
        const client = clients.find(c => c.id === process.cliente_id);
        const processFinancials = financials.filter(f => f.processo_id === process.id);
        const honorarios = processFinancials.filter(f => f.type === 'honorario').reduce((sum, f) => sum + f.value, 0);
        const custos = processFinancials.filter(f => f.type === 'custo').reduce((sum, f) => sum + f.value, 0);
        const saldo = honorarios - custos;
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${process.numero_processo}</td>
            <td>${client ? client.name : 'N/A'}</td>
            <td>${process.tipo_processo}</td>
            <td><span class="status-badge status-${process.status}">${getStatusText(process.status)}</span></td>
            <td>R$ ${honorarios.toLocaleString('pt-BR')}</td>
            <td>R$ ${custos.toLocaleString('pt-BR')}</td>
            <td style="font-weight: bold; color: ${saldo >= 0 ? 'var(--success)' : 'var(--danger)'};">R$ ${saldo.toLocaleString('pt-BR')}</td>
        `;
        tbody.appendChild(row);
    });
    
    if (processes.length === 0) {
        const row = document.createElement('tr');
        row.innerHTML = `<td colspan="7" style="text-align: center; color: var(--text-medium);">Nenhum processo encontrado</td>`;
        tbody.appendChild(row);
    }
}

function renderCharts(processes) {
    // Gráfico de status
    const statusCount = {
        'pendente': processes.filter(p => p.status === 'pendente').length,
        'andamento': processes.filter(p => p.status === 'andamento').length,
        'concluido': processes.filter(p => p.status === 'concluido').length,
        'arquivado': processes.filter(p => p.status === 'arquivado').length
    };
    
    const statusChart = document.getElementById('statusChart');
    statusChart.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Pendente</span>
                <span style="font-weight: bold;">${statusCount.pendente}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Em Andamento</span>
                <span style="font-weight: bold;">${statusCount.andamento}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Concluído</span>
                <span style="font-weight: bold;">${statusCount.concluido}</span>
            </div>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span>Arquivado</span>
                <span style="font-weight: bold;">${statusCount.arquivado}</span>
            </div>
        </div>
    `;
    
    // Gráfico de advogados
    const lawyerCount = {};
    processes.forEach(p => {
        const lawyerName = p.advogados?.name || 'Sem advogado';
        lawyerCount[lawyerName] = (lawyerCount[lawyerName] || 0) + 1;
    });
    
    const lawyerChart = document.getElementById('lawyerChart');
    lawyerChart.innerHTML = `
        <div style="display: flex; flex-direction: column; gap: 0.5rem; padding: 1rem;">
            ${Object.entries(lawyerCount).map(([lawyer, count]) => `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${lawyer}</span>
                    <span style="font-weight: bold;">${count}</span>
                </div>
            `).join('')}
        </div>
    `;
}

function exportToPDF() {
    alert('Funcionalidade de exportação para PDF será implementada em breve!');
}

function exportToExcel() {
    const table = document.querySelector('#reports-tab table');
    if (!table) {
        alert('Nenhuma tabela encontrada para exportar.');
        return;
    }

    let csv = [];
    
    // Obter cabeçalhos
    const headers = [];
    table.querySelectorAll('thead th').forEach(th => {
        headers.push(th.innerText);
    });
    csv.push(headers.join(','));
    
    // Obter linhas de dados
    table.querySelectorAll('tbody tr').forEach(tr => {
        const row = [];
        tr.querySelectorAll('td').forEach(td => {
            let text = td.innerText.replace(/(\r\n|\n|\r)/gm, "").replace(/,/g, ";");
            row.push(text);
        });
        csv.push(row.join(','));
    });
    
    const csvString = csv.join('\n');
    const blob = new Blob([csvString], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    const url = URL.createObjectURL(blob);
    link.setAttribute('href', url);
    link.setAttribute('download', 'relatorio_processos.csv');
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showAlert('Relatório exportado com sucesso!', 'success');
}

// --- Backup e Restauração ---
async function exportBackup() {
    const backupData = {
        clients: await getClients(),
        processes: await getProcesses(),
        users: await getUsers(),
        documents: await getDocuments(),
        financials: await getFinancials(),
        notifications: await getNotifications(),
        exportDate: new Date().toISOString()
    };
    
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `backup_mps_${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showAlert('Backup exportado com sucesso!', 'success');
}

function importBackup() {
    document.getElementById('backupFile').click();
}

async function handleBackupImport(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = async function(e) {
        try {
            const backupData = JSON.parse(e.target.result);
            
            // Validar estrutura do backup
            if (!backupData.clients || !backupData.processes || !backupData.users) {
                throw new Error('Arquivo de backup inválido');
            }
            
            showAlert('Importando backup...', 'info');
            
            // Restaurar dados
            for (const client of backupData.clients) {
                await saveClient(client);
            }
            for (const process of backupData.processes) {
                await saveProcess(process);
            }
            for (const user of backupData.users) {
                await saveUser(user);
            }
            
            // Recarregar dados
            if (currentUser.user_type === 'admin') {
                await loadAdminData();
            } else {
                await loadClientData();
            }
            
            showAlert('Backup restaurado com sucesso!', 'success');
            
            // Limpar input
            event.target.value = '';
            
        } catch (error) {
            alert('Erro ao importar backup: ' + error.message);
        }
    };
    reader.readAsText(file);
}

// --- Loading States ---
function showLoading() {
    const loading = document.createElement('div');
    loading.id = 'loadingOverlay';
    loading.innerHTML = `
        <div style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; justify-content: center; align-items: center; z-index: 9999;">
            <div style="background: white; padding: 2rem; border-radius: 8px; display: flex; align-items: center; gap: 1rem;">
                <div class="spinner"></div>
                <span>Carregando...</span>
            </div>
        </div>
    `;
    document.body.appendChild(loading);
}

function hideLoading() {
    const loading = document.getElementById('loadingOverlay');
    if (loading) loading.remove();
}

// --- Teste de Conexão ---
async function testConnection() {
    try {
        const tablesToTest = ['clients', 'usuários', 'processos', 'advogados'];
        let successCount = 0;
        
        for (let table of tablesToTest) {
            const { data, error } = await supabase
                .from(table)
                .select('count')
                .limit(1);
                
            if (!error) {
                console.log(`✅ Tabela ${table} encontrada!`);
                successCount++;
            } else {
                console.log(`❌ Tabela ${table} não encontrada:`, error.message);
            }
        }
        
        if (successCount === tablesToTest.length) {
            console.log('✅ Todas as tabelas necessárias encontradas!');
            return true;
        } else {
            console.log(`⚠️ Apenas ${successCount} de ${tablesToTest.length} tabelas encontradas`);
            return false;
        }
    } catch (error) {
        console.error('Erro completo na conexão:', error);
        showAlert('❌ Erro na conexão com o banco de dados. Verifique o console.', 'error');
        return false;
    }
}

// Inicialização final
console.log('Sistema MPS Advogados carregado com sucesso!');
    </script>
</body>
</html>