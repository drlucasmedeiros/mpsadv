<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema MPS Advogados - Gestão Completa</title>
    
    <!-- Fontes e ícones -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.cdnfonts.com/css/neue-haas-grotesk-display-pro" rel="stylesheet">
    <!-- Seus meta tags e estilos atuais -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root{
            --primary-dark:#001A1A; --primary-medium:#002B2B; --primary-light:#004D4D;
            --accent:#C9A769; --accent-light:#D4B989; --text-light:#f8f8f8; --text-dark:#1A1A1A;
            --text-medium:#5A5A5A; --white:#ffffff; --gray-light:#f5f5f5; --transition: all .4s cubic-bezier(.23,1,.32,1);
            --success:#28a745; --warning:#ffc107; --danger:#dc3545; --info:#17a2b8;
        }
        body{ font-family:'Neue Haas Grotesk Display Pro',sans-serif; background:var(--white); color:var(--text-dark); }
        .header{ background:linear-gradient(135deg,var(--primary-dark) 0%,var(--primary-medium) 50%,var(--primary-light) 100%); padding:1.5rem 3rem; color:var(--text-light); }
        .header-content{ max-width:1200px; margin:0 auto; display:flex; justify-content:space-between; align-items:center; }
        .logo{ font-family:'Big River',serif; font-size:1.8rem; letter-spacing:1.5px; text-transform:uppercase; }
        .user-info{ display:flex; gap:1rem; align-items:center }
        .logout-btn{ background:transparent; border:1px solid var(--accent); color:var(--accent); padding:.5rem 1.2rem; border-radius:4px; cursor:pointer }

        .main-container{ max-width:1200px; margin:0 auto; padding:2rem 3rem; min-height:calc(100vh - 120px); }
        .login-container{ display:flex; justify-content:center; align-items:center; min-height:80vh }
        .login-card{ padding:3rem; border-radius:8px; box-shadow:0 10px 30px rgba(0,0,0,.06); max-width:450px }
        .form-control{ width:100%; padding:1rem; border-radius:4px; border:1px solid rgba(0,0,0,.08) }
        .btn{ background:var(--accent); color:var(--primary-dark); padding:1rem 1.6rem; border:none; border-radius:4px; cursor:pointer }

        /* Tabelas e abas */
        .tabs{ display:flex; gap:0.5rem; margin-bottom:1rem }
        .tab{ padding:1rem 1.2rem; cursor:pointer }
        .tab.active{ border-bottom:2px solid var(--accent); }
        .tab-content{ display:none }
        .tab-content.active{ display:block }

        table{ width:100%; border-collapse:collapse }
        th, td{ padding:1rem; text-align:left }
        thead{ background:var(--primary-dark); color:var(--text-light) }

        /* Modal base */
        .modal{ display:none; position:fixed; inset:0; background:rgba(0,0,0,.45); z-index:1000; align-items:center; justify-content:center }
        .modal.active{ display:flex }
        .modal-content{ background:var(--white); width:90%; max-width:900px; border-radius:8px; padding:1.6rem; max-height:90vh; overflow:auto }
        .modal-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem }
        .modal-close{ background:none; border:none; font-size:1.6rem; cursor:pointer }

        /* Timeline */
        .timeline{ border-left:3px solid var(--accent); padding-left:18px; margin-top:8px }
        .timeline-item{ margin-bottom:18px; position:relative }
        .timeline-item::before{ content:""; width:12px; height:12px; background:var(--accent); border-radius:50%; position:absolute; left:-30px; top:6px }
        .timeline-date{ display:block; font-size:0.9rem; color:var(--text-medium); margin-bottom:4px }

        /* Tabs dentro do modal */
        .modal-tabs { display: flex; border-bottom: 1px solid #e0e0e0; margin-bottom: 1rem; }
        .modal-tab { padding: 0.75rem 1.5rem; cursor: pointer; border-bottom: 2px solid transparent; }
        .modal-tab.active { border-bottom: 2px solid var(--accent); color: var(--primary-dark); font-weight: 500; }
        .modal-tab-content { display: none; }
        .modal-tab-content.active { display: block; }

        /* Status badges */
        .status-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .status-pendente { background-color: #FFF3CD; color: #856404; }
        .status-andamento { background-color: #D1ECF1; color: #0C5460; }
        .status-concluido { background-color: #D4EDDA; color: #155724; }
        .status-arquivado { background-color: #E2E3E5; color: #383D41; }

        /* Financial badges */
        .financial-badge {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .financial-receita { background-color: #D4EDDA; color: #155724; }
        .financial-despesa { background-color: #F8D7DA; color: #721C24; }
        .financial-pendente { background-color: #FFF3CD; color: #856404; }
        .financial-pago { background-color: #D1ECF1; color: #0C5460; }

        /* Alertas */
        .alert {
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1.5rem;
        }
        
        .alert-success {
            background-color: #D4EDDA;
            color: #155724;
            border: 1px solid #C3E6CB;
        }
        
        .alert-error {
            background-color: #F8D7DA;
            color: #721C24;
            border: 1px solid #F5C6CB;
        }

        /* Botões de ação */
        .action-btn {
            background: none;
            border: none;
            color: var(--primary-dark);
            cursor: pointer;
            font-size: 1rem;
            margin-right: 0.8rem;
            transition: var(--transition);
        }
        
        .action-btn:hover {
            color: var(--accent);
        }
        
        .btn-danger {
            color: #dc3545;
        }
        
        .btn-danger:hover {
            color: #c82333;
        }

        /* Estatísticas */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }
        
        .stat-label {
            color: var(--text-medium);
            font-size: 0.9rem;
        }

        /* Notificações */
        .notifications {
            position: relative;
        }
        
        .notification-btn {
            background: none;
            border: none;
            font-size: 1.2rem;
            color: var(--text-light);
            cursor: pointer;
            position: relative;
            padding: 0.5rem;
        }
        
        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--danger);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            width: 350px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }
        
        .notification-dropdown.show {
            display: block;
        }
        
        .notification-header {
            padding: 1rem;
            border-bottom: 1px solid #e0e0e0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-item {
            padding: 1rem;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
        }
        
        .notification-item.unread {
            background: #f8f9fa;
        }
        
        .notification-item:hover {
            background: #f0f0f0;
        }
        
        .notification-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .notification-message {
            font-size: 0.9rem;
            color: var(--text-medium);
        }
        
        .notification-time {
            font-size: 0.8rem;
            color: var(--text-medium);
            margin-top: 0.25rem;
        }

        /* Gráficos */
        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin: 1.5rem 0;
        }
        
        .chart-card {
            background: var(--white);
            border-radius: 8px;
            padding: 1.5rem;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .chart-card h4 {
            margin-bottom: 1rem;
            text-align: center;
        }
        
        .chart-placeholder {
            height: 200px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            border-radius: 4px;
            color: var(--text-medium);
        }

        /* Busca Avançada */
        .advanced-search {
            background: var(--gray-light);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }
        
        .advanced-search-toggle {
            background: none;
            border: none;
            color: var(--primary-dark);
            cursor: pointer;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
        }

        /* Loading */
        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid var(--accent);
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Backup Section */
        .backup-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--gray-light);
            border-radius: 8px;
        }

        /* Small screens */
        @media (max-width:768px){ 
            .main-container{ padding:1rem } 
            .modal-content { width: 95%; padding: 1rem; }
            .charts-container { grid-template-columns: 1fr; }
            .notification-dropdown { width: 300px; right: -50px; }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header" id="header" style="display:none;">
        <div class="header-content">
            <div class="logo">MEDEIROS, PAIVA & SOARES</div>
            <div class="user-info">
                <div class="notifications">
                    <button class="notification-btn" id="notificationBtn" title="Notificações">
                        <i class="fas fa-bell"></i>
                        <span class="notification-badge" id="notificationBadge" style="display:none">0</span>
                    </button>
                    <div class="notification-dropdown" id="notificationDropdown">
                        <div class="notification-header">
                            <h3>Notificações</h3>
                            <button class="mark-all-read" onclick="markAllNotificationsAsRead()" style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:0.9rem;">Marcar todas como lidas</button>
                        </div>
                        <div class="notification-list" id="notificationList"></div>
                    </div>
                </div>
                <span id="userNameDisplay">Usuário</span>
                <span id="userRole" style="opacity:.85; font-size:.95rem"></span>
                <button class="logout-btn" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Sair</button>
            </div>
        </div>
    </div>

    <div class="main-container">
        <!-- Login -->
        <div id="loginPage" class="login-container">
            <div class="login-card">
                <h2>Acesso ao Sistema</h2>
                <p>Entre com suas credenciais para acessar o sistema</p>
                <form id="loginForm">
                    <div class="form-group"><label>E-mail</label><input id="email" class="form-control" type="email" required></div>
                    <div class="form-group"><label>Senha</label><input id="password" class="form-control" type="password" required></div>
                    <div class="form-group"><label>Tipo de Usuário</label>
                        <select id="userType" class="form-control" required>
                            <option value="">Selecione</option>
                            <option value="admin">Advogado/Administrador</option>
                            <option value="client">Cliente</option>
                        </select>
                    </div>
                    <button class="btn btn-full" type="submit">Entrar</button>
                </form>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="adminDashboard" class="dashboard-container" style="display:none">
            <div class="dashboard-header"><h1>Dashboard do Administrador</h1><p>Gerencie clientes, processos e usuários</p></div>

            <div class="tabs">
                <div class="tab active" data-tab="clients">Clientes</div>
                <div class="tab" data-tab="processes">Processos</div>
                <div class="tab" data-tab="users">Usuários</div>
                <div class="tab" data-tab="reports">Relatórios</div>
            </div>

            <div id="clients-tab" class="tab-content active">
                <div class="form-actions" style="display:flex; justify-content:space-between; margin-bottom:1rem">
                    <div>
                        <input id="clientSearch" class="form-control" placeholder="Buscar cliente..." style="width:320px">
                        <button class="advanced-search-toggle" onclick="toggleAdvancedSearch('clients')">
                            <i class="fas fa-filter"></i> Busca Avançada
                        </button>
                    </div>
                    <div>
                        <button class="btn" id="addClientBtn">Adicionar Cliente</button>
                    </div>
                </div>

                <div class="advanced-search" id="clientsAdvancedSearch" style="display:none">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Status</label>
                            <select id="searchClientStatus" class="form-control">
                                <option value="">Todos</option>
                                <option value="ativo">Ativo</option>
                                <option value="inativo">Inativo</option>
                            </select>
                        </div>
                        <div>
                            <label>Data Cadastro (De)</label>
                            <input id="searchClientDateFrom" class="form-control" type="date">
                        </div>
                        <div>
                            <label>Data Cadastro (Até)</label>
                            <input id="searchClientDateTo" class="form-control" type="date">
                        </div>
                    </div>
                    <div style="margin-top: 1rem; text-align: right;">
                        <button class="btn" onclick="applyAdvancedSearch('clients')">Aplicar Filtros</button>
                        <button class="btn" onclick="clearAdvancedSearch('clients')" style="background: transparent; border: 1px solid var(--primary-dark); color: var(--primary-dark);">Limpar</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="clientsTable"><thead><tr><th>Nome</th><th>E-mail</th><th>Telefone</th><th>CPF/CNPJ</th><th>Status</th><th>Ações</th></tr></thead>
                    <tbody id="clientsTableBody"></tbody></table>
                </div>
            </div>

            <div id="processes-tab" class="tab-content">
                <div class="form-actions" style="display:flex; justify-content:space-between; margin-bottom:1rem">
                    <div>
                        <input id="processSearch" class="form-control" placeholder="Buscar processo..." style="width:320px">
                        <button class="advanced-search-toggle" onclick="toggleAdvancedSearch('processes')">
                            <i class="fas fa-filter"></i> Busca Avançada
                        </button>
                    </div>
                    <button class="btn" id="addProcessBtn">Adicionar Processo</button>
                </div>

                <div class="advanced-search" id="processesAdvancedSearch" style="display:none">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                        <div>
                            <label>Status</label>
                            <select id="searchProcessStatus" class="form-control">
                                <option value="">Todos</option>
                                <option value="pendente">Pendente</option>
                                <option value="andamento">Em Andamento</option>
                                <option value="concluido">Concluído</option>
                                <option value="arquivado">Arquivado</option>
                            </select>
                        </div>
                        <div>
                            <label>Data Início (De)</label>
                            <input id="searchProcessDateFrom" class="form-control" type="date">
                        </div>
                        <div>
                            <label>Data Início (Até)</label>
                            <input id="searchProcessDateTo" class="form-control" type="date">
                        </div>
                    </div>
                    <div style="margin-top: 1rem; text-align: right;">
                        <button class="btn" onclick="applyAdvancedSearch('processes')">Aplicar Filtros</button>
                        <button class="btn" onclick="clearAdvancedSearch('processes')" style="background: transparent; border: 1px solid var(--primary-dark); color: var(--primary-dark);">Limpar</button>
                    </div>
                </div>

                <div class="table-container">
                    <table id="processesTable"><thead><tr><th>Número</th><th>Cliente</th><th>Tipo</th><th>Status</th><th>Data Início</th><th>Advogado</th><th>Ações</th></tr></thead>
                    <tbody id="processesTableBody"></tbody></table>
                </div>
            </div>

            <div id="users-tab" class="tab-content">
                <div class="form-actions" style="display:flex; justify-content:flex-end; margin-bottom:1rem">
                    <button class="btn" id="addUserBtn">Adicionar Usuário</button>
                </div>
                <div class="table-container">
                    <table id="usersTable"><thead><tr><th>Nome</th><th>E-mail</th><th>Tipo</th><th>Vinculado</th><th>Status</th><th>Último Acesso</th><th>Ações</th></tr></thead>
                    <tbody id="usersTableBody"></tbody></table>
                </div>
            </div>

            <div id="reports-tab" class="tab-content">
                <div class="form-container">
                    <div class="form-title">Relatórios e Analytics</div>
                    
                    <!-- Filtros -->
                    <div class="filters" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1.5rem; padding:1.5rem; background:var(--gray-light); border-radius:8px;">
                        <div>
                            <label>Período</label>
                            <select id="reportPeriod" class="form-control">
                                <option value="all">Todo o período</option>
                                <option value="30">Últimos 30 dias</option>
                                <option value="90">Últimos 3 meses</option>
                                <option value="365">Último ano</option>
                            </select>
                        </div>
                        <div>
                            <label>Advogado</label>
                            <select id="reportLawyer" class="form-control">
                                <option value="all">Todos</option>
                                <option value="Dr. Lukas Medeiros">Dr. Lukas Medeiros</option>
                                <option value="Dra. Losainny Silva">Dra. Losainny Silva</option>
                                <option value="Taiza Barros">Taiza Barros</option>
                                <option value="Marvilei Soares">Marvilei Soares</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: flex-end;">
                            <button class="btn" id="generateReport">Gerar Relatório</button>
                        </div>
                    </div>
                    
                    <!-- Gráficos -->
                    <div class="charts-container">
                        <div class="chart-card">
                            <h4>Processos por Status</h4>
                            <div class="chart-placeholder" id="statusChart">
                                Gráfico será gerado aqui
                            </div>
                        </div>
                        <div class="chart-card">
                            <h4>Processos por Advogado</h4>
                            <div class="chart-placeholder" id="lawyerChart">
                                Gráfico será gerado aqui
                            </div>
                        </div>
                    </div>
                    
                    <!-- Estatísticas -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalProcesses">0</div>
                            <div class="stat-label">Total de Processos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="activeClients">0</div>
                            <div class="stat-label">Clientes Ativos</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="processesInProgress">0</div>
                            <div class="stat-label">Processos em Andamento</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="totalRevenue">R$ 0</div>
                            <div class="stat-label">Receita Total</div>
                        </div>
                    </div>
                    
                    <!-- Tabela de Processos -->
                    <div class="table-container">
                        <table>
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Tipo</th>
                                    <th>Status</th>
                                    <th>Honorários</th>
                                    <th>Custos</th>
                                    <th>Saldo</th>
                                </tr>
                            </thead>
                            <tbody id="reportProcessesBody">
                                <!-- Dados carregados dinamicamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="export-options" style="display:flex; gap:1rem; margin-top:1.5rem; justify-content:flex-end;">
                        <button class="btn" onclick="exportToPDF()">Exportar PDF</button>
                        <button class="btn" onclick="exportToExcel()">Exportar Excel</button>
                    </div>

                    <!-- Backup Section -->
                    <div class="backup-section">
                        <h3>Backup de Dados</h3>
                        <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                            <button class="btn" onclick="exportBackup()">Exportar Backup</button>
                            <button class="btn" onclick="importBackup()" style="background: var(--primary-dark); color: white;">Importar Backup</button>
                            <input type="file" id="backupFile" accept=".json" style="display: none;">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Client Dashboard -->
        <div id="clientDashboard" class="dashboard-container" style="display:none">
            <div class="dashboard-header"><h1>Área do Cliente</h1><p>Acompanhe seus processos</p></div>

            <div class="tabs">
                <div class="tab active" data-tab="my-processes">Meus Processos</div>
                <div class="tab" data-tab="my-documents">Meus Documentos</div>
                <div class="tab" data-tab="my-profile">Meu Perfil</div>
            </div>

            <div id="my-processes-tab" class="tab-content active">
                <div class="table-container">
                    <table id="clientProcessesTable"><thead><tr><th>Número</th><th>Tipo</th><th>Status</th><th>Data Início</th><th>Advogado</th><th>Ações</th></tr></thead>
                    <tbody id="clientProcessesTableBody"></tbody></table>
                </div>
            </div>

            <div id="my-documents-tab" class="tab-content">
                <div class="table-container">
                    <table id="clientDocumentsTable"><thead><tr><th>Documento</th><th>Processo</th><th>Data</th><th>Tipo</th><th>Ações</th></tr></thead>
                    <tbody id="clientDocumentsTableBody"></tbody></table>
                </div>
            </div>

            <div id="my-profile-tab" class="tab-content">
                <form id="clientProfileForm">
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                        <div><label>Nome</label><input id="clientProfileName" class="form-control" required></div>
                        <div><label>E-mail</label><input id="clientProfileEmail" class="form-control" required></div>
                    </div>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                        <div><label>Telefone</label><input id="clientProfilePhone" class="form-control"></div>
                        <div><label>CPF/CNPJ</label><input id="clientProfileCPF" class="form-control"></div>
                    </div>
                    <div style="margin-top:1rem"><label>Endereço</label><input id="clientProfileAddress" class="form-control"></div>
                    <div style="margin-top:1rem; text-align:right"><button class="btn" type="submit">Atualizar Perfil</button></div>
                </form>
            </div>
        </div>

    </div>

    <!-- Modais: Client / Process / User -->
    <div class="modal" id="clientModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="clientModalTitle">Adicionar Cliente</h2><button class="modal-close" onclick="closeClientModal()">&times;</button></div>
            <form id="clientForm">
                <input type="hidden" id="clientId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div><label>Nome</label><input id="clientName" class="form-control" required></div>
                    <div><label>E-mail</label><input id="clientEmail" class="form-control" required></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div><label>Telefone</label><input id="clientPhone" class="form-control" required></div>
                    <div><label>CPF/CNPJ</label><input id="clientCPF" class="form-control" required></div>
                </div>
                <div style="margin-top:1rem"><label>Endereço</label><input id="clientAddress" class="form-control"></div>
                <div style="margin-top:1rem"><label>Status</label>
                    <select id="clientStatus" class="form-control"><option value="ativo">Ativo</option><option value="inativo">Inativo</option></select>
                </div>
                <div style="margin-top:1rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn" onclick="closeClientModal()" style="background:transparent; border:1px solid var(--primary-dark); color:var(--primary-dark)">Cancelar</button>
                    <button class="btn" type="submit">Salvar Cliente</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="processModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="processModalTitle">Adicionar Processo</h2><button class="modal-close" onclick="closeProcessModal()">&times;</button></div>
            <form id="processForm">
                <input type="hidden" id="processId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div><label>Número do Processo</label><input id="processNumber" class="form-control" required><div style="font-size:.85rem; color:var(--text-medium)">Formato: NNNNNN-DD.AAAA.J.TR.OOOO</div></div>
                    <div><label>Cliente</label><select id="processClient" class="form-control" required><option value="">Selecione um cliente</option></select></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div><label>Tipo</label><select id="processType" class="form-control" required><option value="">Selecione</option><option value="civil">Civil</option><option value="trabalhista">Trabalhista</option><option value="penal">Penal</option><option value="previdenciario">Previdenciário</option><option value="empresarial">Empresarial</option><option value="familia">Família</option></select></div>
                    <div><label>Status</label><select id="processStatus" class="form-control" required><option value="pendente">Pendente</option><option value="andamento">Em Andamento</option><option value="concluido">Concluído</option><option value="arquivado">Arquivado</option></select></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div><label>Advogado</label><select id="processLawyer" class="form-control" required><option value="">Selecione o advogado</option><option value="lucas">Dr. Lukas Medeiros</option><option value="losainny">Dra. Losainny Silva</option><option value="taiza">Taiza Barros</option><option value="marvilei">Marvilei Soares</option></select></div>
                    <div><label>Data de Início</label><input id="processStartDate" class="form-control" type="date" required></div>
                </div>
                <div style="margin-top:1rem">
                    <label>Prazo Final (Opcional)</label>
                    <input id="processDeadline" class="form-control" type="date">
                </div>
                <div style="margin-top:1rem"><label>Descrição</label><textarea id="processDescription" class="form-control" rows="4" required></textarea></div>
                <div style="margin-top:1rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn" onclick="closeProcessModal()" style="background:transparent; border:1px solid var(--primary-dark); color:var(--primary-dark)">Cancelar</button>
                    <button class="btn" type="submit">Salvar Processo</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="userModal">
        <div class="modal-content">
            <div class="modal-header"><h2 id="userModalTitle">Adicionar Usuário</h2><button class="modal-close" onclick="closeUserModal()">&times;</button></div>
            <form id="userForm">
                <input type="hidden" id="userId">
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div><label>Nome</label><input id="userNameInput" class="form-control" required></div>
                    <div><label>E-mail</label><input id="userEmail" class="form-control" required></div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:1rem; margin-top:1rem">
                    <div><label>Senha</label><input id="userPassword" class="form-control" required></div>
                    <div><label>Tipo de Usuário</label><select id="userTypeModal" class="form-control" required><option value="">Selecione</option><option value="admin">Administrador</option><option value="client">Cliente</option></select></div>
                </div>
                <div style="margin-top:1rem; display:grid; grid-template-columns:1fr 1fr; gap:1rem">
                    <div><label>Vincular a Cliente (opcional)</label><select id="userClientSelect" class="form-control"><option value="">Nenhum</option></select></div>
                    <div><label>Status</label><select id="userStatus" class="form-control"><option value="ativo">Ativo</option><option value="inativo">Inativo</option></select></div>
                </div>
                <div style="margin-top:1rem; display:flex; justify-content:flex-end; gap:1rem">
                    <button type="button" class="btn" onclick="closeUserModal()" style="background:transparent; border:1px solid var(--primary-dark); color:var(--primary-dark)">Cancelar</button>
                    <button class="btn" type="submit">Salvar Usuário</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal de detalhes do processo (timeline + finanças) -->
    <div class="modal" id="processDetailsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Detalhes do Processo</h2>
                <button class="modal-close" onclick="closeProcessDetails()">&times;</button>
            </div>
            
            <!-- Tabs dentro do modal -->
            <div class="modal-tabs">
                <div class="modal-tab active" data-tab="timeline">Timeline</div>
                <div class="modal-tab" data-tab="financial">Financeiro</div>
            </div>
            
            <!-- Conteúdo da Timeline -->
            <div id="timeline-tab" class="modal-tab-content active">
                <div id="processDetailsContent"></div>
                <div id="addUpdateContainer" style="margin-top:1.5rem; border-top:1px solid #ccc; padding-top:1rem;"></div>
            </div>
            
            <!-- Conteúdo do Financeiro -->
            <div id="financial-tab" class="modal-tab-content">
                <div id="financialDetailsContent"></div>
                <div id="addFinancialContainer" style="margin-top:1.5rem; border-top:1px solid #ccc; padding-top:1rem;"></div>
            </div>
        </div>
    </div>

    <script>
// Configuração do Supabase
const SUPABASE_URL = 'https://vzwwmiupvfdrmgcmuldf.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ6d3dtaXVwdmZkcm1nY211bGRmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQzNjQ2NzQsImV4cCI6MjA3OTk0MDY3NH0.tsQkCfxcZQmt6fJf6lLBnAdzl4fjQPWPAVmWlMQe1ss';

// Inicializar cliente Supabase
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// --- Variáveis Globais ---
let currentUser = null;
let currentProcessId = null;

// --- Funções para Supabase ---

// Clientes
async function getClients() {
    try {
        const { data, error } = await supabase
            .from('clientes')
            .select('*')
            .order('nome');
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar clientes:', error);
        return [];
    }
}

async function saveClient(client) {
    try {
        if (client.id) {
            const { data, error } = await supabase
                .from('clientes')
                .update(client)
                .eq('id', client.id)
                .select();
            if (error) throw error;
            return data[0];
        } else {
            const { data, error } = await supabase
                .from('clientes')
                .insert([client])
                .select();
            if (error) throw error;
            return data[0];
        }
    } catch (error) {
        console.error('Erro ao salvar cliente:', error);
        return null;
    }
}

async function deleteClient(id) {
    try {
        const { error } = await supabase
            .from('clientes')
            .delete()
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao excluir cliente:', error);
        return false;
    }
}

// Processos
async function getProcesses() {
    try {
        const { data, error } = await supabase
            .from('processos')
            .select(`
                *,
                clientes (nome, email),
                advogados (nome)
            `)
            .order('data_abertura', { ascending: false });
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar processos:', error);
        return [];
    }
}

async function saveProcess(process) {
    try {
        // Ajustar campos para o formato do Supabase
        const processData = {
            numero_processo: process.number,
            cliente_id: process.clientId,
            tipo_processo: process.type,
            status: process.status,
            descricao: process.description,
            advogado_id: process.lawyer,
            data_abertura: process.startDate,
            prazo_final: process.deadline
        };

        if (process.id) {
            const { data, error } = await supabase
                .from('processos')
                .update(processData)
                .eq('id', process.id)
                .select();
            if (error) throw error;
            return data[0];
        } else {
            const { data, error } = await supabase
                .from('processos')
                .insert([processData])
                .select();
            if (error) throw error;
            return data[0];
        }
    } catch (error) {
        console.error('Erro ao salvar processo:', error);
        return null;
    }
}

async function deleteProcess(id) {
    try {
        const { error } = await supabase
            .from('processos')
            .delete()
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao excluir processo:', error);
        return false;
    }
}

// Usuários
async function getUsers() {
    try {
        const { data, error } = await supabase
            .from('usuarios')
            .select('*, clientes(nome)')
            .order('nome');
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar usuários:', error);
        return [];
    }
}

async function saveUser(user) {
    try {
        const userData = {
            nome: user.name,
            email: user.email,
            senha: user.password,
            tipo_usuario: user.type,
            status: user.status,
            cliente_id: user.clientId || null
        };

        if (user.id) {
            const { data, error } = await supabase
                .from('usuarios')
                .update(userData)
                .eq('id', user.id)
                .select();
            if (error) throw error;
            return data[0];
        } else {
            const { data, error } = await supabase
                .from('usuarios')
                .insert([userData])
                .select();
            if (error) throw error;
            return data[0];
        }
    } catch (error) {
        console.error('Erro ao salvar usuário:', error);
        return null;
    }
}

async function deleteUser(id) {
    try {
        const { error } = await supabase
            .from('usuarios')
            .delete()
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao excluir usuário:', error);
        return false;
    }
}

// Financeiro
async function getFinancials() {
    try {
        const { data, error } = await supabase
            .from('financeiro')
            .select('*')
            .order('data');
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar dados financeiros:', error);
        return [];
    }
}

async function saveFinancial(financial) {
    try {
        const financialData = {
            processo_id: financial.processId,
            tipo: financial.type,
            descricao: financial.description,
            valor: financial.value,
            data: financial.date,
            status: financial.status
        };

        if (financial.id) {
            const { data, error } = await supabase
                .from('financeiro')
                .update(financialData)
                .eq('id', financial.id)
                .select();
            if (error) throw error;
            return data[0];
        } else {
            const { data, error } = await supabase
                .from('financeiro')
                .insert([financialData])
                .select();
            if (error) throw error;
            return data[0];
        }
    } catch (error) {
        console.error('Erro ao salvar dado financeiro:', error);
        return null;
    }
}

async function deleteFinancial(id) {
    try {
        const { error } = await supabase
            .from('financeiro')
            .delete()
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao excluir dado financeiro:', error);
        return false;
    }
}

// Notificações
async function getNotifications() {
    if (!currentUser) return [];
    try {
        const { data, error } = await supabase
            .from('notificacoes')
            .select('*')
            .eq('usuario_id', currentUser.id)
            .order('created_at', { ascending: false });
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar notificações:', error);
        return [];
    }
}

async function saveNotification(notification) {
    try {
        const { data, error } = await supabase
            .from('notificacoes')
            .insert([notification])
            .select();
        if (error) throw error;
        return data[0];
    } catch (error) {
        console.error('Erro ao salvar notificação:', error);
        return null;
    }
}

async function markNotificationAsRead(id) {
    try {
        const { error } = await supabase
            .from('notificacoes')
            .update({ lida: true })
            .eq('id', id);
        return !error;
    } catch (error) {
        console.error('Erro ao marcar notificação como lida:', error);
        return false;
    }
}

// Documentos
async function getDocuments() {
    try {
        const { data, error } = await supabase
            .from('documentos')
            .select('*');
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar documentos:', error);
        return [];
    }
}

// Processo Atualizações (Timeline)
async function getProcessUpdates(processId) {
    try {
        const { data, error } = await supabase
            .from('processo_atualizacoes')
            .select('*')
            .eq('processo_id', processId)
            .order('data_atualizacao', { ascending: false });
        if (error) throw error;
        return data || [];
    } catch (error) {
        console.error('Erro ao buscar atualizações do processo:', error);
        return [];
    }
}

async function saveProcessUpdate(update) {
    try {
        const { data, error } = await supabase
            .from('processo_atualizacoes')
            .insert([update])
            .select();
        if (error) throw error;
        return data[0];
    } catch (error) {
        console.error('Erro ao salvar atualização do processo:', error);
        return null;
    }
}

// --- Sistema de Login Atualizado ---
async function handleLogin(e) { 
    e.preventDefault(); 
    const email = document.getElementById('email').value; 
    const password = document.getElementById('password').value; 
    const userType = document.getElementById('userType').value; 
    
    try {
        const { data: users, error } = await supabase
            .from('usuarios')
            .select('*')
            .eq('email', email)
            .eq('senha', password)
            .eq('tipo_usuario', userType === 'admin' ? 'admin' : 'cliente')
            .eq('status', 'ativo');
        
        if (error) throw error;
        
        if (!users || users.length === 0) { 
            alert('Credenciais inválidas ou usuário inativo!'); 
            return;
        }
        
        const user = users[0];
        currentUser = user;
        
        // Atualizar último acesso
        await supabase
            .from('usuarios')
            .update({ ultimo_acesso: new Date().toISOString() })
            .eq('id', user.id);
        
        // REMOVER localStorage - usar apenas currentUser global
        showDashboard(); 
    } catch (error) {
        console.error('Erro no login:', error);
        alert('Erro ao fazer login!');
    }
}

// --- DOM Refs ---
const loginPage = document.getElementById('loginPage'); 
const adminDashboard = document.getElementById('adminDashboard'); 
const clientDashboard = document.getElementById('clientDashboard'); 
const header = document.getElementById('header');
const loginForm = document.getElementById('loginForm'); 
const logoutBtn = document.getElementById('logoutBtn'); 
const userNameDisplay = document.getElementById('userNameDisplay'); 
const userRole = document.getElementById('userRole');
const tabs = document.querySelectorAll('.tab');

// --- Event Listeners Atualizados ---
document.addEventListener('DOMContentLoaded', async ()=>{
    // REMOVER localStorage - verificar se há usuário na sessão atual
    if(currentUser){ 
        showDashboard(); 
    }

    // events
    loginForm.addEventListener('submit', handleLogin); 
    logoutBtn.addEventListener('click', handleLogout);
    document.getElementById('addClientBtn').addEventListener('click', ()=>openClientModal()); 
    document.getElementById('addProcessBtn').addEventListener('click', ()=>openProcessModal()); 
    document.getElementById('addUserBtn').addEventListener('click', ()=>openUserModal());
    document.getElementById('clientForm').addEventListener('submit', handleClientSubmit); 
    document.getElementById('processForm').addEventListener('submit', handleProcessSubmit); 
    document.getElementById('userForm').addEventListener('submit', handleUserSubmit); 
    
    // Verificar se o elemento existe antes de adicionar listener
    const clientProfileForm = document.getElementById('clientProfileForm');
    if(clientProfileForm) {
        clientProfileForm.addEventListener('submit', handleClientProfileSubmit);
    }

    document.getElementById('clientSearch').addEventListener('input', loadClientsTable); 
    document.getElementById('processSearch').addEventListener('input', loadProcessesTable);

    tabs.forEach(tab=>tab.addEventListener('click', ()=>{ 
        switchTab(tab.getAttribute('data-tab')); 
    }));

    // Configurar tabs do modal
    document.querySelectorAll('.modal-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            const tabId = tab.getAttribute('data-tab');
            switchModalTab(tabId);
        });
    });

    // Notificações
    document.getElementById('notificationBtn').addEventListener('click', toggleNotifications);
    
    // Verificar prazos a cada minuto
    setInterval(checkDeadlines, 60000);
    
    // close modals on outside click
    window.addEventListener('click', function(event){ 
        ['clientModal','processModal','userModal','processDetailsModal'].forEach(id=>{ 
            const m=document.getElementById(id); 
            if(event.target===m) {
                if (id === 'processDetailsModal') closeProcessDetails();
                else m.classList.remove('active'); 
            }
        }); 
        
        // Fechar dropdown de notificações ao clicar fora
        if (!event.target.closest('.notifications')) {
            document.getElementById('notificationDropdown').classList.remove('show');
        }
    });

    // Configurar relatórios
    document.getElementById('generateReport').addEventListener('click', generateReports);
    
    // Configurar backup
    document.getElementById('backupFile').addEventListener('change', handleBackupImport);
    
    // initial load for selects
    await populateUserClientSelect();
    
    // Testar conexão
    await testConnection();
});

// --- Funções Principais Atualizadas ---

function handleLogout(){ 
    currentUser=null; 
    // REMOVER localStorage.removeItem('currentUser');
    showLogin(); 
}

function showLogin(){ 
    loginPage.style.display='flex'; 
    adminDashboard.style.display='none'; 
    clientDashboard.style.display='none'; 
    header.style.display='none'; 
    loginForm.reset(); 
}

async function showDashboard(){ 
    loginPage.style.display='none'; 
    header.style.display='block'; 
    userNameDisplay.textContent=currentUser.nome; 
    userRole.textContent = currentUser.tipo_usuario==='admin'?'Administrador':'Cliente'; 
    
    if(currentUser.tipo_usuario==='admin'){ 
        adminDashboard.style.display='block'; 
        clientDashboard.style.display='none'; 
        await loadAdminData(); 
    } else { 
        adminDashboard.style.display='none'; 
        clientDashboard.style.display='block'; 
        await loadClientData(); 
    } 
    await loadNotifications();
    await checkDeadlines();
}

// --- Carregar Dados Atualizado ---
async function loadAdminData(){ 
    await loadClientsTable(); 
    await loadProcessesTable(); 
    await loadUsersTable(); 
}

async function loadClientsTable(){ 
    try {
        const clients = await getClients(); 
        const search = document.getElementById('clientSearch').value.toLowerCase(); 
        const filtered = clients.filter(c=> 
            c.nome.toLowerCase().includes(search) || 
            c.email.toLowerCase().includes(search) || 
            (c.cpf||'').includes(search)
        ); 
        const tbody=document.getElementById('clientsTableBody'); 
        tbody.innerHTML=''; 
        filtered.forEach(client=>{ 
            const tr=document.createElement('tr'); 
            tr.innerHTML = `
                <td>${client.nome}</td>
                <td>${client.email}</td>
                <td>${client.telefone||''}</td>
                <td>${client.cpf||''}</td>
                <td><span class="status-badge ${client.status==='ativo'?'status-andamento':'status-arquivado'}">${client.status==='ativo'?'Ativo':'Inativo'}</span></td>
                <td>
                    <button class="action-btn" onclick="editClient(${client.id})" title="Editar"><i class="fas fa-edit"></i></button>
                    <button class="action-btn btn-danger" onclick="deleteClientConfirm(${client.id})" title="Excluir"><i class="fas fa-trash"></i></button>
                </td>
            `; 
            tbody.appendChild(tr); 
        }); 
        await populateUserClientSelect(); 
    } catch (error) {
        console.error('Erro ao carregar clientes:', error);
        showAlert('Erro ao carregar clientes!', 'error');
    }
}

// CONTINUA... (as demais funções seguem o mesmo padrão de correção)

// --- Adicione esta função para testar a conexão ---
async function testConnection() {
    try {
        const { data, error } = await supabase.from('clientes').select('count');
        if (error) {
            console.error('Erro na conexão:', error);
            showAlert('⚠️ Erro na conexão com o banco de dados.', 'error');
            return false;
        } else {
            console.log('✅ Conexão com Supabase estabelecida!');
            return true;
        }
    } catch (error) {
        console.error('Erro ao testar conexão:', error);
        showAlert('⚠️ Erro na conexão com o banco de dados.', 'error');
        return false;
    }
}

// Função de alerta atualizada
function showAlert(message, type){ 
    const main=document.querySelector('.main-container'); 
    const a=document.createElement('div'); 
    a.className = `alert alert-${type}`; 
    a.style.padding='12px'; 
    a.style.borderRadius='6px'; 
    a.style.marginBottom='12px'; 
    a.textContent = message; 
    main.insertBefore(a, main.firstChild); 
    setTimeout(()=>a.remove(),5000); 
}
    </script>
</body>
</html>